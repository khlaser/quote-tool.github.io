<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KH Laser 报价系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ==================== 核心变量层 ==================== */
        :root {
            --primary-color: #2563eb;
            --secondary-color: #3b82f6;
            --success-color: #10b981;
            --success-dark: #0da271;
            --danger-color: #ef4444;
            --danger-dark: #dc2626;
            --warning-color: #f59e0b;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-900: #111827;
            --font-family: 'Segoe UI', system-ui, sans-serif;
            --body-background: #f9fafb;
            --body-color: var(--gray-900);
            --blue-light-100: #f0f9ff;
            --blue-light-200: #e0f2fe;
            --blue-light-300: #bae6fd;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        /* ==================== 基础样式层 ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
        }
        
        body {
            background-color: var(--body-background);
            color: var(--body-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            min-width: 1200px;
        }
        
        @media (max-width: 1200px) {
            .container {
                min-width: auto;
                padding: 10px;
            }
        }
        
        /* ==================== 布局与通用样式 ==================== */
        .layout-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .layout-col {
            display: flex;
            flex-direction: column;
        }
        
        .layout-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .layout-row {
                flex-direction: column;
            }
            .btn {
                padding: 10px 18px;
            }
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 1.5rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .history-panel-btn {
            background: none;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .history-panel-btn:hover {
            background-color: var(--gray-100);
        }
        
        .settings-btn {
            background: none;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .settings-btn:hover {
            background-color: var(--gray-100);
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 20px;
            min-height: 600px;
        }
        
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
                min-height: auto;
            }
        }
        
        /* ==================== 卡片样式 ==================== */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 18px;
            margin-bottom: 18px;
            transition: box-shadow 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 8px 10px -1px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 12px;
        }
        
        .card-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 16px;
        }
        
        .card-with-border {
            border: 1px solid var(--gray-300);
        }
        
        .card-shadow-light {
            box-shadow: var(--shadow-sm);
        }
        
        .card-shadow-heavy {
            box-shadow: var(--shadow-lg);
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 0.9rem;
        }
        
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.92rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.92rem;
            transition: border-color 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .radio-group, .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.92rem;
        }
        
        .radio-option:hover, .checkbox-option:hover {
            border-color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.05);
        }
        
        .radio-option.selected, .checkbox-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.1);
        }
        
        input[type="radio"], input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .collapse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--gray-100);
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 8px;
            font-size: 0.92rem;
        }
        
        .collapse-content {
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            margin-bottom: 10px;
            display: none;
        }
        
        .collapse-content.expanded {
            display: block;
        }
        
        .price-source {
            display: flex;
            gap: 8px;
        }
        
        .price-source-option {
            padding: 6px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            min-width: 70px;
            text-align: center;
        }
        
        .price-source-option.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* 省份按钮样式 */
        .province-btn {
            background-color: var(--gray-200);
            color: var(--gray-900);
            border: none;
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.85rem;
            transition: none;
        }
        
        /* 省份按钮选中状态 */
        .province-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .quote-result {
            padding: 15px;
            background: linear-gradient(135deg, var(--blue-light-100) 0%, var(--blue-light-200) 100%);
            border-radius: 10px;
            border: 1px solid var(--blue-light-300);
            margin-bottom: 15px;
        }
        
        .price-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: center;
        }
        
        .price-column {
            text-align: center;
        }
        
        .price-label {
            font-size: 0.9rem;
            color: var(--gray-700);
            margin-bottom: 4px;
        }
        
        .usd-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        
        .cny-price {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--gray-700);
            margin: 0;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        /* ==================== 按钮样式 ==================== */
        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 0.85rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary {
            background-color: var(--gray-200);
            color: var(--gray-900);
        }
        
        .btn-secondary:hover {
            background-color: var(--gray-300);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: var(--success-dark);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: var(--danger-dark);
        }
        
        .btn-link {
            background: transparent;
            color: var(--primary-color);
            text-decoration: underline;
        }
        
        .btn-disabled {
            background-color: var(--gray-400);
            color: var(--gray-600);
            cursor: not-allowed;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 22px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        
        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-700);
        }
        
        .tab-container {
            margin-top: 18px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .tab {
            padding: 10px 18px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab-content {
            padding: 18px 0;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .history-item {
            padding: 10px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-item:hover {
            background-color: var(--gray-100);
        }
        
        .history-date {
            font-size: 0.8rem;
            color: var(--gray-700);
        }
        
        .history-total {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .empty-state {
            text-align: center;
            padding: 25px 15px;
            color: var(--gray-700);
        }
        
        .empty-state i {
            font-size: 2.2rem;
            color: var(--gray-300);
            margin-bottom: 10px;
        }
        
        footer {
            text-align: center;
            padding: 15px 0;
            margin-top: 20px;
            border-top: 1px solid var(--gray-200);
            color: var(--gray-700);
            font-size: 0.85rem;
            background: white;
        }

        /* 新增样式 */
        .machine-info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .machine-info-item {
            background: var(--gray-100);
            padding: 8px;
            border-radius: 6px;
        }
        
        .machine-info-label {
            font-size: 0.75rem;
            color: var(--gray-700);
            margin-bottom: 3px;
        }
        
        .machine-info-value {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9rem;
        }
        
        .product-selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 992px) {
            .product-selection-grid {
                grid-template-columns: 1fr;
            }
            
            .machine-info-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .series-selection-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        @media (max-width: 768px) {
            .series-selection-row {
                grid-template-columns: 1fr;
            }
            
            .machine-info-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .machine-info-card {
            background: linear-gradient(135deg, var(--blue-light-100) 0%, var(--blue-light-200) 100%);
            border: 1px solid var(--blue-light-300);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .machine-info-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--primary-color);
            font-size: 0.9rem;
        }
        
        .price-display-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: var(--gray-100);
            border-radius: 8px;
        }
        
        .price-display-label {
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.85rem;
        }
        
        .price-display-value {
            font-weight: 600;
            font-size: 1rem;
            color: var(--primary-color);
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        /* 汇率和价格来源同行 */
        .rate-price-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            max-width: 100%;
        }
        
        @media (max-width: 768px) {
            .rate-price-row {
                grid-template-columns: 1fr;
            }
        }
        
        .rate-card, .price-source-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 15px;
            width: 100%;
        }
        
        .compact-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 12px;
        }
        
        /* 产品价格显示优化 */
        .product-price-display {
            font-size: 0.8rem;
            color: var(--primary-color);
            font-weight: 600;
            margin-left: 5px;
        }
        
        /* 历史记录区域优化 */
        .history-card {
            height: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            max-height: 220px;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--gray-900);
            padding-bottom: 6px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .settings-section {
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .settings-section-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--gray-900);
        }
        
        .template-list-item {
            padding: 8px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .template-list-item:hover {
            background-color: var(--gray-100);
        }
        
        .template-actions {
            display: flex;
            gap: 5px;
        }
        
        .product-data-editor-form {
            background-color: var(--gray-100);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .product-list-table {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 12px;
        }
        
        .backup-info {
            background-color: var(--gray-100);
            padding: 10px;
            border-radius: 8px;
            margin-top: 12px;
        }
        
        .backup-info-item {
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }
        
        .backup-info-label {
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .backup-info-value {
            color: var(--primary-color);
            font-size: 0.85rem;
        }
        
        .alert {
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .alert-success {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success-color);
        }
        
        .alert-warning {
            background-color: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning-color);
        }
        
        .alert-danger {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger-color);
        }
        
        /* 紧凑表格样式 */
        .compact-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        
        .compact-table th, .compact-table td {
            border: 1px solid var(--gray-300);
            padding: 5px 6px;
            text-align: left;
        }
        
        .compact-table th {
            background-color: var(--gray-100);
            font-weight: 600;
        }
        
        /* 导入数据统计 */
        .import-stats {
            background: var(--gray-100);
            padding: 8px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.85rem;
        }
        
        .import-stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .import-stats-label {
            font-weight: 500;
        }
        
        .import-stats-value {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* 优化配件选择区域样式 */
        .checkbox-label-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        
        .accessory-price {
            font-weight: 600;
            color: var(--primary-color);
            margin-left: auto;
        }
        
        /* 通知样式 */
        .notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid var(--primary-color);
        }
        
        .notification-success {
            border-left-color: var(--success-color);
        }
        
        .notification-warning {
            border-left-color: var(--warning-color);
        }
        
        .notification-danger {
            border-left-color: var(--danger-color);
        }
        
        .notification-icon {
            font-size: 1.2rem;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }
        
        .notification-message {
            font-size: 0.85rem;
            color: var(--gray-700);
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: var(--gray-500);
            padding: 4px;
            border-radius: 4px;
        }
        
        .notification-close:hover {
            background-color: var(--gray-100);
            color: var(--gray-700);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        /* 模板选择区域样式 */
        .template-selection-container {
            margin-bottom: 15px;
        }
        
        .selected-template-info {
            background-color: var(--gray-100);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid var(--primary-color);
        }
        
        .selected-template-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .selected-template-content {
            font-size: 0.85rem;
            color: var(--gray-700);
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .no-template-selected {
            color: var(--gray-500);
            font-style: italic;
            font-size: 0.9rem;
        }
        
        /* 模板选择模态框样式 */
        .template-preview {
            background-color: var(--gray-100);
            padding: 10px;
            border-radius: 6px;
            margin-top: 8px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.85rem;
            white-space: pre-wrap;
            border: 1px solid var(--gray-200);
        }
        
        .template-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--gray-600);
            margin-top: 5px;
        }
        
        .template-select-btn {
            margin-top: 10px;
        }
        
        /* 新增：加载中样式 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--gray-200);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 错误提示样式 */
        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            margin-bottom: 10px;
            font-size: 0.85rem;
        }
        
        /* 历史记录操作按钮样式 */
        .history-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
            gap: 8px;
        }
        
        .history-item.selected {
            border-color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.05);
        }

        /* ========== 新增：其他配件区域增强样式 ========== */
        
        /* 其他配件搜索框 */
        .other-accessories-search {
            margin-bottom: 12px;
            position: relative;
        }
        
        .other-accessories-search input {
            padding-left: 36px;
            padding-right: 36px;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
        }
        
        .clear-search {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            display: none;
        }
        
        .clear-search:hover {
            color: var(--danger-color);
        }
        
        /* 多列布局 */
        .other-accessories-multi-column {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        @media (max-width: 1200px) {
            .other-accessories-multi-column {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .other-accessories-multi-column {
                grid-template-columns: 1fr;
            }
        }
        
        /* 已选配件分组样式 */
        .selected-group-title {
            font-weight: 600;
            color: var(--primary-color);
            margin: 12px 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .selected-group-title i {
            font-size: 0.8rem;
        }
        
        .unselected-group-title {
            font-weight: 600;
            color: var(--gray-700);
            margin: 12px 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .unselected-group-title i {
            font-size: 0.8rem;
        }
        
        /* 搜索结果提示 */
        .search-result-info {
            font-size: 0.8rem;
            color: var(--gray-600);
            margin-bottom: 8px;
            text-align: center;
            padding: 4px;
            background-color: var(--gray-100);
            border-radius: 4px;
        }
        
        /* 无结果提示 */
        .no-search-results {
            text-align: center;
            padding: 20px;
            color: var(--gray-500);
            font-style: italic;
        }
        
        .no-search-results i {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: block;
        }
        
        /* ========== 新增：费用明细展示样式 ========== */
        .price-details-container {
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .price-details-group {
            background: var(--gray-100);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .price-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.85rem;
        }
        
        .price-row:last-child {
            border-bottom: none;
        }
        
        .price-detail-label {
            color: var(--gray-700);
        }
        
        .price-detail-value {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .price-total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-top: 2px solid var(--gray-300);
            margin-top: 8px;
            font-size: 1rem;
            grid-column: 1 / -1;
        }
        
        .price-total-label {
            font-weight: 700;
            color: var(--gray-900);
        }
        
        .price-total-value {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        
        .total-highlight {
            font-weight: normal;
        }
        
        .total-highlight .price-detail-label {
            font-weight: 500;
            color: var(--gray-700);
        }
        
        .total-highlight .price-detail-value {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* ========== 新增：历史记录浮动面板样式 ========== */
        .history-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100%;
            background: white;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .history-panel.active {
            transform: translateX(0);
        }
        
        .history-panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .close-history-panel {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-700);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .close-history-panel:hover {
            background-color: var(--gray-100);
        }
        
        .history-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .history-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }
        
        .history-panel-overlay.active {
            display: block;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .history-panel {
                width: 100%;
            }
        }
        
        /* ========== 新增：费用与数量设置区域样式 ========== */
        .quantity-fees-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 18px;
            margin-bottom: 18px;
        }
        
        .quantity-fees-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 1024px) {
            .quantity-fees-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .quantity-fees-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .quantity-fees-group {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <!-- 加载中遮罩 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <!-- 历史记录面板遮罩 -->
    <div class="history-panel-overlay" id="historyPanelOverlay"></div>
    
    <!-- 历史记录浮动面板 -->
    <div class="history-panel" id="historyPanel">
        <div class="history-panel-header">
            <h2 class="history-panel-title">
                <i class="fas fa-history"></i>
                历史报价记录
            </h2>
            <button class="close-history-panel" id="closeHistoryPanel">&times;</button>
        </div>
        
        <div class="history-panel-content">
            <!-- 历史记录操作按钮 -->
            <div class="history-actions">
                <button class="btn btn-secondary btn-sm" id="clearHistoryBtn">
                    <i class="fas fa-trash"></i>
                    清除历史
                </button>
            </div>
            
            <div id="historyList" class="history-list">
                <div class="empty-state">
                    <i class="fas fa-clock"></i>
                    <p>暂无历史报价记录</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="content-wrapper">
        <div class="container">
            <header>
                <div class="logo">
                    <i class="fas fa-laser"></i>
                    <span>KH Laser 报价系统</span>
                </div>
                <div class="header-actions">
                    <button class="history-panel-btn" id="openHistoryPanel">
                        <i class="fas fa-history"></i>
                        <span>历史记录</span>
                    </button>
                    <button class="settings-btn" id="openSettings">
                        <i class="fas fa-cog"></i>
                        <span>系统设置</span>
                    </button>
                </div>
            </header>
            
            <div class="main-layout">
                <div class="left-column">
                    <!-- 产品配置 -->
                    <div class="card">
                        <!-- 汇率和价格来源在同一行 -->
                        <div class="rate-price-row">
                            <div class="rate-card">
                                <h2 class="card-title">
                                    <i class="fas fa-exchange-alt"></i>
                                    汇率设置 (1 USD = ? CNY)
                                </h2>
                                <div class="form-group">
                                    <input type="number" id="exchangeRate" step="0.01" min="0" value="6.66">
                                </div>
                            </div>
                            
                            <div class="price-source-card">
                                <h2 class="card-title">
                                    <i class="fas fa-tags"></i>
                                    价格来源
                                </h2>
                                <div class="price-source">
                                    <div class="price-source-option active" data-source="tier1">阶梯一</div>
                                    <div class="price-source-option" data-source="tier2">阶梯二</div>
                                    <div class="price-source-option" data-source="tier3">阶梯三</div>
                                </div>
                            </div>
                        </div>
                        
                        <h2 class="card-title">
                            <i class="fas fa-cogs"></i>
                            产品配置
                        </h2>
                        
                        <!-- 机器选择 -->
                        <div class="form-group">
                            <label>机器选择</label>
                            <div class="series-selection-row">
                                <div>
                                    <label>系列</label>
                                    <select id="seriesSelect">
                                        <option value="">请选择系列</option>
                                    </select>
                                </div>
                                <div>
                                    <label>型号</label>
                                    <select id="modelSelect" disabled>
                                        <option value="">请先选择系列</option>
                                    </select>
                                </div>
                                <div>
                                    <label>功率</label>
                                    <select id="powerSelect" disabled>
                                        <option value="">请先选择型号</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- 机器信息显示 -->
                            <div id="machineInfoDisplay" class="machine-info-card" style="display: none;">
                                <div class="machine-info-title">
                                    <i class="fas fa-info-circle"></i> 机器信息
                                </div>
                                <div class="machine-info-grid">
                                    <div class="machine-info-item">
                                        <div class="machine-info-label">打包尺寸 (cm)</div>
                                        <div class="machine-info-value" id="packingSize">-</div>
                                    </div>
                                    <div class="machine-info-item">
                                        <div class="machine-info-label">CBM</div>
                                        <div class="machine-info-value" id="cbmValue">-</div>
                                    </div>
                                    <div class="machine-info-item">
                                        <div class="machine-info-label">体积重 (kg)</div>
                                        <div class="machine-info-value" id="volumeWeight">-</div>
                                    </div>
                                    <div class="machine-info-item">
                                        <div class="machine-info-label">实重 (kg)</div>
                                        <div class="machine-info-value" id="actualWeight">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 产品选择（水冷机和配件并排） -->
                        <div class="product-selection-grid">
                            <!-- 水冷机选择 -->
                            <div class="form-group">
                                <label>水冷机选择</label>
                                <div class="radio-group" id="waterCoolerOptions">
                                    <!-- 选项将通过JS动态生成 -->
                                </div>
                            </div>
                            
                            <!-- 配件选择 -->
                            <div class="form-group">
                                <label>配件选择</label>
                                <div class="checkbox-group" id="accessoryOptions">
                                    <!-- 选项将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 其他配件折叠框 -->
                        <div class="form-group">
                            <div class="collapse-header" id="otherAccessoriesToggle">
                                <span>其他配件</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="collapse-content" id="otherAccessoriesContent">
                                <!-- 搜索框 -->
                                <div class="other-accessories-search">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" id="otherAccessoriesSearch" placeholder="搜索配件名称..." autocomplete="off">
                                    <button class="clear-search" id="clearSearchBtn" title="清空搜索">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                
                                <!-- 其他配件选项 -->
                                <div class="checkbox-group" id="otherAccessoryOptions">
                                    <!-- 选项将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="right-column">
                    <!-- 数量与费用设置（移动到原历史记录位置） -->
                    <div class="quantity-fees-card">
                        <h2 class="card-title">
                            <i class="fas fa-calculator"></i>
                            数量与费用设置
                        </h2>
                        
                        <div class="quantity-fees-grid">
                            <div class="quantity-fees-group">
                                <label for="quantity" style="margin-bottom: 6px; font-weight: 500; font-size: 0.92rem;">数量</label>
                                <input type="number" id="quantity" min="1" value="1" style="width: 100%;">
                            </div>
                            
                            <div class="quantity-fees-group">
                                <label for="internationalShipping" style="margin-bottom: 6px; font-weight: 500; font-size: 0.92rem;">国际运费 (CNY)</label>
                                <input type="number" id="internationalShipping" step="0.01" min="0" value="0" style="width: 100%;">
                            </div>
                            
                            <div class="quantity-fees-group">
                                <label for="domesticShipping" style="margin-bottom: 6px; font-weight: 500; font-size: 0.92rem;">国内运费 (CNY)</label>
                                <input type="number" id="domesticShipping" step="0.01" min="0" value="0" style="width: 100%;">
                            </div>
                            
                            <div class="quantity-fees-group">
                                <label for="otherFees" style="margin-bottom: 6px; font-weight: 500; font-size: 0.92rem;">其他费用 (CNY)</label>
                                <input type="number" id="otherFees" step="0.01" min="0" value="0" style="width: 100%;">
                            </div>
                            
                            <div class="quantity-fees-group">
                                <label for="country" style="margin-bottom: 6px; font-weight: 500; font-size: 0.92rem;">国家</label>
                                <select id="country" style="width: 100%;">
                                    <option value="US">美国</option>
                                    <option value="CN">中国</option>
                                    <option value="DE">德国</option>
                                    <option value="JP">日本</option>
                                    <option value="other">其他</option>
                                </select>
                            </div>
                            
                            <div class="quantity-fees-group">
                                <label for="zipCode" style="margin-bottom: 6px; font-weight: 500; font-size: 0.92rem;">邮编</label>
                                <input type="text" id="zipCode" placeholder="请输入邮编" style="width: 100%;">
                            </div>
                        </div>
                        
                        <!-- 省份选择区域 -->
                        <div style="margin-top: 15px;">
                            <label style="font-weight: 500; font-size: 0.92rem; margin-bottom: 8px; display: block;">省份选择</label>
                            <div class="layout-row" style="margin-bottom: 8px;">
                                <button class="btn province-btn" data-province="青岛">青岛</button>
                                <button class="btn province-btn" data-province="浙江">浙江</button>
                                <button class="btn province-btn" data-province="广东">广东</button>
                            </div>
                            <select id="provinceSelect" style="width: 100%;">
                                <option value="">请选择其他省份</option>
                                <option value="北京">北京</option>
                                <option value="上海">上海</option>
                                <option value="江苏">江苏</option>
                                <option value="山东">山东</option>
                                <option value="天津">天津</option>
                                <option value="河北">河北</option>
                                <option value="山西">山西</option>
                                <option value="内蒙古">内蒙古</option>
                                <option value="辽宁">辽宁</option>
                                <option value="吉林">吉林</option>
                                <option value="黑龙江">黑龙江</option>
                                <option value="安徽">安徽</option>
                                <option value="福建">福建</option>
                                <option value="江西">江西</option>
                                <option value="河南">河南</option>
                                <option value="湖北">湖北</option>
                                <option value="湖南">湖南</option>
                                <option value="广西">广西</option>
                                <option value="海南">海南</option>
                                <option value="重庆">重庆</option>
                                <option value="四川">四川</option>
                                <option value="贵州">贵州</option>
                                <option value="云南">云南</option>
                                <option value="西藏">西藏</option>
                                <option value="陕西">陕西</option>
                                <option value="甘肃">甘肃</option>
                                <option value="青海">青海</option>
                                <option value="宁夏">宁夏</option>

                            </select>
                            <input type="hidden" id="provinceValue" value="">
                        </div>
                    </div>
                    
                    <!-- 最终报价 -->
                    <div class="card">
                        <h2 class="card-title">
                            <i class="fas fa-file-invoice-dollar"></i>
                            最终报价
                        </h2>
                        
                        <div class="quote-result">
                            <div class="price-grid">
                                <div class="price-column">
                                    <div class="price-label">人民币报价 (CNY)</div>
                                    <div class="cny-price" id="cnyPrice">¥0.00</div>
                                </div>
                                <div class="price-column">
                                    <div class="price-label">美元报价 (USD)</div>
                                    <div class="usd-price" id="usdPrice">$0.00</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 费用明细展示 -->
                        <div class="price-details-container">

                            
                            <div class="price-details-group">
                                <div class="price-details-grid">
                                    <div class="price-row">
                                        <span class="price-detail-label">机器价格:</span>
                                        <span class="price-detail-value" id="priceDetailMachine">¥0</span>
                                    </div>
                                    <div class="price-row">
                                        <span class="price-detail-label">水冷机:</span>
                                        <span class="price-detail-value" id="priceDetailWaterCooler">¥0</span>
                                    </div>
                                    <div class="price-row">
                                        <span class="price-detail-label">配件价格:</span>
                                        <span class="price-detail-value" id="priceDetailAccessories">¥0</span>
                                    </div>
                                    <div class="price-row">
                                        <span class="price-detail-label">其他配件:</span>
                                        <span class="price-detail-value" id="priceDetailOtherAccessories">¥0</span>
                                    </div>
                                    <div class="price-row">
                                        <span class="price-detail-label">国际运费:</span>
                                        <span class="price-detail-value" id="priceDetailInternationalShipping">¥0</span>
                                    </div>
                                    <div class="price-row">
                                        <span class="price-detail-label">国内运费:</span>
                                        <span class="price-detail-value" id="priceDetailDomesticShipping">¥0</span>
                                    </div>
                                    <div class="price-row">
                                        <span class="price-detail-label">其他费用:</span>
                                        <span class="price-detail-value" id="priceDetailOtherFees">¥0</span>
                                    </div>
                                    <div class="price-row total-highlight">
                                        <span class="price-detail-label">总计:</span>
                                        <span class="price-detail-value" id="priceDetailTotal">¥0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 模板选择区域 -->
                        <div class="template-selection-container">
                            <label>报价模板</label>
                            <div id="selectedTemplateInfo" class="selected-template-info" style="display: none;">
                                <div class="selected-template-title">已选模板: <span id="selectedTemplateName">未选择</span></div>
                                <div class="selected-template-content" id="selectedTemplateContent">
                                    <!-- 模板内容将在这里显示 -->
                                </div>
                            </div>
                            <div id="noTemplateSelected" class="no-template-selected">
                                未选择模板，请选择模板后复制报价
                            </div>
                        </div>
                        
                        <div class="quick-actions">
                            <button class="btn btn-primary" id="selectTemplateBtn">
                                <i class="fas fa-file-alt"></i>
                                选择模板
                            </button>
                            <button class="btn btn-success" id="copyQuote">
                                <i class="fas fa-copy"></i>
                                复制报价
                            </button>
                            <button class="btn btn-secondary" id="loadLastQuote">
                                <i class="fas fa-history"></i>
                                加载上次
                            </button>
                            <button class="btn btn-danger" id="resetCalculation">
                                <i class="fas fa-redo"></i>
                                重置
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 系统设置模态框 -->
            <div class="modal" id="settingsModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">
                            <i class="fas fa-sliders-h"></i>
                            系统设置
                        </h2>
                        <button class="close-modal" id="closeSettings">&times;</button>
                    </div>
                    
                    <div class="tab-container">
                        <div class="tabs">
                            <div class="tab active" data-tab="product">产品数据管理</div>
                            <div class="tab" data-tab="template">模板管理</div>
                            <div class="tab" data-tab="backup">数据安全管理</div>
                        </div>
                        
                        <!-- 产品数据管理 -->
                        <div class="tab-content active" id="productTab">
                            <div class="settings-section">
                                <div class="settings-section-title">产品数据编辑</div>
                                <button class="btn btn-primary" id="editProductData" style="width: 100%; margin-bottom: 10px;">
                                    <i class="fas fa-edit"></i> 编辑产品和配件数据
                                </button>
                                
                                <div id="productDataEditor" style="display: none; margin-top: 18px;">
                                    <div class="product-data-editor-form">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>产品类型</label>
                                                <select id="productType">
                                                    <option value="waterCooler">水冷机</option>
                                                    <option value="accessory">配件</option>
                                                    <option value="otherAccessory">其他配件</option>
                                                </select>
                                            </div>
                                            
                                            <div class="form-group">
                                                <label>产品名称</label>
                                <input type="text" id="productName" placeholder="请输入产品名称">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>产品型号</label>
                                <input type="text" id="productModel" placeholder="请输入产品型号">
                            </div>
                            
                            <div class="form-group">
                                <label>阶梯一价格 (CNY)</label>
                                <input type="number" id="productPrice" step="0.01" min="0" placeholder="请输入价格">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>阶梯二价格 (CNY)</label>
                                <input type="number" id="productPriceTier2" step="0.01" min="0" placeholder="请输入阶梯二价格">
                            </div>
                            
                            <div class="form-group">
                                <label>阶梯三价格 (CNY)</label>
                                <input type="number" id="productPriceTier3" step="0.01" min="0" placeholder="请输入阶梯三价格">
                            </div>
                        </div>
                        
                        <div class="form-group" style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-success" id="saveProductData">保存</button>
                            <button class="btn btn-danger" id="deleteProductData">删除</button>
                            <button class="btn btn-secondary" id="clearProductForm">清空</button>
                        </div>
                    </div>
                    
                    <div id="productDataTable" class="product-list-table"></div>
                </div>
            </div>
            <!-- 已删除 Excel/CSV 导入导出部分 -->
        </div>
        
        <!-- 模板管理 -->
        <div class="tab-content" id="templateTab">
            <div class="settings-section">
                <div class="settings-section-title">报价单模板管理</div>
                <button class="btn btn-primary" id="manageTemplates" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-folder"></i> 管理报价单模板
                </button>
                
                <div id="templateEditor" style="display: none; margin-top: 18px;">
                    <div class="product-data-editor-form">
                        <div class="form-group">
                            <label>模板名称</label>
                            <input type="text" id="templateName" placeholder="请输入模板名称">
                        </div>
                        
                        <div class="form-group">
                            <label>模板内容</label>
                            <textarea id="templateContent" rows="6" placeholder="请输入模板内容..."></textarea>
                        </div>
                        
                        <div class="form-group" style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-success" id="saveTemplate">保存</button>
                            <button class="btn btn-danger" id="deleteTemplate">删除</button>
                            <button class="btn btn-secondary" id="clearTemplateForm">清空</button>
                        </div>
                    </div>
                    
                    <div id="templateList" class="product-list-table"></div>
                </div>
            </div>
        </div>
        
        <!-- 数据安全管理 -->
        <div class="tab-content" id="backupTab">
            <!-- 恢复默认产品数据 -->
            <div class="settings-section">
                <div class="settings-section-title">恢复默认产品数据</div>
                <button class="btn btn-danger" id="resetToDefault" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-database"></i> 恢复默认产品数据
                </button>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>警告：</strong>此操作将恢复为系统内置的机器和配件数据，但会保留：
                    <ul style="margin: 8px 0 0 20px; font-size: 0.9rem;">
                        <li>当前汇率设置</li>
                        <li>自定义模板</li>
                        <li>历史报价记录</li>
                        <li>系统设置</li>
                    </ul>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">数据备份</div>
                <button class="btn btn-primary" id="backupData" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-box"></i> 备份所有数据
                </button>
                
                <div class="backup-info">
                    <div class="backup-info-item">
                        <span class="backup-info-label">备份内容：</span>
                        <span class="backup-info-value">产品数据、机器数据、模板、历史记录</span>
                    </div>
                    <div class="backup-info-item">
                        <span class="backup-info-label">备份格式：</span>
                        <span class="backup-info-value">JSON</span>
                    </div>
                    <div class="backup-info-item">
                        <span class="backup-info-label">备份时间：</span>
                        <span class="backup-info-value" id="lastBackupTime">-</span>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">数据恢复</div>
                <button class="btn btn-secondary" id="restoreData" style="width: 100%; margin-bottom: 8px;">
                    <i class="fas fa-file-import"></i> 恢复数据
                </button>
                <input type="file" id="backupFileInput" accept=".json" style="display: none;">
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">数据统计</div>
                <div class="backup-info">
                    <div class="backup-info-item">
                        <span class="backup-info-label">机器数据：</span>
                        <span class="backup-info-value" id="machineDataCount">0 条</span>
                    </div>
                    <div class="backup-info-item">
                        <span class="backup-info-label">产品数据：</span>
                        <span class="backup-info-value" id="productDataCount">0 条</span>
                    </div>
                    <div class="backup-info-item">
                        <span class="backup-info-label">模板数据：</span>
                        <span class="backup-info-value" id="templateDataCount">0 条</span>
                    </div>
                    <div class="backup-info-item">
                        <span class="backup-info-label">历史记录：</span>
                        <span class="backup-info-value" id="historyDataCount">0 条</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

            <!-- 模板选择模态框 -->
            <div class="modal" id="templateSelectModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">
                            <i class="fas fa-file-alt"></i>
                            选择报价模板
                        </h2>
                        <button class="close-modal" id="closeTemplateSelect">&times;</button>
                    </div>
                    
                    <div class="tab-container">
                        <div id="templateSelectList" class="product-list-table">
                            <!-- 模板列表将动态加载 -->
                        </div>
                        
                        <div class="alert alert-info" style="margin-top: 15px;">
                            <i class="fas fa-info-circle"></i>
                            选择模板后，系统会自动填充当前报价信息到模板中，然后可以点击"复制报价"按钮复制完整的报价单。
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2026 KH Laser 报价系统 | 版本 2.7.7</p>
        </footer>
    </div>

    <!-- 通知容器 -->
    <div class="notification-container" id="notificationContainer"></div>

    <script>
        // 调试开关常量
        const DEBUG = false;
        
        // ==================== 工具函数模块开始 ====================
        const Utils = {
            // 解析数字
            parseNumber(value) {
                try {
                    if (!value || value === '') return 0;
                    const cleaned = value.toString().replace(/[^0-9.-]+/g, '');
                    const num = parseFloat(cleaned);
                    return isNaN(num) ? 0 : num;
                } catch (error) {
                    console.error('解析数字失败:', error);
                    return 0;
                }
            },
            
            // 清理字段
            cleanField(field) {
                try {
                    return field.trim().replace(/^"|\"$/g, '').trim();
                } catch (error) {
                    console.error('清理字段失败:', error);
                    return field || '';
                }
            },
            
            // 从功率字符串中提取数字
            extractNumberFromPowerString(str) {
                try {
                    const match = str.match(/(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                } catch (error) {
                    console.error('提取功率数字失败:', error);
                    return 0;
                }
            },
            
            // 获取默认价格结果
            getDefaultPriceResult() {
                return {
                    totalCNY: CalculationEngine.formatPrice(0),
                    totalUSD: CalculationEngine.formatPrice(0),
                    rawCNY: 0,
                    rawUSD: 0,
                    machinePrice: CalculationEngine.formatPrice(0),
                    waterCoolerPrice: CalculationEngine.formatPrice(0),
                    accessoriesPrice: CalculationEngine.formatPrice(0),
                    otherFeesPrice: CalculationEngine.formatPrice(0),
                    shippingTotal: CalculationEngine.formatPrice(0),
                    details: {
                        machinePrice: 0,
                        waterCoolerPrice: 0,
                        accessoriesPrice: 0,
                        otherFeesPrice: 0,
                        shippingTotal: 0
                    }
                };
            }
        };
        // ==================== 工具函数模块结束 ====================
        
        // ==================== 内置数据区域开始 ====================
        // 国内运费规则数据结构
        const DOMESTIC_SHIPPING_RULES = {
            '青岛': {
                // 青岛的规则单独定义
                specialRule: true
            },
            '山东': {
                firstWeightPrice: 25,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 25 },
                    { min: 0.11, max: 0.5, price: 200 },
                    { min: 0.51, max: 1.5, price: 190 },
                    { min: 1.51, max: 4, price: 180 },
                    { min: 4.01, max: Infinity, price: 160 }
                ]
            },
            '江苏': {
                firstWeightPrice: 30,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 30 },
                    { min: 0.11, max: 0.5, price: 240 },
                    { min: 0.51, max: 1.5, price: 220 },
                    { min: 1.51, max: 4, price: 210 },
                    { min: 4.01, max: Infinity, price: 180 }
                ]
            },
            '浙江': {
                firstWeightPrice: 30,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 30 },
                    { min: 0.11, max: 0.5, price: 240 },
                    { min: 0.51, max: 1.5, price: 220 },
                    { min: 1.51, max: 4, price: 210 },
                    { min: 4.01, max: Infinity, price: 180 }
                ]
            },
            '上海': {
                firstWeightPrice: 30,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 30 },
                    { min: 0.11, max: 0.5, price: 240 },
                    { min: 0.51, max: 1.5, price: 220 },
                    { min: 1.51, max: 4, price: 210 },
                    { min: 4.01, max: Infinity, price: 180 }
                ]
            },
            '安徽': {
                firstWeightPrice: 30,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 30 },
                    { min: 0.11, max: 0.5, price: 240 },
                    { min: 0.51, max: 1.5, price: 220 },
                    { min: 1.51, max: 4, price: 210 },
                    { min: 4.01, max: Infinity, price: 180 }
                ]
            },
            '天津': {
                firstWeightPrice: 30,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 30 },
                    { min: 0.11, max: 0.5, price: 240 },
                    { min: 0.51, max: 1.5, price: 220 },
                    { min: 1.51, max: 4, price: 210 },
                    { min: 4.01, max: Infinity, price: 180 }
                ]
            },
            '河北': {
                firstWeightPrice: 30,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 30 },
                    { min: 0.11, max: 0.5, price: 240 },
                    { min: 0.51, max: 1.5, price: 220 },
                    { min: 1.51, max: 4, price: 210 },
                    { min: 4.01, max: Infinity, price: 180 }
                ]
            },
            '河南': {
                firstWeightPrice: 30,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 30 },
                    { min: 0.11, max: 0.5, price: 240 },
                    { min: 0.51, max: 1.5, price: 220 },
                    { min: 1.51, max: 4, price: 210 },
                    { min: 4.01, max: Infinity, price: 180 }
                ]
            },
            '山西': {
                firstWeightPrice: 35,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 35 },
                    { min: 0.11, max: 0.5, price: 260 },
                    { min: 0.51, max: 1.5, price: 240 },
                    { min: 1.51, max: 4, price: 220 },
                    { min: 4.01, max: Infinity, price: 200 }
                ]
            },
            '北京': {
                firstWeightPrice: 40,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 40 },
                    { min: 0.11, max: 0.5, price: 240 },
                    { min: 0.51, max: 1.5, price: 240 },
                    { min: 1.51, max: 4, price: 220 },
                    { min: 4.01, max: Infinity, price: 200 }
                ]
            },
            '广东': {
                firstWeightPrice: 40,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 40 },
                    { min: 0.11, max: 0.5, price: 280 },
                    { min: 0.51, max: 1.5, price: 270 },
                    { min: 1.51, max: 4, price: 260 },
                    { min: 4.01, max: Infinity, price: 230 }
                ]
            },
            '福建': {
                firstWeightPrice: 40,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 40 },
                    { min: 0.11, max: 0.5, price: 280 },
                    { min: 0.51, max: 1.5, price: 270 },
                    { min: 1.51, max: 4, price: 260 },
                    { min: 4.01, max: Infinity, price: 220 }
                ]
            },
            '湖北': {
                firstWeightPrice: 40,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 40 },
                    { min: 0.11, max: 0.5, price: 280 },
                    { min: 0.51, max: 1.5, price: 270 },
                    { min: 1.51, max: 4, price: 260 },
                    { min: 4.01, max: Infinity, price: 220 }
                ]
            },
            '湖南': {
                firstWeightPrice: 40,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 40 },
                    { min: 0.11, max: 0.5, price: 280 },
                    { min: 0.51, max: 1.5, price: 270 },
                    { min: 1.51, max: 4, price: 260 },
                    { min: 4.01, max: Infinity, price: 220 }
                ]
            },
            '江西': {
                firstWeightPrice: 40,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 40 },
                    { min: 0.11, max: 0.5, price: 300 },
                    { min: 0.51, max: 1.5, price: 280 },
                    { min: 1.51, max: 4, price: 270 },
                    { min: 4.01, max: Infinity, price: 240 }
                ]
            },
            '辽宁': {
                firstWeightPrice: 40,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 40 },
                    { min: 0.11, max: 0.5, price: 300 },
                    { min: 0.51, max: 1.5, price: 280 },
                    { min: 1.51, max: 4, price: 270 },
                    { min: 4.01, max: Infinity, price: 240 }
                ]
            },
            '陕西': {
                firstWeightPrice: 40,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 40 },
                    { min: 0.11, max: 0.5, price: 300 },
                    { min: 0.51, max: 1.5, price: 280 },
                    { min: 1.51, max: 4, price: 270 },
                    { min: 4.01, max: Infinity, price: 240 }
                ]
            },
            '吉林': {
                firstWeightPrice: 40,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 40 },
                    { min: 0.11, max: 0.5, price: 320 },
                    { min: 0.51, max: 1.5, price: 300 },
                    { min: 1.51, max: 4, price: 280 },
                    { min: 4.01, max: Infinity, price: 260 }
                ]
            },
            '广西': {
                firstWeightPrice: 45,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 45 },
                    { min: 0.11, max: 0.5, price: 300 },
                    { min: 0.51, max: 1.5, price: 300 },
                    { min: 1.51, max: 4, price: 280 },
                    { min: 4.01, max: Infinity, price: 260 }
                ]
            },
            '黑龙江': {
                firstWeightPrice: 45,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 45 },
                    { min: 0.11, max: 0.5, price: 340 },
                    { min: 0.51, max: 1.5, price: 320 },
                    { min: 1.51, max: 4, price: 300 },
                    { min: 4.01, max: Infinity, price: 260 }
                ]
            },
            '内蒙古': {
                firstWeightPrice: 50,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 50 },
                    { min: 0.11, max: 0.5, price: 400 },
                    { min: 0.51, max: 1.5, price: 390 },
                    { min: 1.51, max: 4, price: 380 },
                    { min: 4.01, max: Infinity, price: 360 }
                ]
            },
            '四川': {
                firstWeightPrice: 50,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 50 },
                    { min: 0.11, max: 0.5, price: 400 },
                    { min: 0.51, max: 1.5, price: 390 },
                    { min: 1.51, max: 4, price: 380 },
                    { min: 4.01, max: Infinity, price: 360 }
                ]
            },
            '重庆': {
                firstWeightPrice: 50,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 50 },
                    { min: 0.11, max: 0.5, price: 400 },
                    { min: 0.51, max: 1.5, price: 390 },
                    { min: 1.51, max: 4, price: 380 },
                    { min: 4.01, max: Infinity, price: 360 }
                ]
            },
            '贵州': {
                firstWeightPrice: 50,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 50 },
                    { min: 0.11, max: 0.5, price: 400 },
                    { min: 0.51, max: 1.5, price: 390 },
                    { min: 1.51, max: 4, price: 380 },
                    { min: 4.01, max: Infinity, price: 360 }
                ]
            },
            '宁夏': {
                firstWeightPrice: 50,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 50 },
                    { min: 0.11, max: 0.5, price: 400 },
                    { min: 0.51, max: 1.5, price: 390 },
                    { min: 1.51, max: 4, price: 380 },
                    { min: 4.01, max: Infinity, price: 360 }
                ]
            },
            '云南': {
                firstWeightPrice: 60,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 60 },
                    { min: 0.11, max: 0.5, price: 600 },
                    { min: 0.51, max: 1.5, price: 560 },
                    { min: 1.51, max: 4, price: 540 },
                    { min: 4.01, max: Infinity, price: 500 }
                ]
            },
            '海南': {
                firstWeightPrice: 70,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 70 },
                    { min: 0.11, max: 0.5, price: 600 },
                    { min: 0.51, max: 1.5, price: 560 },
                    { min: 1.51, max: 4, price: 540 },
                    { min: 4.01, max: Infinity, price: 500 }
                ]
            },
            '甘肃': {
                firstWeightPrice: 70,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 70 },
                    { min: 0.11, max: 0.5, price: 600 },
                    { min: 0.51, max: 1.5, price: 560 },
                    { min: 1.51, max: 4, price: 540 },
                    { min: 4.01, max: Infinity, price: 500 }
                ]
            },
            '青海': {
                firstWeightPrice: 70,
                cbmRanges: [
                    { min: 0, max: 0.1, price: 70 },
                    { min: 0.11, max: 0.5, price: 600 },
                    { min: 0.51, max: 1.5, price: 560 },
                    { min: 1.51, max: 4, price: 540 },
                    { min: 4.01, max: Infinity, price: 500 }
                ]
            }
        };

        const DEFAULT_DATA = {
            machines: [
                { id: 'kh1', series: 'A', model: '350A', power: '50W', price: 5025, priceTier2: 5377, priceTier3: 6030, packingSize: '110*80*85', cbm: 0.8, volumeWeight: 125, actualWeight: 103 },
                { id: 'kh2', series: 'A', model: '350A', power: '60W', price: 5327, priceTier2: 5700, priceTier3: 6392, packingSize: '128*80*85', cbm: 0.9, volumeWeight: 146, actualWeight: 118 },
                { id: 'kh3', series: 'A', model: '350A', power: '80W', price: 5628, priceTier2: 6022, priceTier3: 6754, packingSize: '155*80*85', cbm: 1.1, volumeWeight: 176, actualWeight: 125 },
                { id: 'kh4', series: 'A', model: '460A', power: '50W', price: 5226, priceTier2: 5592, priceTier3: 6271, packingSize: '120*90*85', cbm: 1, volumeWeight: 153, actualWeight: 123 },
                { id: 'kh5', series: 'A', model: '460A', power: '60W', price: 5528, priceTier2: 5915, priceTier3: 6634, packingSize: '128*90*85', cbm: 1, volumeWeight: 164, actualWeight: 127 },
                { id: 'kh6', series: 'A', model: '460A', power: '80W', price: 5829, priceTier2: 6237, priceTier3: 6995, packingSize: '155*90*85', cbm: 1.2, volumeWeight: 198, actualWeight: 130 },
        { id: 'kh7', series: 'A', model: '460A', power: '100W', price: 6432, priceTier2: 6882, priceTier3: 7718, packingSize: '174*90*85', cbm: 1.4, volumeWeight: 222, actualWeight: 140 },
        { id: 'kh8', series: 'A', model: '750A', power: '60W', price: 5729, priceTier2: 6130, priceTier3: 6875, packingSize: '128*97*87', cbm: 1.1, volumeWeight: 181, actualWeight: 150 },
        { id: 'kh9', series: 'A', model: '750A', power: '80W', price: 6030, priceTier2: 6452, priceTier3: 7236, packingSize: '155*97*87', cbm: 1.4, volumeWeight: 219, actualWeight: 160 },
        { id: 'kh10', series: 'A', model: '750A', power: '100W', price: 6633, priceTier2: 7097, priceTier3: 7960, packingSize: '174*97*87', cbm: 1.5, volumeWeight: 245, actualWeight: 172 },
        { id: 'kh11', series: 'A', model: '960A', power: '80W', price: 6935, priceTier2: 7420, priceTier3: 8322, packingSize: '150*114*87', cbm: 1.5, volumeWeight: 248, actualWeight: 215 },
        { id: 'kh12', series: 'A', model: '960A', power: '100W', price: 7337, priceTier2: 7850, priceTier3: 8804, packingSize: '174*114*87', cbm: 1.8, volumeWeight: 288, actualWeight: 230 },
        { id: 'kh13', series: 'A', model: '960A', power: '130W', price: 7739, priceTier2: 8280, priceTier3: 9286, packingSize: '198*114*87', cbm: 2, volumeWeight: 328, actualWeight: 245 },
        { id: 'kh14', series: 'A', model: '960A', power: '150W', price: 8543, priceTier2: 9140, priceTier3: 10251, packingSize: '217*114*87', cbm: 2.2, volumeWeight: 359, actualWeight: 260 },
        { id: 'kh15', series: 'A', model: '1060A', power: '80W', price: 7235, priceTier2: 7741, priceTier3: 8682, packingSize: '158*114*87', cbm: 1.6, volumeWeight: 262, actualWeight: 225 },
        { id: 'kh16', series: 'A', model: '1060A', power: '100W', price: 7637, priceTier2: 8172, priceTier3: 9164, packingSize: '174*114*87', cbm: 1.8, volumeWeight: 288, actualWeight: 230 },
        { id: 'kh17', series: 'A', model: '1060A', power: '130W', price: 8040, priceTier2: 8603, priceTier3: 9648, packingSize: '198*114*87', cbm: 2, volumeWeight: 328, actualWeight: 240 },
        { id: 'kh18', series: 'A', model: '1060A', power: '150W', price: 8843, priceTier2: 9462, priceTier3: 10612, packingSize: '217*114*87', cbm: 2.2, volumeWeight: 359, actualWeight: 255 },
        { id: 'kh19', series: 'A', model: '1080A', power: '80W', price: 7538, priceTier2: 8066, priceTier3: 9046, packingSize: '158*132*87', cbm: 1.9, volumeWeight: 303, actualWeight: 245 },
        { id: 'kh20', series: 'A', model: '1080A', power: '100W', price: 7940, priceTier2: 8495, priceTier3: 9528, packingSize: '174*132*87', cbm: 2, volumeWeight: 334, actualWeight: 256 },
        { id: 'kh21', series: 'A', model: '1080A', power: '130W', price: 8342, priceTier2: 8925, priceTier3: 10010, packingSize: '198*132*87', cbm: 2.3, volumeWeight: 379, actualWeight: 276 },
        { id: 'kh22', series: 'A', model: '1080A', power: '150W', price: 9146, priceTier2: 9786, priceTier3: 10975, packingSize: '215*132*87', cbm: 2.5, volumeWeight: 412, actualWeight: 289 },
        { id: 'kh23', series: 'A', model: '1490A', power: '80W', price: 8342, priceTier2: 8925, priceTier3: 10010, packingSize: '198*145*87', cbm: 2.5, volumeWeight: 417, actualWeight: 350 },
        { id: 'kh24', series: 'A', model: '1490A', power: '100W', price: 8744, priceTier2: 9356, priceTier3: 10492, packingSize: '198*145*87', cbm: 2.5, volumeWeight: 417, actualWeight: 360 },
        { id: 'kh25', series: 'A', model: '1490A', power: '130W', price: 9045, priceTier2: 9678, priceTier3: 10854, packingSize: '198*145*87', cbm: 2.5, volumeWeight: 417, actualWeight: 365 },
        { id: 'kh26', series: 'A', model: '1490A', power: '150W', price: 9648, priceTier2: 10323, priceTier3: 11578, packingSize: '217*145*88', cbm: 2.8, volumeWeight: 462, actualWeight: 367 },
        { id: 'kh27', series: 'A', model: '1410A', power: '80W', price: 8850, priceTier2: 9500, priceTier3: 10620, packingSize: '198*155*87', cbm: 2.7, volumeWeight: 446, actualWeight: 350 },
        { id: 'kh28', series: 'A', model: '1410A', power: '100W', price: 9300, priceTier2: 9900, priceTier3: 11160, packingSize: '198*155*87', cbm: 2.7, volumeWeight: 446, actualWeight: 370 },
        { id: 'kh29', series: 'A', model: '1410A', power: '130W', price: 9600, priceTier2: 10300, priceTier3: 11520, packingSize: '198*155*87', cbm: 2.7, volumeWeight: 446, actualWeight: 390 },
        { id: 'kh30', series: 'A', model: '1410A', power: '150W', price: 10200, priceTier2: 10950, priceTier3: 12240, packingSize: '219*155*87', cbm: 3, volumeWeight: 493, actualWeight: 370 },
        { id: 'kh31', series: 'B1', model: '350B1', power: '50W', price: 5226, priceTier2: 5592, priceTier3: 6271, packingSize: '110*80*87', cbm: 0.8, volumeWeight: 128, actualWeight: 103 },
        { id: 'kh32', series: 'B1', model: '350B1', power: '60W', price: 5528, priceTier2: 5914, priceTier3: 6633, packingSize: '128*80*87', cbm: 0.9, volumeWeight: 149, actualWeight: 118 },
        { id: 'kh33', series: 'B1', model: '350B1', power: '80W', price: 5829, priceTier2: 6237, priceTier3: 6995, packingSize: '155*80*87', cbm: 1.1, volumeWeight: 180, actualWeight: 0 },
        { id: 'kh34', series: 'B1', model: '460B1', power: '50W', price: 5427, priceTier2: 5807, priceTier3: 6512, packingSize: '120*90*87', cbm: 1, volumeWeight: 157, actualWeight: 123 },
        { id: 'kh35', series: 'B1', model: '460B1', power: '60W', price: 5729, priceTier2: 6129, priceTier3: 6874, packingSize: '128*90*87', cbm: 1.1, volumeWeight: 168, actualWeight: 127 },
        { id: 'kh36', series: 'B1', model: '460B1', power: '80W', price: 6030, priceTier2: 6452, priceTier3: 7236, packingSize: '155*90*87', cbm: 1.3, volumeWeight: 203, actualWeight: 130 },
        { id: 'kh37', series: 'B1', model: '460B1', power: '100W', price: 6633, priceTier2: 7097, priceTier3: 7960, packingSize: '174*90*87', cbm: 1.4, volumeWeight: 228, actualWeight: 140 },
        { id: 'kh38', series: 'B1', model: '750B1', power: '60W', price: 5930, priceTier2: 6345, priceTier3: 7115, packingSize: '127*97*87', cbm: 1.1, volumeWeight: 179, actualWeight: 150 },
        { id: 'kh39', series: 'B1', model: '750B1', power: '80W', price: 6231, priceTier2: 6667, priceTier3: 7477, packingSize: '152*97*87', cbm: 1.3, volumeWeight: 214, actualWeight: 160 },
        { id: 'kh40', series: 'B1', model: '750B1', power: '100W', price: 6834, priceTier2: 7312, priceTier3: 8201, packingSize: '174*97*87', cbm: 1.5, volumeWeight: 245, actualWeight: 172 },
        { id: 'kh41', series: 'B1', model: '960B1', power: '80W', price: 7236, priceTier2: 7743, priceTier3: 8683, packingSize: '149*114*87', cbm: 1.5, volumeWeight: 247, actualWeight: 215 },
        { id: 'kh42', series: 'B1', model: '960B1', power: '100W', price: 7638, priceTier2: 8173, priceTier3: 9166, packingSize: '174*114*87', cbm: 1.8, volumeWeight: 288, actualWeight: 230 },
        { id: 'kh43', series: 'B1', model: '960B1', power: '130W', price: 8040, priceTier2: 8603, priceTier3: 9648, packingSize: '198*114*87', cbm: 2, volumeWeight: 328, actualWeight: 245 },
        { id: 'kh44', series: 'B1', model: '960B1', power: '150W', price: 8844, priceTier2: 9463, priceTier3: 10613, packingSize: '217*114*87', cbm: 2.2, volumeWeight: 359, actualWeight: 255 },
        { id: 'kh45', series: 'B1', model: '1060B1', power: '80W', price: 7538, priceTier2: 8065, priceTier3: 9045, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh46', series: 'B1', model: '1060B1', power: '100W', price: 7940, priceTier2: 8495, priceTier3: 9527, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh47', series: 'B1', model: '1060B1', power: '130W', price: 8342, priceTier2: 8925, priceTier3: 10010, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh48', series: 'B1', model: '1060B1', power: '150W', price: 9146, priceTier2: 9786, priceTier3: 10975, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh49', series: 'B1', model: '1080B1', power: '80W', price: 7839, priceTier2: 8388, priceTier3: 9407, packingSize: '158*130*87', cbm: 1.8, volumeWeight: 298, actualWeight: 245 },
        { id: 'kh50', series: 'B1', model: '1080B1', power: '100W', price: 8241, priceTier2: 8818, priceTier3: 9889, packingSize: '174*130*87', cbm: 2, volumeWeight: 328, actualWeight: 256 },
        { id: 'kh51', series: 'B1', model: '1080B1', power: '130W', price: 8643, priceTier2: 9248, priceTier3: 10372, packingSize: '198*130*87', cbm: 2.3, volumeWeight: 374, actualWeight: 276 },
        { id: 'kh52', series: 'B1', model: '1080B1', power: '150W', price: 9447, priceTier2: 10108, priceTier3: 11336, packingSize: '219*145*87', cbm: 2.8, volumeWeight: 461, actualWeight: 325 },
        { id: 'kh53', series: 'B1', model: '1490B1', power: '80W', price: 8643, priceTier2: 9248, priceTier3: 10372, packingSize: '198*145*87', cbm: 2.5, volumeWeight: 417, actualWeight: 360 },
        { id: 'kh54', series: 'B1', model: '1490B1', power: '100W', price: 9045, priceTier2: 9678, priceTier3: 10854, packingSize: '198*145*87', cbm: 2.5, volumeWeight: 417, actualWeight: 360 },
        { id: 'kh55', series: 'B1', model: '1490B1', power: '130W', price: 9347, priceTier2: 10001, priceTier3: 11216, packingSize: '198*145*87', cbm: 2.5, volumeWeight: 417, actualWeight: 365 },
        { id: 'kh56', series: 'B1', model: '1490B1', power: '150W', price: 9950, priceTier2: 10646, priceTier3: 11939, packingSize: '219*145*87', cbm: 2.8, volumeWeight: 461, actualWeight: 370 },
        { id: 'kh57', series: 'C', model: '960C', power: '80W', price: 9100, priceTier2: 9740, priceTier3: 10920, packingSize: '155*115*128', cbm: 2.3, volumeWeight: 381, actualWeight: 300 },
        { id: 'kh58', series: 'C', model: '960C', power: '100W', price: 9600, priceTier2: 10280, priceTier3: 11520, packingSize: '175*115*128', cbm: 2.6, volumeWeight: 430, actualWeight: 320 },
        { id: 'kh59', series: 'C', model: '960C', power: '130W', price: 10300, priceTier2: 11020, priceTier3: 12360, packingSize: '195*115*128', cbm: 2.9, volumeWeight: 479, actualWeight: 330 },
        { id: 'kh60', series: 'C', model: '1080C', power: '80W', price: 9600, priceTier2: 10280, priceTier3: 11520, packingSize: '165*135*128', cbm: 2.9, volumeWeight: 476, actualWeight: 340 },
        { id: 'kh61', series: 'C', model: '1080C', power: '100W', price: 10100, priceTier2: 10810, priceTier3: 12120, packingSize: '175*135*128', cbm: 3.1, volumeWeight: 504, actualWeight: 350 },
        { id: 'kh62', series: 'C', model: '1080C', power: '130W', price: 10800, priceTier2: 11560, priceTier3: 12960, packingSize: '195*135*128', cbm: 3.4, volumeWeight: 556, actualWeight: 366 },
        { id: 'kh63', series: 'C', model: '1290C', power: '100W', price: 10700, priceTier2: 11450, priceTier3: 12840, packingSize: '175*145*128', cbm: 3.3, volumeWeight: 542, actualWeight: 0 },
        { id: 'kh64', series: 'C', model: '1290C', power: '130W', price: 11200, priceTier2: 11990, priceTier3: 13440, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh65', series: 'C', model: '1290C', power: '150W', price: 12200, priceTier2: 13060, priceTier3: 14640, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh66', series: 'C', model: '1290C', power: '180W', price: 13200, priceTier2: 14130, priceTier3: 15840, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh67', series: 'C', model: '1290C', power: '200W', price: 14700, priceTier2: 15730, priceTier3: 17640, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh68', series: 'C', model: '1290C', power: '300W', price: 18200, priceTier2: 19480, priceTier3: 21840, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh69', series: 'C', model: '1390C', power: '100W', price: 11000, priceTier2: 11770, priceTier3: 13200, packingSize: '195*145*128', cbm: 3.6, volumeWeight: 598, actualWeight: 422 },
        { id: 'kh70', series: 'C', model: '1390C', power: '130W', price: 11500, priceTier2: 12310, priceTier3: 13800, packingSize: '195*145*128', cbm: 3.6, volumeWeight: 598, actualWeight: 422 },
        { id: 'kh71', series: 'C', model: '1390C', power: '150W', price: 12500, priceTier2: 13380, priceTier3: 15000, packingSize: '217*145*128', cbm: 4.1, volumeWeight: 672, actualWeight: 430 },
        { id: 'kh72', series: 'C', model: '1390C', power: '180W', price: 13500, priceTier2: 14450, priceTier3: 16200, packingSize: '217*145*128', cbm: 4.1, volumeWeight: 672, actualWeight: 0 },
        { id: 'kh73', series: 'C', model: '1390C', power: '200W', price: 15000, priceTier2: 16050, priceTier3: 18000, packingSize: '257*145*128', cbm: 4.8, volumeWeight: 795, actualWeight: 455 },
        { id: 'kh74', series: 'C', model: '1390C', power: '300w', price: 18500, priceTier2: 19800, priceTier3: 22200, packingSize: '219*157*128', cbm: 4.5, volumeWeight: 734, actualWeight: 450 },
        { id: 'kh75', series: 'C', model: '1310C', power: '100W', price: 11600, priceTier2: 12420, priceTier3: 13920, packingSize: '195*155*128', cbm: 3.9, volumeWeight: 639, actualWeight: 432 },
        { id: 'kh76', series: 'C', model: '1310C', power: '130W', price: 12100, priceTier2: 12950, priceTier3: 14520, packingSize: '195*155*128', cbm: 3.9, volumeWeight: 639, actualWeight: 432 },
        { id: 'kh77', series: 'C', model: '1310C', power: '150W', price: 13100, priceTier2: 14020, priceTier3: 15720, packingSize: '215*155*128', cbm: 4.3, volumeWeight: 711, actualWeight: 440 },
        { id: 'kh78', series: 'C', model: '1310C', power: '180W', price: 14100, priceTier2: 15090, priceTier3: 16920, packingSize: '215*155*128', cbm: 4.3, volumeWeight: 711, actualWeight: 440 },
        { id: 'kh79', series: 'C', model: '1310C', power: '200W', price: 15100, priceTier2: 16160, priceTier3: 18120, packingSize: '257*155*128', cbm: 5.1, volumeWeight: 850, actualWeight: 465 },
        { id: 'kh80', series: 'C', model: '1310C', power: '300w', price: 19100, priceTier2: 20440, priceTier3: 22920, packingSize: '215*167*128', cbm: 4.6, volumeWeight: 766, actualWeight: 455 },
        { id: 'kh81', series: 'C', model: '1490C', power: '100W', price: 11600, priceTier2: 12420, priceTier3: 13920, packingSize: '204*145*128', cbm: 3.8, volumeWeight: 632, actualWeight: 437 },
        { id: 'kh82', series: 'C', model: '1490C', power: '130W', price: 12100, priceTier2: 12950, priceTier3: 14520, packingSize: '204*145*128', cbm: 3.8, volumeWeight: 632, actualWeight: 437 },
        { id: 'kh83', series: 'C', model: '1490C', power: '150W', price: 13100, priceTier2: 14020, priceTier3: 15720, packingSize: '217*145*128', cbm: 4.1, volumeWeight: 672, actualWeight: 475 },
        { id: 'kh84', series: 'C', model: '1490C', power: '180W', price: 14100, priceTier2: 15090, priceTier3: 16920, packingSize: '217*145*128', cbm: 4.1, volumeWeight: 672, actualWeight: 0 },
        { id: 'kh85', series: 'C', model: '1490C', power: '200W', price: 15100, priceTier2: 16160, priceTier3: 18120, packingSize: '257*145*128', cbm: 4.8, volumeWeight: 795, actualWeight: 463 },
        { id: 'kh86', series: 'C', model: '1490C', power: '300w', price: 19100, priceTier2: 20440, priceTier3: 22920, packingSize: '219*157*128', cbm: 4.5, volumeWeight: 734, actualWeight: 450 },
        { id: 'kh87', series: 'C', model: '1410C', power: '100W', price: 12100, priceTier2: 12950, priceTier3: 14520, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh88', series: 'C', model: '1410C', power: '130W', price: 12600, priceTier2: 13490, priceTier3: 15120, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh89', series: 'C', model: '1410C', power: '150W', price: 13600, priceTier2: 14560, priceTier3: 16320, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh90', series: 'C', model: '1410C', power: '180W', price: 14600, priceTier2: 15630, priceTier3: 17520, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh91', series: 'C', model: '1410C', power: '200W', price: 15600, priceTier2: 16700, priceTier3: 18720, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh92', series: 'C', model: '1410C', power: '300w', price: 19600, priceTier2: 20980, priceTier3: 23520, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh93', series: 'C', model: '1610C', power: '100W', price: 13250, priceTier2: 14180, priceTier3: 15900, packingSize: '225*155*128', cbm: 4.5, volumeWeight: 744, actualWeight: 0 },
        { id: 'kh94', series: 'C', model: '1610C', power: '130W', price: 13750, priceTier2: 14720, priceTier3: 16500, packingSize: '225*155*128', cbm: 4.5, volumeWeight: 744, actualWeight: 0 },
        { id: 'kh95', series: 'C', model: '1610C', power: '150W', price: 14750, priceTier2: 15782, priceTier3: 17700, packingSize: '225*155*128', cbm: 4.5, volumeWeight: 744, actualWeight: 480 },
        { id: 'kh96', series: 'C', model: '1610C', power: '180W', price: 15750, priceTier2: 16850, priceTier3: 18900, packingSize: '225*155*128', cbm: 4.5, volumeWeight: 744, actualWeight: 0 },
        { id: 'kh97', series: 'C', model: '1610C', power: '200W', price: 17050, priceTier2: 18250, priceTier3: 20460, packingSize: '257*155*128', cbm: 5.1, volumeWeight: 850, actualWeight: 500 },
        { id: 'kh98', series: 'C', model: '1610C', power: '300W', price: 20750, priceTier2: 22200, priceTier3: 24900, packingSize: '225*167*128', cbm: 4.9, volumeWeight: 802, actualWeight: 0 },
        { id: 'kh99', series: 'C', model: '1810C', power: '100W', price: 14250, priceTier2: 15250, priceTier3: 17100, packingSize: '245*155*128', cbm: 4.9, volumeWeight: 807, actualWeight: 0 },
        { id: 'kh100', series: 'C', model: '1810C', power: '130W', price: 14750, priceTier2: 15790, priceTier3: 17700, packingSize: '245*155*128', cbm: 4.9, volumeWeight: 807, actualWeight: 0 },
        { id: 'kh101', series: 'C', model: '1810C', power: '150W', price: 15750, priceTier2: 16850, priceTier3: 18900, packingSize: '245*155*128', cbm: 4.9, volumeWeight: 807, actualWeight: 0 },
        { id: 'kh102', series: 'C', model: '1810C', power: '180W', price: 16750, priceTier2: 17930, priceTier3: 20100, packingSize: '245*155*128', cbm: 4.9, volumeWeight: 807, actualWeight: 0 },
        { id: 'kh103', series: 'C', model: '1810C', power: '200W', price: 18050, priceTier2: 19320, priceTier3: 21660, packingSize: '257*155*128', cbm: 5.1, volumeWeight: 850, actualWeight: 0 },
        { id: 'kh104', series: 'C', model: '1810C', power: '300w', price: 21750, priceTier2: 23280, priceTier3: 26100, packingSize: '245*167*128', cbm: 5.3, volumeWeight: 873, actualWeight: 0 },
        { id: 'kh105', series: 'C', model: '1325C', power: '130W', price: 18500, priceTier2: 19795, priceTier3: 22200, packingSize: '375*217*136', cbm: 11.1, volumeWeight: 1845, actualWeight: 1100 },
        { id: 'kh106', series: 'C', model: '1325C', power: '150W', price: 19000, priceTier2: 20330, priceTier3: 22800, packingSize: '375*217*136', cbm: 11.1, volumeWeight: 1845, actualWeight: 1100 },
        { id: 'kh107', series: 'C', model: '1325C', power: '180W', price: 20000, priceTier2: 21400, priceTier3: 24000, packingSize: '375*217*136', cbm: 11.1, volumeWeight: 1845, actualWeight: 1100 },
        { id: 'kh108', series: 'C', model: '1325C', power: '200W', price: 21500, priceTier2: 23005, priceTier3: 25800, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh109', series: 'C', model: '1325C', power: '300W', price: 25700, priceTier2: 27500, priceTier3: 30840, packingSize: '375*217*136', cbm: 11.1, volumeWeight: 1845, actualWeight: 1150 },
        { id: 'kh110', series: 'C', model: '1325C', power: '300W', price: 37000, priceTier2: 39590, priceTier3: 44400, packingSize: '375*217*136', cbm: 11.1, volumeWeight: 1845, actualWeight: 1150 },
        { id: 'kh111', series: 'XC', model: '460XC', power: '60W', price: 6500, priceTier2: 7000, priceTier3: 7800, packingSize: '123*95*114', cbm: 1.4, volumeWeight: 223, actualWeight: 0 },
        { id: 'kh112', series: 'XC', model: '460XC', power: '80W', price: 6700, priceTier2: 7200, priceTier3: 8100, packingSize: '153*95*114', cbm: 1.7, volumeWeight: 277, actualWeight: 0 },
        { id: 'kh113', series: 'XC', model: '460XC', power: '100W', price: 7300, priceTier2: 7850, priceTier3: 8800, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh114', series: 'XC', model: '750XC', power: '60W', price: 6800, priceTier2: 7300, priceTier3: 8200, packingSize: '123*103*114', cbm: 1.5, volumeWeight: 241, actualWeight: 0 },
        { id: 'kh115', series: 'XC', model: '750XC', power: '80W', price: 7100, priceTier2: 7600, priceTier3: 8600, packingSize: '153*103*114', cbm: 1.8, volumeWeight: 300, actualWeight: 0 },
        { id: 'kh116', series: 'XC', model: '750XC', power: '100W', price: 7700, priceTier2: 8300, priceTier3: 9300, packingSize: '178*103*114', cbm: 2.1, volumeWeight: 349, actualWeight: 0 },
        { id: 'kh117', series: 'XC', model: '9060XC', power: '80W', price: 9000, priceTier2: 9700, priceTier3: 10800, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh118', series: 'XC', model: '9060XC', power: '100W', price: 9500, priceTier2: 10200, priceTier3: 11400, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh119', series: 'XC', model: '9060XC', power: '130W', price: 10200, priceTier2: 11000, priceTier3: 12300, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh120', series: 'XC', model: '1080XC', power: '80W', price: 9500, priceTier2: 10200, priceTier3: 11400, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh121', series: 'XC', model: '1080XC', power: '100W', price: 10000, priceTier2: 10700, priceTier3: 12000, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh122', series: 'XC', model: '1080XC', power: '130W', price: 10700, priceTier2: 11500, priceTier3: 12900, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh123', series: 'XC', model: '1290XC', power: '100W', price: 10500, priceTier2: 11300, priceTier3: 12600, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh124', series: 'XC', model: '1290XC', power: '130W', price: 11000, priceTier2: 11800, priceTier3: 13200, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh125', series: 'XC', model: '1290XC', power: '150W', price: 12000, priceTier2: 12900, priceTier3: 14400, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh126', series: 'XC', model: '1290XC', power: '180W', price: 13000, priceTier2: 14000, priceTier3: 15600, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh127', series: 'XC', model: '1290XC', power: '200W', price: 14500, priceTier2: 15600, priceTier3: 17400, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh128', series: 'XC', model: '1290XC', power: '300W', price: 18000, priceTier2: 19300, priceTier3: 21600, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh129', series: 'XC', model: '1390XC', power: '100W', price: 10800, priceTier2: 11600, priceTier3: 12960, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh130', series: 'XC', model: '1390XC', power: '130W', price: 11300, priceTier2: 12100, priceTier3: 13560, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh131', series: 'XC', model: '1390XC', power: '150W', price: 12300, priceTier2: 13200, priceTier3: 14760, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh132', series: 'XC', model: '1390XC', power: '180W', price: 13300, priceTier2: 14300, priceTier3: 15960, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh133', series: 'XC', model: '1390XC', power: '200W', price: 14800, priceTier2: 15900, priceTier3: 17760, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh134', series: 'XC', model: '1390XC', power: '300w', price: 18300, priceTier2: 19600, priceTier3: 21960, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh135', series: 'XC', model: '1310XC', power: '100W', price: 11400, priceTier2: 12200, priceTier3: 13680, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh136', series: 'XC', model: '1310XC', power: '130W', price: 11900, priceTier2: 12800, priceTier3: 14280, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh137', series: 'XC', model: '1310XC', power: '150W', price: 12900, priceTier2: 13800, priceTier3: 15480, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh138', series: 'XC', model: '1310XC', power: '180W', price: 13900, priceTier2: 14900, priceTier3: 16680, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh139', series: 'XC', model: '1310XC', power: '200W', price: 14900, priceTier2: 16000, priceTier3: 17880, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh140', series: 'XC', model: '1310XC', power: '300w', price: 18900, priceTier2: 20300, priceTier3: 22680, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh141', series: 'XC', model: '1490XC', power: '100W', price: 11400, priceTier2: 12200, priceTier3: 13680, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh142', series: 'XC', model: '1490XC', power: '130W', price: 11900, priceTier2: 12800, priceTier3: 14280, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh143', series: 'XC', model: '1490XC', power: '150W', price: 12900, priceTier2: 13800, priceTier3: 15480, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh144', series: 'XC', model: '1490XC', power: '180W', price: 13900, priceTier2: 14900, priceTier3: 16680, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh145', series: 'XC', model: '1490XC', power: '200W', price: 14900, priceTier2: 16000, priceTier3: 17880, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh146', series: 'XC', model: '1490XC', power: '300w', price: 18900, priceTier2: 20300, priceTier3: 22680, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh147', series: 'Marker', model: 'Raycus', power: '20W-QS', price: 5330, priceTier2: 5703, priceTier3: 6400, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 55 },
        { id: 'kh148', series: 'Marker', model: 'Raycus', power: '20W-QE', price: 6950, priceTier2: 7440, priceTier3: 8340, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 55 },
        { id: 'kh149', series: 'Marker', model: 'Raycus', power: '30w-QS', price: 6100, priceTier2: 6530, priceTier3: 7320, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 55 },
        { id: 'kh150', series: 'Marker', model: 'Raycus', power: '50W-QS', price: 8700, priceTier2: 9310, priceTier3: 10440, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 55 },
        { id: 'kh151', series: 'Marker', model: 'Raycus', power: '50W-QB', price: 10350, priceTier2: 11075, priceTier3: 12420, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 55 },
        { id: 'kh152', series: 'Marker', model: 'Raycus', power: '60W-QB', price: 10800, priceTier2: 11556, priceTier3: 12960, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh153', series: 'Marker', model: 'Raycus', power: '70W-QB', price: 13000, priceTier2: 13910, priceTier3: 15600, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh154', series: 'Marker', model: 'Raycus', power: '100W-QB', price: 17000, priceTier2: 18190, priceTier3: 20400, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh155', series: 'Marker', model: 'Raycus', power: '100W-Q', price: 36900, priceTier2: 39483, priceTier3: 44280, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh156', series: 'Marker', model: 'Raycus', power: '200W-MX', price: 29000, priceTier2: 30450, priceTier3: 31900, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh157', series: 'Marker', model: 'JPT', power: 'E2-20-M7', price: 10760, priceTier2: 11520, priceTier3: 12920, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 55 },
        { id: 'kh158', series: 'Marker', model: 'JPT', power: 'E2-60-M7', price: 15030, priceTier2: 16090, priceTier3: 18040, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 60 },
        { id: 'kh159', series: 'Marker', model: 'JPT', power: 'E2-100-M7', price: 19590, priceTier2: 20970, priceTier3: 23510, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 63 },
        { id: 'kh160', series: 'Marker', model: 'JPT', power: 'E-20-M7', price: 11070, priceTier2: 11850, priceTier3: 13290, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 55 },
        { id: 'kh161', series: 'Marker', model: 'JPT', power: 'E-30-M7', price: 11370, priceTier2: 12170, priceTier3: 13650, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 55 },
        { id: 'kh162', series: 'Marker', model: 'JPT', power: 'E-60-M7', price: 17360, priceTier2: 18580, priceTier3: 20840, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 60 },
        { id: 'kh163', series: 'Marker', model: 'JPT', power: 'E-80-M7', price: 22640, priceTier2: 24230, priceTier3: 27170, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 60 },
        { id: 'kh164', series: 'Marker', model: 'JPT', power: 'E-100-M7', price: 24970, priceTier2: 26720, priceTier3: 29970, packingSize: '76*46*85', cbm: 0.3, volumeWeight: 50, actualWeight: 63 },
        { id: 'kh165', series: 'Marker', model: 'JPT', power: '60-M7', price: 30760, priceTier2: 32920, priceTier3: 36920, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh166', series: 'Marker', model: 'JPT', power: '80-M7', price: 30760, priceTier2: 32920, priceTier3: 36920, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh167', series: 'Marker', model: 'JPT', power: '100-M7', price: 34310, priceTier2: 36720, priceTier3: 41180, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh168', series: 'Marker', model: 'JPT', power: '120-M7', price: 39080, priceTier2: 41820, priceTier3: 46900, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh169', series: 'Marker', model: 'CO2', power: 'Yongli-40W', price: 11170, priceTier2: 11960, priceTier3: 13410, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh170', series: 'Marker', model: 'CO2', power: 'Yongli-45W', price: 15000, priceTier2: 0, priceTier3: 0, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh171', series: 'Marker', model: 'UV', power: 'LG-5W', price: 12180, priceTier2: 13040, priceTier3: 14620, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh172', series: 'Marker', model: 'UV', power: 'LG-10W', price: 23350, priceTier2: 24990, priceTier3: 28020, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh173', series: 'Marker', model: 'UV', power: 'JPT-5W', price: 12980, priceTier2: 13890, priceTier3: 15580, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh174', series: 'Marker', model: 'UV', power: 'JPT-10W', price: 28350, priceTier2: 30350, priceTier3: 34020, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh175', series: 'Marker', model: 'UV-inner', power: '5W-LG', price: 13000, priceTier2: 13910, priceTier3: 15600, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh176', series: 'Marker', model: 'UV-inner', power: '10W-LG', price: 21000, priceTier2: 22500, priceTier3: 25200, packingSize: '77*77*96', cbm: 0.6, volumeWeight: 95, actualWeight: 95 },
        { id: 'kh177', series: 'Marker', model: 'UV-inner', power: '5WJPT', price: 13800, priceTier2: 14770, priceTier3: 16560, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh178', series: 'Marker', model: 'UV-inner', power: '10W-JPT', price: 26000, priceTier2: 27820, priceTier3: 31200, packingSize: '', cbm: 0, volumeWeight: 0, actualWeight: 0 },
        { id: 'kh179', series: 'Desktop', model: '3020', power: '40W', price: 1500, priceTier2: 1610, priceTier3: 1800, packingSize: '92*62*39', cbm: 0.3, volumeWeight: 38, actualWeight: 19 },
        { id: 'kh180', series: 'Desktop', model: '3020', power: '50W', price: 1600, priceTier2: 1720, priceTier3: 1920, packingSize: '104*64*54', cbm: 0.4, volumeWeight: 60, actualWeight: 35 },
        { id: 'kh181', series: 'Desktop', model: '4040-M3', power: '40W', price: 2800, priceTier2: 3000, priceTier3: 3360, packingSize: '118*82*43', cbm: 0.5, volumeWeight: 68, actualWeight: 60 },
        { id: 'kh182', series: 'Desktop', model: '6040-M3', power: '40W', price: 3200, priceTier2: 3430, priceTier3: 3840, packingSize: '118*82*43', cbm: 0.5, volumeWeight: 68, actualWeight: 60 },
        { id: 'kh183', series: 'Desktop', model: '4040-RD', power: '40W', price: 4600, priceTier2: 4930, priceTier3: 5520, packingSize: '118*82*43', cbm: 0.5, volumeWeight: 68, actualWeight: 60 },
        { id: 'kh184', series: 'Desktop', model: '6040-RD', power: '40W', price: 5000, priceTier2: 5350, priceTier3: 6000, packingSize: '118*82*43', cbm: 0.5, volumeWeight: 68, actualWeight: 60 },
        { id: 'kh185', series: 'Desktop', model: '4040-M3', power: '50W', price: 2900, priceTier2: 3110, priceTier3: 3480, packingSize: '118*82*43', cbm: 0.5, volumeWeight: 68, actualWeight: 60 },
        { id: 'kh186', series: 'Desktop', model: '6040-M3', power: '50W', price: 3300, priceTier2: 3540, priceTier3: 3960, packingSize: '118*82*43', cbm: 0.5, volumeWeight: 68, actualWeight: 60 },
        { id: 'kh187', series: 'Desktop', model: '4040-RD', power: '50W', price: 4700, priceTier2: 5030, priceTier3: 5640, packingSize: '118*82*43', cbm: 0.5, volumeWeight: 68, actualWeight: 60 },
        { id: 'kh188', series: 'Desktop', model: '6040-RD', power: '50W', price: 5100, priceTier2: 5460, priceTier3: 6120, packingSize: '118*82*43', cbm: 0.5, volumeWeight: 68, actualWeight: 60 },
        { id: 'kh189', series: 'Desktop', model: '4040-M3', power: '60W', price: 3500, priceTier2: 3750, priceTier3: 4200, packingSize: '148*82*43', cbm: 0.6, volumeWeight: 87, actualWeight: 65 },
        { id: 'kh190', series: 'Desktop', model: '6040-M3', power: '60W', price: 3800, priceTier2: 4070, priceTier3: 4560, packingSize: '148*82*43', cbm: 0.6, volumeWeight: 87, actualWeight: 70 },
        { id: 'kh191', series: 'Desktop', model: '4040-RD', power: '60W', price: 5200, priceTier2: 5570, priceTier3: 6240, packingSize: '148*82*43', cbm: 0.6, volumeWeight: 87, actualWeight: 65 },
        { id: 'kh192', series: 'Desktop', model: '6040-RD', power: '60W', price: 5600, priceTier2: 6000, priceTier3: 6720, packingSize: '148*82*43', cbm: 0.6, volumeWeight: 87, actualWeight: 70 }
                // ... 保持原有机器数据不变
                // 为节省空间，这里省略了大部分机器数据，实际代码中包含所有原始数据
            ],
            
            products: {
                waterCoolers: [
            { id: 'kh193', name: 'KH6000', model: 'KH6000', price: 900, priceTier2: 963, priceTier3: 1080 },
            { id: 'kh194', name: 'CW3000', model: 'CW3000', price: 450, priceTier2: 482, priceTier3: 540 },
            { id: 'kh195', name: 'CW5200', model: 'CW5200', price: 1300, priceTier2: 1391, priceTier3: 1560 },
            { id: 'kh196', name: 'CW5202', model: 'CW5202', price: 1400, priceTier2: 1498, priceTier3: 1680 },
            { id: 'kh197', name: 'CW6000', model: 'CW6000', price: 2600, priceTier2: 2782, priceTier3: 3120 },
            { id: 'kh198', name: 'S&ACW5200', model: 'S&ACW5200', price: 1700, priceTier2: 1819, priceTier3: 2040 },
            { id: 'kh199', name: 'S&ACW6000', model: 'S&ACW6000', price: 3300, priceTier2: 3531, priceTier3: 3960 }
                    // ... 保持原有水冷机数据不变
                ],
                
                accessories: [
            { id: 'kh200', name: 'CCD camera', model: '', price: 2500, priceTier2: 2500, priceTier3: 2500 },
            { id: 'kh201', name: 'Chuck Rotating Shaft', model: '', price: 720, priceTier2: 770, priceTier3: 870 },
            { id: 'kh202', name: 'Auto focus', model: '', price: 300, priceTier2: 300, priceTier3: 300 },
            { id: 'kh203', name: 'A set of spare lenses', model: '', price: 175, priceTier2: 186, priceTier3: 216 },
            { id: 'kh204', name: 'Leadshine two-phase motor', model: '', price: 150, priceTier2: 150, priceTier3: 150 },
            { id: 'kh205', name: 'HIWIN Guide Rail', model: '', price: 1000, priceTier2: 1000, priceTier3: 1000 },
            { id: 'kh206', name: 'mini camera', model: '', price: 700, priceTier2: 700, priceTier3: 700 }

                    // ... 保持原有配件数据不变
                ],
                
                otherAccessories: [
  { "id": "kh207", "name": "差价科绘换R1（60W）", "price": 240, "priceTier2": 270, "priceTier3": 330 },
  { "id": "kh208", "name": "差价R3换T2（80W）", "price": 190, "priceTier2": 200, "priceTier3": 200 },
  { "id": "kh209", "name": "差价R3换W2（80W）", "price": 850, "priceTier2": 910, "priceTier3": 1000 },
  { "id": "kh210", "name": "差价R3换H2（80W）", "price": 140, "priceTier2": 150, "priceTier3": 160 },
  { "id": "kh211", "name": "差价R5换T4（100W）", "price": 230, "priceTier2": 240, "priceTier3": 250 },
  { "id": "kh212", "name": "差价R5换W4（100W）", "price": 1210, "priceTier2": 1280, "priceTier3": 1410 },
  { "id": "kh213", "name": "差价R5换H4（100W）", "price": 120, "priceTier2": 120, "priceTier3": 140 },
  { "id": "kh214", "name": "差价R7换T6（130W)", "price": 330, "priceTier2": 350, "priceTier3": 380 },
  { "id": "kh215", "name": "差价R7换W6（130W）", "price": 2270, "priceTier2": 2420, "priceTier3": 2690 },
  { "id": "kh216", "name": "差价R7换H6（130W）", "price": 600, "priceTier2": 640, "priceTier3": 720 },
  { "id": "kh217", "name": "差价R9换W8（150W)", "price": 4540, "priceTier2": 4840, "priceTier3": 5390 },
  { "id": "kh218", "name": "差价R9换H8（150W）", "price": 970, "priceTier2": 1040, "priceTier3": 1160 },
  { "id": "kh219", "name": "Reci T1", "price": 710, "priceTier2": 760, "priceTier3": 860 },
  { "id": "kh220", "name": "Reci T2", "price": 800, "priceTier2": 860, "priceTier3": 960 },
  { "id": "kh221", "name": "Reci T4", "price": 1150, "priceTier2": 1240, "priceTier3": 1380 },
  { "id": "kh222", "name": "Reci T6", "price": 1330, "priceTier2": 1430, "priceTier3": 1600 },
  { "id": "kh223", "name": "Reci W1", "price": 1020, "priceTier2": 1100, "priceTier3": 1230 },
  { "id": "kh224", "name": "Reci W2", "price": 1460, "priceTier2": 1570, "priceTier3": 1760 },
  { "id": "kh225", "name": "Reci W4", "price": 2030, "priceTier2": 2180, "priceTier3": 2440 },
  { "id": "kh226", "name": "Reci W6", "price": 3170, "priceTier2": 3400, "priceTier3": 3810 },
  { "id": "kh227", "name": "Reci W8", "price": 5810, "priceTier2": 6220, "priceTier3": 6980 },
  { "id": "kh228", "name": "EFR F2", "price": 690, "priceTier2": 740, "priceTier3": 830 },
  { "id": "kh229", "name": "EFR F4", "price": 1030, "priceTier2": 1110, "priceTier3": 1240 },
  { "id": "kh230", "name": "EFR F6", "price": 1150, "priceTier2": 1240, "priceTier3": 1380 },
  { "id": "kh231", "name": "EFR F7", "price": 1300, "priceTier2": 1400, "priceTier3": 1560 },
  { "id": "kh232", "name": "EFR F8", "price": 1730, "priceTier2": 1860, "priceTier3": 2080 },
  { "id": "kh233", "name": "EFR DF18", "price": 2230, "priceTier2": 2390, "priceTier3": 2680 },
  { "id": "kh234", "name": "EFR DF22", "price": 2730, "priceTier2": 2920, "priceTier3": 3280 },
  { "id": "kh235", "name": "Xinrui EC300", "price": 5000, "priceTier2": 5350, "priceTier3": 6000 },
  { "id": "kh236", "name": "Yongli R1", "price": 630, "priceTier2": 680, "priceTier3": 760 },
  { "id": "kh237", "name": "Yongli R3", "price": 710, "priceTier2": 760, "priceTier3": 860 },
  { "id": "kh238", "name": "Yongli R5", "price": 1020, "priceTier2": 1100, "priceTier3": 1230 },
  { "id": "kh239", "name": "Yongli R7", "price": 1100, "priceTier2": 1180, "priceTier3": 1320 },
  { "id": "kh240", "name": "Yongli R9", "price": 1570, "priceTier2": 1680, "priceTier3": 1890 },
  { "id": "kh241", "name": "Yongli H1", "price": 770, "priceTier2": 830, "priceTier3": 930 },
  { "id": "kh242", "name": "Yongli H2", "price": 850, "priceTier2": 910, "priceTier3": 1020 },
  { "id": "kh243", "name": "Yongli H4", "price": 1140, "priceTier2": 1220, "priceTier3": 1370 },
  { "id": "kh244", "name": "Yongli H6", "price": 1700, "priceTier2": 1820, "priceTier3": 2040 },
  { "id": "kh245", "name": "Yongli H8", "price": 2540, "priceTier2": 2720, "priceTier3": 3050 },
  { "id": "kh246", "name": "KH-LT40", "price": 250, "priceTier2": 270, "priceTier3": 280 },
  { "id": "kh247", "name": "KH-LT50", "price": 260, "priceTier2": 280, "priceTier3": 290 },
  { "id": "kh248", "name": "KH-LT60", "price": 390, "priceTier2": 410, "priceTier3": 430 },
  { "id": "kh249", "name": "5030/6040支架", "price": 190, "priceTier2": 190, "priceTier3": 190 },
  { "id": "kh250", "name": "7050支架", "price": 250, "priceTier2": 250, "priceTier3": 250 },
  { "id": "kh251", "name": "9060/1060支架", "price": 370, "priceTier2": 370, "priceTier3": 370 },
  { "id": "kh252", "name": "1080支架", "price": 420, "priceTier2": 420, "priceTier3": 420 },
  { "id": "kh253", "name": "1490/1310支架", "price": 500, "priceTier2": 500, "priceTier3": 500 },
  { "id": "kh254", "name": "5030蜂窝或刀条", "price": 100, "priceTier2": 107, "priceTier3": 120 },
  { "id": "kh255", "name": "6040蜂窝或刀条", "price": 120, "priceTier2": 128, "priceTier3": 144 },
  { "id": "kh256", "name": "7050蜂窝或刀条", "price": 150, "priceTier2": 161, "priceTier3": 180 },
  { "id": "kh257", "name": "9060蜂窝或刀条", "price": 200, "priceTier2": 214, "priceTier3": 240 },
  { "id": "kh258", "name": "1060蜂窝或刀条", "price": 250, "priceTier2": 268, "priceTier3": 300 },
  { "id": "kh259", "name": "1080蜂窝或刀条", "price": 300, "priceTier2": 321, "priceTier3": 360 },
  { "id": "kh260", "name": "1390蜂窝或刀条", "price": 350, "priceTier2": 375, "priceTier3": 420 },
  { "id": "kh261", "name": "1490蜂窝或刀条", "price": 400, "priceTier2": 428, "priceTier3": 480 },
  { "id": "kh262", "name": "1610蜂窝或刀条", "price": 450, "priceTier2": 482, "priceTier3": 540 },
  { "id": "kh263", "name": "1325蜂窝或刀条", "price": 1000, "priceTier2": 1070, "priceTier3": 1200 },
  { "id": "kh264", "name": "双头100/130W", "price": 2500, "priceTier2": 2500, "priceTier3": 2500 },
  { "id": "kh265", "name": "双头150W", "price": 3000, "priceTier2": 3000, "priceTier3": 3000 },
  { "id": "kh266", "name": "双头200W", "price": 5000, "priceTier2": 5000, "priceTier3": 5000 },
  { "id": "kh267", "name": "双头300W", "price": 7500, "priceTier2": 7500, "priceTier3": 7500 },
  { "id": "kh268", "name": "雕刻机-卡盘旋转轴(普通57两相电机)", "price": 720, "priceTier2": 770, "priceTier3": 870 },
  { "id": "kh269", "name": "雕刻机-卡盘旋转轴(雷赛三相电机)", "price": 770, "priceTier2": 830, "priceTier3": 930 },
  { "id": "kh270", "name": "雕刻机-铝棒旋转轴(42电机)", "price": 400, "priceTier2": 430, "priceTier3": 480 },
  { "id": "kh271", "name": "雕刻机-铝棒旋转轴(普通57两相电机)", "price": 410, "priceTier2": 440, "priceTier3": 500 },
  { "id": "kh272", "name": "雕刻机-四轮旋转轴(普通57两相电机)", "price": 770, "priceTier2": 830, "priceTier3": 924 },
  { "id": "kh273", "name": "雕刻机-四轮旋转轴(雷赛三相57电机)", "price": 820, "priceTier2": 880, "priceTier3": 990 },
  { "id": "kh274", "name": "刻章机-铝棒旋转轴(42电机)", "price": 400, "priceTier2": 430, "priceTier3": 480 },
  { "id": "kh275", "name": "打标机-D80卡盘旋转轴(雷赛两相驱动、普通电机)", "price": 720, "priceTier2": 770, "priceTier3": 870 },
  { "id": "kh276", "name": "打标机-四轮旋转轴(雷赛两相驱动、普通电机)", "price": 870, "priceTier2": 930, "priceTier3": 1050 },
  { "id": "kh277", "name": "打标机-大戒指旋转轴(雷赛两相驱动、普通电机)", "price": 720, "priceTier2": 770, "priceTier3": 870 },
  { "id": "kh278", "name": "打标机-大戒指旋转轴(雷赛三相驱动电机)", "price": 970, "priceTier2": 1040, "priceTier3": 1170 },
  { "id": "kh279", "name": "打标机-小戒指旋转轴(雷赛两相驱动、普通电机)", "price": 640, "priceTier2": 690, "priceTier3": 770 },
  { "id": "kh280", "name": "打标机-打笔转盘旋转轴(雷赛两相驱动、普通电机)", "price": 1630, "priceTier2": 1750, "priceTier3": 1960 },
  { "id": "kh281", "name": "打标机-小铝棒旋转轴(雷赛两相驱动、普通电机)", "price": 590, "priceTier2": 631, "priceTier3": 708 },
  { "id": "kh282", "name": "打标机-D160卡盘旋转轴(雷赛两相驱动、普通电机)", "price": 2000, "priceTier2": 2150, "priceTier3": 2400 },
  { "id": "kh283", "name": "打标机打标机锡箔纸夹具(小号)(南方)", "price": 410, "priceTier2": 440, "priceTier3": 500 },
  { "id": "kh284", "name": "打标机打标机锡箔纸夹具(大号)(聊城)", "price": 600, "priceTier2": 830, "priceTier3": 930 },
  { "id": "kh285", "name": "打标机锡箔纸夹具(小号)(聊城)", "price": 360, "priceTier2": 400, "priceTier3": 440 },
  { "id": "kh286", "name": "打标机二维工作台", "price": 620, "priceTier2": 642, "priceTier3": 720 },
  { "id": "kh287", "name": "打标机三维工作台", "price": 800, "priceTier2": 860, "priceTier3": 960 },
  { "id": "kh288", "name": "打标机一维工作台", "price": 510, "priceTier2": 550, "priceTier3": 620 },
  { "id": "kh289", "name": "汉双场镜70*70", "price": 210, "priceTier2": 230, "priceTier3": 260 },
  { "id": "kh290", "name": "汉双场镜110/150/175/200", "price": 230, "priceTier2": 250, "priceTier3": 280 },
  { "id": "kh291", "name": "汉双场镜300", "price": 410, "priceTier2": 440, "priceTier3": 500 },
  { "id": "kh292", "name": "汉双场镜400", "price": 660, "priceTier2": 710, "priceTier3": 800 },
  { "id": "kh293", "name": "南京波长场镜70", "price": 260, "priceTier2": 280, "priceTier3": 320 },
  { "id": "kh294", "name": "南京波长场镜110/150/175/200", "price": 280, "priceTier2": 300, "priceTier3": 340 },
  { "id": "kh295", "name": "南京波长场镜300", "price": 1370, "priceTier2": 1470, "priceTier3": 1650 },
  { "id": "kh296", "name": "金海创SG7210光纤振镜", "price": 2740, "priceTier2": 2940, "priceTier3": 3300 },
  { "id": "kh297", "name": "金海创RC1001光纤振镜", "price": 870, "priceTier2": 930, "priceTier3": 1050 },
  { "id": "kh298", "name": "金海创RC1001光纤振镜(石英)", "price": 1000, "priceTier2": 1070, "priceTier3": 1200 },
  { "id": "kh299", "name": "金海创RC7110光纤振镜", "price": 1170, "priceTier2": 1260, "priceTier3": 1410 },
  { "id": "kh300", "name": "金海创SG7110光纤振镜", "price": 1270, "priceTier2": 1360, "priceTier3": 1530 },
  { "id": "kh301", "name": "金海创SG7110光纤振镜(石英)", "price": 1400, "priceTier2": 1500, "priceTier3": 1680 },
  { "id": "kh302", "name": "金海创AF2206光纤振镜(自动对焦)", "price": 3050, "priceTier2": 3270, "priceTier3": 3660 },
  { "id": "kh303", "name": "金海创AF7110光纤振镜(自动对焦)", "price": 3710, "priceTier2": 3970, "priceTier3": 4460 },
  { "id": "kh304", "name": "12透镜", "price": 40, "priceTier2": 43, "priceTier3": 48 },
  { "id": "kh305", "name": "18透镜", "price": 80, "priceTier2": 86, "priceTier3": 96 },
  { "id": "kh306", "name": "20透镜（进口材料）", "price": 70, "priceTier2": 75, "priceTier3": 84 },
  { "id": "kh307", "name": "25透镜（进口材料）", "price": 230, "priceTier2": 246, "priceTier3": 276 },
  { "id": "kh308", "name": "（贰陆）20透镜（进口）", "price": 170, "priceTier2": 182, "priceTier3": 204 },
  { "id": "kh309", "name": "20反镜", "price": 20, "priceTier2": 21, "priceTier3": 24 },
  { "id": "kh310", "name": "25反镜", "price": 35, "priceTier2": 37, "priceTier3": 42 },
  { "id": "kh311", "name": "30反镜（钼）", "price": 40, "priceTier2": 43, "priceTier3": 48 },
  { "id": "kh312", "name": "30反镜（硅-镀金）", "price": 50, "priceTier2": 54, "priceTier3": 60 },
  { "id": "kh313", "name": "神州易刻主板加密狗", "price": 240, "priceTier2": 257, "priceTier3": 288 },
  { "id": "kh314", "name": "泰智主板/面板一套（型号不确定有客户要再确认）", "price": 1000, "priceTier2": 1070, "priceTier3": 1200 },
  { "id": "kh315", "name": "泰智A1主板", "price": 800, "priceTier2": 856, "priceTier3": 960 },
  { "id": "kh316", "name": "", "price": 0, "priceTier2": 0, "priceTier3": 0 },
  { "id": "kh317", "name": "40W激光电源", "price": 145, "priceTier2": 155, "priceTier3": 174 },
  { "id": "kh318", "name": "50W激光电源", "price": 150, "priceTier2": 161, "priceTier3": 180 },
  { "id": "kh319", "name": "60W激光电源", "price": 280, "priceTier2": 300, "priceTier3": 336 },
  { "id": "kh320", "name": "60W激光电源（液晶）", "price": 330, "priceTier2": 353, "priceTier3": 396 },
  { "id": "kh321", "name": "80W激光电源", "price": 290, "priceTier2": 310, "priceTier3": 348 },
  { "id": "kh322", "name": "80W激光电源（液晶）", "price": 340, "priceTier2": 364, "priceTier3": 408 },
  { "id": "kh323", "name": "100W激光电源", "price": 380, "priceTier2": 407, "priceTier3": 456 },
  { "id": "kh324", "name": "100W激光电源（液晶）", "price": 430, "priceTier2": 460, "priceTier3": 516 },
  { "id": "kh325", "name": "100W激光电源（隔离）（折叠管、双拼管、多高压端）", "price": 480, "priceTier2": 514, "priceTier3": 576 },
  { "id": "kh326", "name": "150W激光电源", "price": 600, "priceTier2": 642, "priceTier3": 720 },
  { "id": "kh327", "name": "150W激光电源（液晶）", "price": 650, "priceTier2": 696, "priceTier3": 780 },
  { "id": "kh328", "name": "150W激光电源（隔离）（折叠管、双拼管、多高压端）", "price": 600, "priceTier2": 0, "priceTier3": 0 },
  { "id": "kh329", "name": "150W激光电源（稳压）常用与热刺W8", "price": 655, "priceTier2": 701, "priceTier3": 786 },
  { "id": "kh330", "name": "150W激光电源（稳压）（液晶）常用与热刺W8", "price": 705, "priceTier2": 754, "priceTier3": 846 },
  { "id": "kh331", "name": "永利 × 激光电源 × YL-HSP200 × 220V × W", "price": 1000, "priceTier2": 1070, "priceTier3": 1200 },
  { "id": "kh332", "name": "永利 × 激光电源 × YL-U1×80-100W", "price": 550, "priceTier2": 590, "priceTier3": 660 },
  { "id": "kh333", "name": "永利 × 激光电源 × YL-U2×130-150W", "price": 770, "priceTier2": 825, "priceTier3": 924 },
  { "id": "kh334", "name": "睿达主板/面板一套", "price": 1850, "priceTier2": 1980, "priceTier3": 2220 },
  { "id": "kh335", "name": "睿达RDC6445主板", "price": 1500, "priceTier2": 1605, "priceTier3": 1800 },
  { "id": "kh336", "name": "睿达RDC6445面板", "price": 600, "priceTier2": 642, "priceTier3": 720 },
  { "id": "kh337", "name": "睿达RDC6445GT5面板", "price": 800, "priceTier2": 856, "priceTier3": 960 },
  { "id": "kh338", "name": "睿达RDC6445GT5一套", "price": 1900, "priceTier2": 2033, "priceTier3": 2280 },
  { "id": "kh339", "name": "睿达RDC6445GT5主板", "price": 1600, "priceTier2": 1712, "priceTier3": 1920 },
  { "id": "kh340", "name": "睿达RDC8445一套", "price": 1850, "priceTier2": 1980, "priceTier3": 2220 },
  { "id": "kh341", "name": "睿达RDC8445主板", "price": 1500, "priceTier2": 1605, "priceTier3": 1800 },
  { "id": "kh342", "name": "睿达RDC8445面板", "price": 600, "priceTier2": 642, "priceTier3": 720 },
  { "id": "kh343", "name": "睿达RDV6445（CCD）", "price": 4000, "priceTier2": 4280, "priceTier3": 4800 },
  { "id": "kh344", "name": "M3主板", "price": 120, "priceTier2": 128, "priceTier3": 144 },
  { "id": "kh345", "name": "杰美康DM542（两相）步进驱动器", "price": 110, "priceTier2": 118, "priceTier3": 132 },
  { "id": "kh346", "name": "杰美康2DM860C（两相）步进驱动器", "price": 170, "priceTier2": 182, "priceTier3": 205 },
  { "id": "kh347", "name": "（除味）烟雾净化器", "price": 2800, "priceTier2": 3000, "priceTier3": 3360 },
  { "id": "kh348", "name": "（除尘、除味）烟雾净化器", "price": 3300, "priceTier2": 3530, "priceTier3": 3960 },
  { "id": "kh349", "name": "烟雾净化器滤芯（套）", "price": 900, "priceTier2": 970, "priceTier3": 1080 },
  { "id": "kh350", "name": "红光限位开关", "price": 15, "priceTier2": 16, "priceTier3": 18 },
  { "id": "kh351", "name": "稳压器1500W（光纤切割机用）", "price": 3000, "priceTier2": 3210, "priceTier3": 3600 },
  { "id": "kh352", "name": "雕刻机气撑", "price": 10, "priceTier2": 11, "priceTier3": 12 },
  { "id": "kh353", "name": "齿轮3M-15齿", "price": 10, "priceTier2": 11, "priceTier3": 12 },
  { "id": "kh354", "name": "金海创?* 15V电源?* SG60W × 100-20V × 2A（打标机振镜电源）", "price": 100, "priceTier2": 107, "priceTier3": 120 },
  { "id": "kh355", "name": "雕刻机水保护", "price": 20, "priceTier2": 21, "priceTier3": 24 },
  { "id": "kh356", "name": "小57步进电机", "price": 90, "priceTier2": 97, "priceTier3": 108 },
  { "id": "kh357", "name": "24V5V双路供电电源", "price": 100, "priceTier2": 107, "priceTier3": 120 },
  { "id": "kh358", "name": "36V供电电源", "price": 150, "priceTier2": 161, "priceTier3": 180 },
  { "id": "kh359", "name": "钥匙开关", "price": 20, "priceTier2": 21, "priceTier3": 24 },
  { "id": "kh360", "name": "急停开关", "price": 20, "priceTier2": 21, "priceTier3": 24 },
  { "id": "kh361", "name": "（稳压器）交流稳压器 × 泰然 × svc-3kva × 110V", "price": 700, "priceTier2": 750, "priceTier3": 840 },
  { "id": "kh362", "name": "气嘴（调节阀）", "price": 10, "priceTier2": 11, "priceTier3": 12 },
  { "id": "kh363", "name": "30毫安表", "price": 10, "priceTier2": 11, "priceTier3": 12 },
  { "id": "kh364", "name": "50毫安电流表", "price": 15, "priceTier2": 16, "priceTier3": 18 },
  { "id": "kh365", "name": "铝箔烟管*2*15cm", "price": 15, "priceTier2": 16, "priceTier3": 18 },
  { "id": "kh366", "name": "蓝色橡胶烟管 1m*15cm", "price": 25, "priceTier2": 0, "priceTier3": 0 },
  { "id": "kh367", "name": "蓝色橡胶烟管 2m*15cm", "price": 50, "priceTier2": 0, "priceTier3": 0 },
  { "id": "kh368", "name": "24V继电器", "price": 40, "priceTier2": 43, "priceTier3": 48 },
  { "id": "kh369", "name": "摄像头（睿达 × 彩色相机 × USBMINI5MF Weifu）", "price": 700, "priceTier2": 750, "priceTier3": 840 },
  { "id": "kh370", "name": "睿达无线操作手柄BWK301R", "price": 730, "priceTier2": 781, "priceTier3": 876 },
  { "id": "kh371", "name": "24齿同步轮", "price": 10, "priceTier2": 11, "priceTier3": 12 },
  { "id": "kh372", "name": "硅胶管8mm*12mm（米）", "price": 3, "priceTier2": 3.2, "priceTier3": 3.6 },
  { "id": "kh373", "name": "风扇", "price": 35, "priceTier2": 38, "priceTier3": 42 },
  { "id": "kh374", "name": "柜式数据线× 1500mm 打标机附件", "price": 10, "priceTier2": 10.7, "priceTier3": 12 },
  { "id": "kh375", "name": "打标机护目镜", "price": 40, "priceTier2": 43, "priceTier3": 48 },
  { "id": "kh376", "name": "雕刻机护目镜", "price": 200, "priceTier2": 214, "priceTier3": 240 },
  { "id": "kh377", "name": "刻章机水泵（外置）", "price": 30, "priceTier2": 32, "priceTier3": 36 },
  { "id": "kh378", "name": "雕刻机水泵（外置）", "price": 50, "priceTier2": 54, "priceTier3": 60 },
  { "id": "kh379", "name": "滤波器", "price": 20, "priceTier2": 21, "priceTier3": 24 },
  { "id": "kh380", "name": "003气泵", "price": 110, "priceTier2": 118, "priceTier3": 132 },
  { "id": "kh381", "name": "004气泵", "price": 130, "priceTier2": 139, "priceTier3": 156 },
  { "id": "kh382", "name": "005气泵", "price": 160, "priceTier2": 171, "priceTier3": 192 },
  { "id": "kh383", "name": "006气泵", "price": 170, "priceTier2": 182, "priceTier3": 204 },
  { "id": "kh384", "name": "008/009气泵", "price": 270, "priceTier2": 289, "priceTier3": 324 },
  { "id": "kh385", "name": "012气泵", "price": 315, "priceTier2": 338, "priceTier3": 378 },
  { "id": "kh386", "name": "016气泵", "price": 395, "priceTier2": 423, "priceTier3": 474 },
  { "id": "kh387", "name": "开关（合力佳*急停开关）LAY38-02ZS)", "price": 15, "priceTier2": 16, "priceTier3": 18 },
  { "id": "kh388", "name": "开关（KH*大船型*常开）", "price": 3, "priceTier2": 3.2, "priceTier3": 3.6 },
  { "id": "kh389", "name": "开关（KH*小船型*常开）", "price": 3, "priceTier2": 3.2, "priceTier3": 3.6 },
  { "id": "kh390", "name": "开关（KH*升降金属按钮开关*常开）", "price": 3, "priceTier2": 3.2, "priceTier3": 3.6 },
  { "id": "kh391", "name": "小激光头", "price": 100, "priceTier2": 110, "priceTier3": 120 },
  { "id": "kh392", "name": "大激光头", "price": 200, "priceTier2": 220, "priceTier3": 240 },
  { "id": "kh393", "name": "台式电脑", "price": 2400, "priceTier2": 0, "priceTier3": 0 },
  { "id": "kh394", "name": "一体机电脑", "price": 3000, "priceTier2": 0, "priceTier3": 0 },
  { "id": "kh395", "name": "上银导轨15", "price": 187, "priceTier2": 200, "priceTier3": 225 },
  { "id": "kh396", "name": "上银导轨20", "price": 207, "priceTier2": 222, "priceTier3": 248 },
  { "id": "kh397", "name": "上银导轨25", "price": 230, "priceTier2": 246, "priceTier3": 276 },
  { "id": "kh398", "name": "上银滑块15", "price": 72, "priceTier2": 77, "priceTier3": 86 },
  { "id": "kh399", "name": "上银滑块20", "price": 89, "priceTier2": 95, "priceTier3": 107 },
  { "id": "kh400", "name": "上银滑块25", "price": 109, "priceTier2": 117, "priceTier3": 131 },
  { "id": "kh401", "name": "普通导轨15", "price": 40, "priceTier2": 43, "priceTier3": 48 },
  { "id": "kh402", "name": "普通导轨20", "price": 41, "priceTier2": 44, "priceTier3": 49 },
  { "id": "kh403", "name": "普通导轨25", "price": 54, "priceTier2": 58, "priceTier3": 65 },
  { "id": "kh404", "name": "普通导轨30", "price": 67, "priceTier2": 72, "priceTier3": 80 },
  { "id": "kh405", "name": "普通滑块15", "price": 17, "priceTier2": 18, "priceTier3": 20 },
  { "id": "kh406", "name": "普通滑块20", "price": 18, "priceTier2": 19, "priceTier3": 22 },
  { "id": "kh407", "name": "普通滑块25", "price": 22, "priceTier2": 24, "priceTier3": 26 },
  { "id": "kh408", "name": "普通滑块30", "price": 35, "priceTier2": 38, "priceTier3": 42 },
  { "id": "kh409", "name": "750漏斗", "price": 150, "priceTier2": 161, "priceTier3": 180 },
  { "id": "kh410", "name": "960漏斗", "price": 170, "priceTier2": 182, "priceTier3": 204 },
  { "id": "kh411", "name": "1390漏斗", "price": 200, "priceTier2": 214, "priceTier3": 240 },
  { "id": "kh412", "name": "1490漏斗", "price": 220, "priceTier2": 235, "priceTier3": 264 },
  { "id": "kh413", "name": "1610漏斗", "price": 300, "priceTier2": 321, "priceTier3": 360 },
  { "id": "kh414", "name": "1810漏斗", "price": 400, "priceTier2": 428, "priceTier3": 480 },
  { "id": "kh415", "name": "110v250w风机", "price": 270, "priceTier2": 289, "priceTier3": 324 },
  { "id": "kh416", "name": "110v550w风机", "price": 340, "priceTier2": 364, "priceTier3": 408 },
  { "id": "kh417", "name": "220v250w风机", "price": 195, "priceTier2": 209, "priceTier3": 234 },
  { "id": "kh418", "name": "220v550w风机", "price": 245, "priceTier2": 262, "priceTier3": 294 },
  { "id": "kh419", "name": "220v750w风机", "price": 300, "priceTier2": 321, "priceTier3": 360 }
                    // ... 保持原有其他配件数据不变
                ]
            }
        };
        // ==================== 内置数据区域结束 ====================

        // 模块化报价系统
        const KHQuoteSystem = (function() {
            // ==================== DataModule ====================
            const DataModule = {
                data: {
                    exchangeRate: 6.5,
                    machines: [],
                    products: {
                        waterCoolers: [],
                        accessories: [],
                        otherAccessories: []
                    },
                    quoteHistory: [],
                    templates: [
                        { 
                            id: 'template1', 
                            name: '通用报价模板', 
                            content: `
Model {machineModel}
packing size: {packingSize} cm
weight: {actualWeight} 
with {waterCooler} industry chiller  {standardAccessories}
==============================
Total price: {totalUSD}`,
                            lastUsed: null
                        },
                        { 
                            id: 'template2', 
                            name: '详细报价模板', 
                            content: `KH Laser 激光设备报价单
====================================
报价日期: {date}
客户信息: {customer}
====================================
设备配置详情:
1. 机器型号: {machineModel}
2. 功率规格: {machinePower}
3. 包装信息: {packingSize}
4. 重量信息: {actualWeight}
5. 冷却系统: {waterCooler}
6. 标准配件: {standardAccessories}
7. 附加配件: {otherAccessories}
====================================
价格明细:
- 机器价格: ¥{machinePrice}
- 水冷机价格: ¥{waterCoolerPrice}
- 配件总价: ¥{accessoriesPrice}
- 其他费用: ¥{otherFees}
- 运费总计: ¥{shippingTotal}
====================================
最终报价:
人民币: {totalCNY}
美元: {totalUSD}
====================================
备注: {notes}
====================================
KH Laser 销售部
联系电话: 400-XXX-XXXX
邮箱: sales@khlaser.com`,
                            lastUsed: null
                        }
                    ],
                    currentQuote: {
                        selectedSeries: '',
                        selectedModel: '',
                        selectedPower: '',
                        selectedMachine: null,
                        selectedWaterCooler: null,
                        selectedAccessories: [],
                        selectedOtherAccessories: [],
                        internationalShipping: 0,
                        domesticShipping: 0,
                        otherFees: 0,
                        quantity: 1,
                        country: 'US',
                        zipCode: '',
                        priceSource: 'tier1',
                        totalCNY: 0,
                        totalUSD: 0,
                        timestamp: null,
                        selectedTemplateId: null
                    },
                    lastBackupTime: null,
                    maxHistoryItems: 10
                },
                
                // 数据获取方法
                getExchangeRate() { return this.data.exchangeRate; },
                getMachines() { return this.data.machines; },
                getProducts() { return this.data.products; },
                getQuoteHistory() { return this.data.quoteHistory; },
                getTemplates() { return this.data.templates; },
                getCurrentQuote() { return this.data.currentQuote; },
                getLastBackupTime() { return this.data.lastBackupTime; },
                getMaxHistoryItems() { return this.data.maxHistoryItems; },
                
                // 获取所有数据（用于导出功能）
                getAllData() {
                    try {
                        // 返回数据的深拷贝，避免直接修改原始数据
                        return this.deepClone(this.data);
                    } catch (error) {
                        console.error('获取所有数据失败:', error);
                        return null;
                    }
                },
                
                // 深度克隆工具方法
                deepClone(obj) {
                    if (obj === null || typeof obj !== 'object') return obj;
                    if (obj instanceof Date) return new Date(obj.getTime());
                    if (Array.isArray(obj)) return obj.map(item => this.deepClone(item));
                    
                    const cloned = {};
                    for (const key in obj) {
                        if (obj.hasOwnProperty(key)) {
                            cloned[key] = this.deepClone(obj[key]);
                        }
                    }
                    return cloned;
                },
                
                // 机器数据操作
                addMachine(machine) { 
                    try {
                        this.data.machines.push(machine);
                        return true;
                    } catch (error) {
                        console.error('添加机器数据失败:', error);
                        return false;
                    }
                },
                clearMachines() { this.data.machines = []; },
                addMachinesBatch(machines) { 
                    try {
                        this.data.machines = this.data.machines.concat(machines);
                        return true;
                    } catch (error) {
                        console.error('批量添加机器数据失败:', error);
                        return false;
                    }
                },
                
                // 机器信息识别优化：支持数字、英文字母及汉字组合
                getSeriesList() {
                    try {
                        const seriesSet = new Set();
                        this.data.machines.forEach(machine => {
                            if (machine.series) seriesSet.add(machine.series);
                        });
                        return Array.from(seriesSet).sort();
                    } catch (error) {
                        console.error('获取系列列表失败:', error);
                        return [];
                    }
                },
                
                getModelsBySeries(series) {
                    try {
                        const models = new Set();
                        this.data.machines.forEach(machine => {
                            if (machine.series === series && machine.model) models.add(machine.model);
                        });
                        return Array.from(models).sort();
                    } catch (error) {
                        console.error('获取型号列表失败:', error);
                        return [];
                    }
                },
                
                getPowersByModel(model) {
                    try {
                        const powers = [];
                        this.data.machines.forEach(machine => {
                            if (machine.model === model) {
                                powers.push({
                                    power: machine.power,
                                    price: machine.price || 0,
                                    priceTier2: machine.priceTier2 || machine.price || 0,
                                    priceTier3: machine.priceTier3 || machine.price || 0,
                                    packingSize: machine.packingSize || '',
                                    cbm: machine.cbm || 0,
                                    volumeWeight: machine.volumeWeight || 0,
                                    actualWeight: machine.actualWeight || 0
                                });
                            }
                        });
                        return powers.sort((a, b) => {
                            // 优化排序：支持数字和单位的混合排序
                            const aPower = Utils.extractNumberFromPowerString(a.power);
                            const bPower = Utils.extractNumberFromPowerString(b.power);
                            return aPower - bPower;
                        });
                    } catch (error) {
                        console.error('获取功率列表失败:', error);
                        return [];
                    }
                },
                

                
                getMachineBySeriesModelPower(series, model, power) {
                    try {
                        return this.data.machines.find(machine => 
                            machine.series === series && 
                            machine.model === model && 
                            machine.power === power
                        );
                    } catch (error) {
                        console.error('查找机器失败:', error);
                        return null;
                    }
                },
                
                // 产品数据操作
                addProduct(productType, productData) {
                    try {
                        const products = this.data.products;
                        const id = `${productType}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        
                        const newProduct = {
                            id,
                            name: productData.name,
                            model: productData.model || '',
                            price: parseFloat(productData.price) || 0,
                            priceTier2: parseFloat(productData.priceTier2) || 0,
                            priceTier3: parseFloat(productData.priceTier3) || 0
                        };
                        
                        if (productType === 'waterCooler') {
                            products.waterCoolers.push(newProduct);
                        } else if (productType === 'accessory') {
                            products.accessories.push(newProduct);
                        } else if (productType === 'otherAccessory') {
                            products.otherAccessories.push(newProduct);
                        }
                        
                        return id;
                    } catch (error) {
                        console.error('添加产品失败:', error);
                        return null;
                    }
                },
                
                updateProduct(productId, productData) {
                    try {
                        const products = this.data.products;
                        let productFound = false;
                        
                        ['waterCoolers', 'accessories', 'otherAccessories'].forEach(category => {
                            const index = products[category].findIndex(p => p.id === productId);
                            if (index !== -1) {
                                products[category][index] = { ...products[category][index], ...productData };
                                productFound = true;
                            }
                        });
                        
                        return productFound;
                    } catch (error) {
                        console.error('更新产品失败:', error);
                        return false;
                    }
                },
                
                deleteProduct(productId) {
                    try {
                        const products = this.data.products;
                        let deleted = false;
                        
                        ['waterCoolers', 'accessories', 'otherAccessories'].forEach(category => {
                            const index = products[category].findIndex(p => p.id === productId);
                            if (index !== -1) {
                                products[category].splice(index, 1);
                                deleted = true;
                            }
                        });
                        
                        return deleted;
                    } catch (error) {
                        console.error('删除产品失败:', error);
                        return false;
                    }
                },
                
                // 模板操作
                addTemplate(templateData) {
                    try {
                        const id = `template_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        const newTemplate = { 
                            id, 
                            name: templateData.name, 
                            content: templateData.content,
                            lastUsed: null
                        };
                        this.data.templates.push(newTemplate);
                        return id;
                    } catch (error) {
                        console.error('添加模板失败:', error);
                        return null;
                    }
                },
                
                updateTemplate(templateId, templateData) {
                    try {
                        const index = this.data.templates.findIndex(t => t.id === templateId);
                        if (index !== -1) {
                            this.data.templates[index] = { ...this.data.templates[index], ...templateData };
                            return true;
                        }
                        return false;
                    } catch (error) {
                        console.error('更新模板失败:', error);
                        return false;
                    }
                },
                
                deleteTemplate(templateId) {
                    try {
                        const index = this.data.templates.findIndex(t => t.id === templateId);
                        if (index !== -1) {
                            this.data.templates.splice(index, 1);
                            return true;
                        }
                        return false;
                    } catch (error) {
                        console.error('删除模板失败:', error);
                        return false;
                    }
                },
                
                selectTemplate(templateId) {
                    try {
                        const template = this.data.templates.find(t => t.id === templateId);
                        if (template) {
                            template.lastUsed = new Date().toISOString();
                            this.data.currentQuote.selectedTemplateId = templateId;
                            return true;
                        }
                        return false;
                    } catch (error) {
                        console.error('选择模板失败:', error);
                        return false;
                    }
                },
                
                getSelectedTemplate() {
                    try {
                        if (this.data.currentQuote.selectedTemplateId) {
                            return this.data.templates.find(t => t.id === this.data.currentQuote.selectedTemplateId);
                        }
                        return null;
                    } catch (error) {
                        console.error('获取模板失败:', error);
                        return null;
                    }
                },
                
                // 修复：使用深拷贝保存当前报价到历史记录
                saveCurrentQuoteToHistory() {
                    try {
                        // 使用深拷贝确保数据独立性
                        const currentQuote = this.deepClone(this.data.currentQuote);
                        
                        // 生成历史记录ID
                        const historyId = `quote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        
                        // 创建独立的深拷贝历史记录项
                        const historyItem = {
                            id: historyId,
                            timestamp: new Date().toISOString(),
                            quoteNumber: QuoteModule.generateQuoteNumber(),
                            // 深拷贝所有报价数据
                            selectedSeries: currentQuote.selectedSeries,
                            selectedModel: currentQuote.selectedModel,
                            selectedPower: currentQuote.selectedPower,
                            selectedMachine: currentQuote.selectedMachine,
                            selectedWaterCooler: currentQuote.selectedWaterCooler,
                            selectedAccessories: currentQuote.selectedAccessories,
                            selectedOtherAccessories: currentQuote.selectedOtherAccessories,
                            internationalShipping: currentQuote.internationalShipping,
                            domesticShipping: currentQuote.domesticShipping,
                            otherFees: currentQuote.otherFees,
                            quantity: currentQuote.quantity,
                            country: currentQuote.country,
                            zipCode: currentQuote.zipCode,
                            priceSource: currentQuote.priceSource,
                            totalCNY: currentQuote.totalCNY,
                            totalUSD: currentQuote.totalUSD,
                            timestamp: currentQuote.timestamp,
                            selectedTemplateId: currentQuote.selectedTemplateId
                        };
                        
                        // 添加到历史记录的开头（最新的在最前面）
                        this.data.quoteHistory.unshift(historyItem);
                        
                        // 限制历史记录最多10条
                        if (this.data.quoteHistory.length > this.data.maxHistoryItems) {
                            this.data.quoteHistory = this.data.quoteHistory.slice(0, this.data.maxHistoryItems);
                        }
                        
                        // 保存到本地存储
                        this.saveToLocalStorage();
                        
                        return historyItem;
                    } catch (error) {
                        console.error('保存报价到历史记录失败:', error);
                        throw new Error('保存报价失败: ' + error.message);
                    }
                },
                

                
                // 新增：清除所有历史记录
                clearQuoteHistory() {
                    try {
                        this.data.quoteHistory = [];
                        this.saveToLocalStorage();
                        return true;
                    } catch (error) {
                        console.error('清除历史记录失败:', error);
                        return false;
                    }
                },
                
                // 新增：根据ID获取历史报价
                getQuoteHistoryById(quoteId) {
                    try {
                        return this.data.quoteHistory.find(quote => quote.id === quoteId);
                    } catch (error) {
                        console.error('获取历史报价失败:', error);
                        return null;
                    }
                },
                
                // 更新数据
                updateExchangeRate(newRate) { 
                    try {
                        if (newRate <= 0) {
                            throw new Error('汇率必须大于0');
                        }
                        if (newRate > 100) {
                            throw new Error('汇率值异常，请检查');
                        }
                        this.data.exchangeRate = newRate;
                        return true;
                    } catch (error) {
                        console.error('更新汇率失败:', error);
                        throw error;
                    }
                },
                
                updateCurrentQuote(updates) {
                    try {
                        this.data.currentQuote = { ...this.data.currentQuote, ...updates, timestamp: new Date().toISOString() };
                        return true;
                    } catch (error) {
                        console.error('更新报价失败:', error);
                        return false;
                    }
                },
                
                // 数据持久化
                saveToLocalStorage() {
                    try {
                        const dataToSave = {
                            exchangeRate: this.data.exchangeRate,
                            machines: this.data.machines,
                            products: this.data.products,
                            quoteHistory: this.data.quoteHistory,
                            templates: this.data.templates,
                            lastBackupTime: this.data.lastBackupTime,
                            currentQuote: this.data.currentQuote,
                            maxHistoryItems: this.data.maxHistoryItems
                        };
                        localStorage.setItem('khLaserQuoteData', JSON.stringify(dataToSave));
                        return true;
                    } catch (error) {
                        console.error('保存到本地存储失败:', error);
                        return false;
                    }
                },
                
                loadFromLocalStorage() {
                    try {
                        const savedData = localStorage.getItem('khLaserQuoteData');
                        if (savedData) {
                            const parsedData = JSON.parse(savedData);
                            // 优先使用本地存储的数据
                            this.data.exchangeRate = parsedData.exchangeRate || this.data.exchangeRate;
                            this.data.machines = parsedData.machines || [];
                            this.data.products = parsedData.products || this.data.products;
                            this.data.quoteHistory = parsedData.quoteHistory || [];
                            this.data.templates = parsedData.templates || this.data.templates;
                            this.data.lastBackupTime = parsedData.lastBackupTime || null;
                            this.data.maxHistoryItems = parsedData.maxHistoryItems || 10;
                            // 重要：不恢复currentQuote，始终使用全新currentQuote
                            return true;
                        } else {
                            // 如果没有本地存储数据，则使用内置的默认数据
                            this.loadDefaultData();
                            return true;
                        }
                    } catch (error) {
                        console.error('加载本地数据失败:', error);
                        // 加载失败时也使用内置数据
                        this.loadDefaultData();
                        return false;
                    }
                },
                
                // 新增：加载默认数据
                loadDefaultData() {
                    try {
                        // 使用内置的DEFAULT_DATA
                        this.data.machines = [...DEFAULT_DATA.machines];
                        this.data.products.waterCoolers = [...DEFAULT_DATA.products.waterCoolers];
                        this.data.products.accessories = [...DEFAULT_DATA.products.accessories];
                        this.data.products.otherAccessories = [...DEFAULT_DATA.products.otherAccessories];
                        return true;
                    } catch (error) {
                        console.error('加载默认数据失败:', error);
                        return false;
                    }
                },
                
                // 备份和恢复
                backupData() {
                    try {
                        const dataToBackup = {
                            exchangeRate: this.data.exchangeRate,
                            machines: this.data.machines,
                            products: this.data.products,
                            quoteHistory: this.data.quoteHistory,
                            templates: this.data.templates,
                            backupDate: new Date().toISOString(),
                            systemVersion: '2.6.1'
                        };
                        
                        this.data.lastBackupTime = new Date().toISOString();
                        this.saveToLocalStorage();
                        return JSON.stringify(dataToBackup, null, 2);
                    } catch (error) {
                        console.error('备份数据失败:', error);
                        throw new Error('备份数据失败: ' + error.message);
                    }
                },
                
                restoreData(backupData) {
                    try {
                        const parsedData = JSON.parse(backupData);
                        if (!parsedData.machines || !parsedData.products || !parsedData.templates) {
                            throw new Error('备份数据格式不正确');
                        }
                        
                        this.data.exchangeRate = parsedData.exchangeRate || this.data.exchangeRate;
                        this.data.machines = parsedData.machines || [];
                        this.data.products = parsedData.products || this.data.products;
                        this.data.quoteHistory = parsedData.quoteHistory || [];
                        this.data.templates = parsedData.templates || this.data.templates;
                        this.data.lastBackupTime = new Date().toISOString();
                        this.saveToLocalStorage();
                        return true;
                    } catch (error) {
                        console.error('恢复数据失败:', error);
                        throw new Error('恢复数据失败: ' + error.message);
                    }
                },
                
                // 数据统计
                getDataStats() {
                    try {
                        return {
                            machines: this.data.machines.length,
                            waterCoolers: this.data.products.waterCoolers.length,
                            accessories: this.data.products.accessories.length,
                            otherAccessories: this.data.products.otherAccessories.length,
                            templates: this.data.templates.length,
                            history: this.data.quoteHistory.length,
                            maxHistory: this.data.maxHistoryItems
                        };
                    } catch (error) {
                        console.error('获取数据统计失败:', error);
                        return { machines: 0, waterCoolers: 0, accessories: 0, otherAccessories: 0, templates: 0, history: 0, maxHistory: 10 };
                    }
                }
            };
            
            // ==================== HistoryModule ====================
            // 历史记录操作代理层，所有方法委托给 DataModule，保持数据源唯一
            const HistoryModule = {
                // 获取所有历史记录
                getAll() {
                    return DataModule.getQuoteHistory();
                },

                // 根据 ID 获取单条记录
                getById(quoteId) {
                    return DataModule.getQuoteHistoryById(quoteId);
                },

                // 保存当前报价到历史记录
                saveCurrentQuote() {
                    return DataModule.saveCurrentQuoteToHistory();
                },

                // 清除所有历史记录
                clearAll() {
                    return DataModule.clearQuoteHistory();
                },

                // 获取最近一条记录
                getLatest() {
                    const history = this.getAll();
                    return history.length > 0 ? history[0] : null;
                }
            };
            
            // ==================== NotificationModule ====================
            const NotificationModule = {
                showNotification(title, message, type = 'info', duration = 3000) {
                    try {
                        const container = document.getElementById('notificationContainer');
                        if (!container) return;
                        
                        const notification = document.createElement('div');
                        notification.className = `notification notification-${type}`;
                        
                        const iconMap = {
                            success: 'fas fa-check-circle',
                            warning: 'fas fa-exclamation-triangle',
                            danger: 'fas fa-times-circle',
                            info: 'fas fa-info-circle'
                        };
                        
                        // 内联HTML转义逻辑
                        const safeHtml = (text) => {
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML;
                        };
                        
                        notification.innerHTML = `
                            <i class="notification-icon ${iconMap[type] || iconMap.info}"></i>
                            <div class="notification-content">
                                <div class="notification-title">${safeHtml(title)}</div>
                                <div class="notification-message">${safeHtml(message)}</div>
                            </div>
                            <button class="notification-close">&times;</button>
                        `;
                        
                        container.appendChild(notification);
                        
                        const closeBtn = notification.querySelector('.notification-close');
                        closeBtn.addEventListener('click', () => this.removeNotification(notification));
                        
                        if (duration > 0) {
                            setTimeout(() => this.removeNotification(notification), duration);
                        }
                        
                        return notification;
                    } catch (error) {
                        console.error('显示通知失败:', error);
                    }
                },
                
                removeNotification(notification) {
                    try {
                        if (!notification || !notification.parentNode) return;
                        
                        notification.style.animation = 'fadeOut 0.3s ease-out';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 300);
                    } catch (error) {
                        console.error('移除通知失败:', error);
                    }
                },
                
                showSuccess(message, title = '成功') {
                    return this.showNotification(title, message, 'success');
                },
                
                showWarning(message, title = '警告') {
                    return this.showNotification(title, message, 'warning');
                },
                
                showError(message, title = '错误') {
                    return this.showNotification(title, message, 'danger');
                },
                
                showInfo(message, title = '信息') {
                    return this.showNotification(title, message, 'info');
                }
            };
            
            // ==================== QuoteModule ====================
            const QuoteModule = {
                getPriceByTier(product, priceSource) {
                    return CalculationEngine.getPriceByTier(product, priceSource);
                },

                formatPrice(price) {
                    return CalculationEngine.formatPrice(price);
                },
                
                // 统一模板变量生成入口
                generateTemplateVariables(template, quoteData, products, calculated) {
                    try {
                        // 机器型号（完整型号信息）
                        let machineModel = '';
                        if (quoteData.selectedSeries && quoteData.selectedModel && quoteData.selectedPower) {
                            machineModel = `${quoteData.selectedSeries} ${quoteData.selectedModel} ${quoteData.selectedPower}`;
                        }
                        
                        // 功率参数
                        let machinePower = quoteData.selectedPower || '';
                        
                        // 打包尺寸
                        let packingSize = '-';
                        if (quoteData.selectedMachine && quoteData.selectedMachine.packingSize) {
                            packingSize = quoteData.selectedMachine.packingSize;
                        }
                        
                        // 实际重量
                        let actualWeight = '-';
                        if (quoteData.selectedMachine && quoteData.selectedMachine.actualWeight) {
                            actualWeight = `${quoteData.selectedMachine.actualWeight} kg`;
                        }
                        
                        // 水冷机选择
                        let waterCooler = '未选择';
                        if (quoteData.selectedWaterCooler) {
                            const wc = products.waterCoolers.find(w => w.id === quoteData.selectedWaterCooler);
                            if (wc) waterCooler = wc.name;
                        }
                        
                        // 标准配件选择清单
                        let standardAccessories = '无';
                        if (quoteData.selectedAccessories && quoteData.selectedAccessories.length > 0) {
                            const accessoryNames = quoteData.selectedAccessories.map(accId => {
                                const acc = products.accessories.find(a => a.id === accId);
                                return acc ? acc.name : '';
                            }).filter(name => name !== '');
                            standardAccessories = accessoryNames.join(', ');
                        }
                        
                        // 其他配件选取详情
                        let otherAccessories = '无';
                        if (quoteData.selectedOtherAccessories && quoteData.selectedOtherAccessories.length > 0) {
                            const otherAccessoryNames = quoteData.selectedOtherAccessories.map(oaccId => {
                                const oacc = products.otherAccessories.find(o => o.id === oaccId);
                                return oacc ? oacc.name : '';
                            }).filter(name => name !== '');
                            otherAccessories = otherAccessoryNames.join(', ');
                        }
                        
                        // 返回统一变量对象
                        return {
                            machineModel,
                            machinePower,
                            packingSize,
                            actualWeight,
                            waterCooler,
                            standardAccessories,
                            otherAccessories,
                            totalCNY: `¥${calculated.totalCNY}`,
                            totalUSD: `$${calculated.totalUSD}`,
                            machinePrice: calculated.machinePrice,
                            waterCoolerPrice: calculated.waterCoolerPrice,
                            accessoriesPrice: calculated.accessoriesPrice,
                            otherFees: calculated.otherFeesPrice,
                            shippingTotal: calculated.shippingTotal,
                            date: new Date().toLocaleDateString('zh-CN'),
                            customer: '客户',
                            notes: '请根据实际需求调整配置',
                            quantity: quoteData.quantity || 1
                        };
                    } catch (error) {
                        console.error('生成模板变量失败:', error);
                        return {};
                    }
                },
                
                // 生成模板替换内容
                generateTemplateContent(template, quoteData, products, calculated) {
                    try {
                        if (!template || !template.content) return '';
                        
                        let content = template.content;
                        
                        // 使用统一的变量生成器
                        const variables = this.generateTemplateVariables(template, quoteData, products, calculated);
                        
                        // 执行替换（内联正则表达式转义逻辑）
                        Object.keys(variables).forEach(key => {
                            const pattern = new RegExp(`{${key}}`, 'g');
                            content = content.replace(pattern, variables[key]);
                        });
                        
                        return content;
                    } catch (error) {
                        console.error('生成模板内容失败:', error);
                        return '生成报价单失败，请重试';
                    }
                },
                
                generateQuoteNumber() {
                    try {
                        const date = new Date();
                        const year = date.getFullYear().toString().substr(-2);
                        const month = (date.getMonth() + 1).toString().padStart(2, '0');
                        const day = date.getDate().toString().padStart(2, '0');
                        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                        return `KH-${year}${month}${day}-${random}`;
                    } catch (error) {
                        console.error('生成报价编号失败:', error);
                        return 'KH-未知编号';
                    }
                },
                
                // 安全截断字符串，避免截断中文字符
                truncateString(str, maxLength, suffix = '...') {
                    try {
                        if (!str || str.length <= maxLength) return str;
                        
                        // 处理中文字符
                        let truncated = '';
                        let length = 0;
                        
                        for (let i = 0; i < str.length; i++) {
                            const char = str[i];
                            // 判断是否是中文字符
                            const charCode = str.charCodeAt(i);
                            if (charCode > 127) {
                                length += 2; // 中文字符算2个长度
                            } else {
                                length += 1;
                            }
                            
                            if (length <= maxLength) {
                                truncated += char;
                            } else {
                                break;
                            }
                        }
                        
                        return truncated + (truncated.length < str.length ? suffix : '');
                    } catch (error) {
                        console.error('截断字符串失败:', error);
                        return str.substring(0, maxLength) + suffix;
                    }
                },
                
                // 国内运费计算函数

                
                // 预留国际运费计算函数
                calcInternationalShipping() {
                    // 本阶段不实现国际运费规则
                    return 0;
                }
            };
            
            // ==================== FormModule（纯 DOM 操作层）====================
            const FormModule = {


                /**
                 * 清空所有表单选中状态（不修改数据层）
                 * 用于重置或填充前清理
                 */
                clearFormSelections() {
                    // 系列、型号、功率下拉框重置（通过事件触发）
                    const seriesSelect = document.getElementById('seriesSelect');
                    if (seriesSelect) {
                        seriesSelect.value = '';
                        seriesSelect.dispatchEvent(new Event('change'));
                    }

                    // 水冷机选项清除
                    document.querySelectorAll('#waterCoolerOptions .radio-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('input').checked = false;
                    });

                    // 配件选项清除
                    document.querySelectorAll('#accessoryOptions .checkbox-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('input').checked = false;
                    });

                    // 其他配件选项清除（需等待派生状态渲染，此处只清除现有 DOM）
                    document.querySelectorAll('#otherAccessoryOptions .checkbox-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('input').checked = false;
                    });

                    // 费用输入框重置为默认值
                    document.getElementById('internationalShipping').value = 0;
                    document.getElementById('domesticShipping').value = 0;
                    document.getElementById('otherFees').value = 0;
                    document.getElementById('quantity').value = 1;
                    document.getElementById('country').value = 'US';
                    document.getElementById('zipCode').value = '';

                    // 省份选择重置
                    const provinceSelect = document.getElementById('provinceSelect');
                    if (provinceSelect) provinceSelect.value = '';
                    document.querySelectorAll('[data-province]').forEach(btn => {
                        btn.classList.remove('active', 'btn-primary');
                        btn.classList.add('btn-secondary');
                    });

                    // 价格来源重置为阶梯一
                    document.querySelectorAll('.price-source-option').forEach(opt => opt.classList.remove('active'));
                    const tier1Option = document.querySelector('.price-source-option[data-source="tier1"]');
                    if (tier1Option) tier1Option.classList.add('active');

                    // 隐藏机器信息
                    const machineInfoDisplay = document.getElementById('machineInfoDisplay');
                    if (machineInfoDisplay) machineInfoDisplay.style.display = 'none';

                    // 清空其他配件搜索框
                    const searchInput = document.getElementById('otherAccessoriesSearch');
                    if (searchInput) {
                        searchInput.value = '';
                        const clearBtn = document.getElementById('clearSearchBtn');
                        if (clearBtn) clearBtn.style.display = 'none';
                    }
                },

                /**
                 * 根据报价数据填充表单（纯 DOM 填充）
                 * @param {Object} quote 历史报价数据（来自 HistoryModule）
                 */
                populateForm(quote) {
                    // 1. 设置系列/型号/功率（通过事件驱动，触发级联更新）
                    if (quote.selectedSeries) {
                        const seriesSelect = document.getElementById('seriesSelect');
                        seriesSelect.value = quote.selectedSeries;
                        seriesSelect.dispatchEvent(new Event('change'));

                        if (quote.selectedModel) {
                            const modelSelect = document.getElementById('modelSelect');
                            modelSelect.value = quote.selectedModel;
                            modelSelect.dispatchEvent(new Event('change'));

                            if (quote.selectedPower) {
                                const powerSelect = document.getElementById('powerSelect');
                                powerSelect.value = quote.selectedPower;
                                powerSelect.dispatchEvent(new Event('change'));
                            }
                        }
                    }

                    // 2. 设置水冷机（先清除同类选中状态，再设置当前）
                    document.querySelectorAll('#waterCoolerOptions .radio-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('input').checked = false;
                    });
                    if (quote.selectedWaterCooler) {
                        const waterCoolerOption = document.querySelector(`.radio-option[data-value="${quote.selectedWaterCooler}"]`);
                        if (waterCoolerOption) {
                            waterCoolerOption.classList.add('selected');
                            waterCoolerOption.querySelector('input').checked = true;
                        }
                    }

                    // 3. 设置配件（多选，仅设置当前选中的）
                    document.querySelectorAll('#accessoryOptions .checkbox-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('input').checked = false;
                    });
                    if (quote.selectedAccessories && quote.selectedAccessories.length) {
                        quote.selectedAccessories.forEach(accId => {
                            const accessoryOption = document.querySelector(`.checkbox-option[data-value="${accId}"]`);
                            if (accessoryOption) {
                                accessoryOption.classList.add('selected');
                                accessoryOption.querySelector('input').checked = true;
                            }
                        });
                    }

                    // 4. 设置其他配件（通过派生状态更新，此处仅设置 data 层？但 FormModule 不碰 DataModule，所以只更新 DOM 选中状态）
                    // 注意：其他配件由派生状态管理，其渲染由 UIModule 负责。我们只更新 checkbox 状态，但需等待渲染完成
                    // 由于派生状态可能异步更新，此处先清空选中标记，稍后由 Controller 触发派生状态更新后，会自动重新渲染。
                    // 为了稳妥，我们可以先不做 DOM 操作，而是由 Controller 在填充后调用 UIModule.updateOtherAccessoriesDerivedState() 重新渲染。
                    // 因此，这里不处理其他配件的 DOM 状态，留给 Controller 后续处理。

                    // 5. 设置费用输入
                    document.getElementById('internationalShipping').value = quote.internationalShipping || 0;
                    document.getElementById('domesticShipping').value = quote.domesticShipping || 0;
                    document.getElementById('otherFees').value = quote.otherFees || 0;
                    document.getElementById('quantity').value = quote.quantity || 1;
                    if (quote.country) document.getElementById('country').value = quote.country;
                    if (quote.zipCode) document.getElementById('zipCode').value = quote.zipCode;

                    // 6. 设置价格来源
                    document.querySelectorAll('.price-source-option').forEach(opt => opt.classList.remove('active'));
                    if (quote.priceSource) {
                        const sourceOption = document.querySelector(`.price-source-option[data-source="${quote.priceSource}"]`);
                        if (sourceOption) sourceOption.classList.add('active');
                    } else {
                        const tier1Option = document.querySelector('.price-source-option[data-source="tier1"]');
                        if (tier1Option) tier1Option.classList.add('active');
                    }

                    // 7. 设置省份选择（按钮或下拉框）
                    if (quote.selectedProvince) {
                        // 尝试匹配按钮
                        const provinceBtn = document.querySelector(`[data-province="${quote.selectedProvince}"]`);
                        if (provinceBtn) {
                            document.querySelectorAll('[data-province]').forEach(btn => {
                                btn.classList.remove('active', 'btn-primary');
                                btn.classList.add('btn-secondary');
                            });
                            provinceBtn.classList.add('active', 'btn-primary');
                            provinceBtn.classList.remove('btn-secondary');
                        } else {
                            // 匹配下拉框
                            const provinceSelect = document.getElementById('provinceSelect');
                            if (provinceSelect) {
                                provinceSelect.value = quote.selectedProvince;
                            }
                        }
                    }

                    // 注意：不在这里设置模板，由 Controller 后续调用 DataModule.selectTemplate
                },

                /**
                 * 从表单收集当前数据（用于更新 DataModule）
                 * @returns {Object} 表单数据对象
                 */
                collectFormData() {
                    return {
                        selectedWaterCooler: document.querySelector('input[name="waterCooler"]:checked')?.value || null,
                        selectedAccessories: Array.from(document.querySelectorAll('#accessoryOptions input[type="checkbox"]:checked')).map(cb => cb.value),
                        internationalShipping: parseFloat(document.getElementById('internationalShipping').value) || 0,
                        domesticShipping: parseFloat(document.getElementById('domesticShipping').value) || 0,
                        otherFees: parseFloat(document.getElementById('otherFees').value) || 0,
                        quantity: parseInt(document.getElementById('quantity').value) || 1,
                        country: document.getElementById('country').value,
                        zipCode: document.getElementById('zipCode').value,
                        selectedProvince: document.getElementById('provinceValue').value,
                        priceSource: (() => {
                            const activeSource = document.querySelector('.price-source-option.active');
                            return activeSource ? activeSource.dataset.source : 'tier1';
                        })()
                    };
                }
            };
            
            // ==================== UIModule ====================
            const UIModule = {
                // 缓存的DOM元素
                cachedElements: {},
                
                // 当前选中的历史记录ID
                selectedHistoryItemId: null,
                
                // 其他配件派生状态管理
                otherAccessoriesDerivedState: {
                    // 原始数据：从DataModule获取的otherAccessories数组
                    rawData: [],
                    // 搜索过滤结果：基于原始数据过滤
                    filteredData: [],
                    // 排序结果：基于过滤结果排序（已选置顶）
                    sortedData: [],
                    // 搜索文本
                    searchText: ''
                },
                
                // DOM元素缓存初始化
                initCache() {
                    try {
                        // 缓存频繁使用的DOM元素
                        this.cachedElements = {
                            seriesSelect: document.getElementById('seriesSelect'),
                            modelSelect: document.getElementById('modelSelect'),
                            powerSelect: document.getElementById('powerSelect'),
                            exchangeRate: document.getElementById('exchangeRate'),
                            machineInfoDisplay: document.getElementById('machineInfoDisplay'),
                            cnyPrice: document.getElementById('cnyPrice'),
                            usdPrice: document.getElementById('usdPrice'),
                            quantity: document.getElementById('quantity'),
                            internationalShipping: document.getElementById('internationalShipping'),
                            domesticShipping: document.getElementById('domesticShipping'),
                            otherFees: document.getElementById('otherFees'),
                            country: document.getElementById('country'),
                            zipCode: document.getElementById('zipCode'),
                            historyList: document.getElementById('historyList'),
                            selectedTemplateInfo: document.getElementById('selectedTemplateInfo'),
                            noTemplateSelected: document.getElementById('noTemplateSelected'),
                            selectedTemplateName: document.getElementById('selectedTemplateName'),
                            selectedTemplateContent: document.getElementById('selectedTemplateContent'),
                            productDataTable: document.getElementById('productDataTable'),
                            templateList: document.getElementById('templateList'),
                            templateSelectList: document.getElementById('templateSelectList'),

                            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
                            otherAccessoriesSearch: document.getElementById('otherAccessoriesSearch'),
                            clearSearchBtn: document.getElementById('clearSearchBtn'),
                            otherAccessoryOptions: document.getElementById('otherAccessoryOptions'),
                            // 新增：历史记录面板相关元素
                            historyPanel: document.getElementById('historyPanel'),
                            historyPanelOverlay: document.getElementById('historyPanelOverlay'),
                            openHistoryPanel: document.getElementById('openHistoryPanel'),
                            closeHistoryPanel: document.getElementById('closeHistoryPanel'),
                            // 新增：费用明细显示元素
                            priceDetailMachine: document.getElementById('priceDetailMachine'),
                            priceDetailWaterCooler: document.getElementById('priceDetailWaterCooler'),
                            priceDetailAccessories: document.getElementById('priceDetailAccessories'),
                            priceDetailOtherAccessories: document.getElementById('priceDetailOtherAccessories'),
                            priceDetailInternationalShipping: document.getElementById('priceDetailInternationalShipping'),
                            priceDetailDomesticShipping: document.getElementById('priceDetailDomesticShipping'),
                            priceDetailOtherFees: document.getElementById('priceDetailOtherFees'),
                            priceDetailTotal: document.getElementById('priceDetailTotal')
                        };
                    } catch (error) {
                        console.error('初始化DOM缓存失败:', error);
                    }
                },
                
                // 安全获取DOM元素
                getElement(id) {
                    return this.cachedElements[id] || document.getElementById(id);
                },
                
                initUI() {
                    try {
                      this.initCache();
                      // 重要：加载本地存储但不恢复currentQuote
                      DataModule.loadFromLocalStorage();
                      // 初始化全新currentQuote
                      this.initNewCurrentQuote();
                      this.initExchangeRate();
                      this.initMachineSelection();
                      this.initProductOptions();
                      CalculationEngine.recalculateAll();
                      KHQuoteSystem.UIModule.renderAll(); // 新增
                      this.updateHistoryDisplay();
                      this.updateSettingsStats();
                      this.initCollapseEvents();
                      this.updateSelectedTemplateDisplay();
                      this.initOtherAccessoriesSearch();
                      this.initHistoryPanel();
                    } catch (error) {
                      console.error('初始化UI失败:', error);
                      NotificationModule.showError('初始化界面失败，请刷新页面重试');
                    }
                },
                
                // 初始化全新currentQuote
                initNewCurrentQuote() {
                    try {
                        // 创建全新的currentQuote对象
                        const newCurrentQuote = {
                            selectedSeries: '',
                            selectedModel: '',
                            selectedPower: '',
                            selectedMachine: null,
                            selectedWaterCooler: null,
                            selectedAccessories: [],
                            selectedOtherAccessories: [],
                            internationalShipping: 0,
                            domesticShipping: 0,
                            otherFees: 0,
                            quantity: 1,
                            country: 'US',
                            zipCode: '',
                            selectedProvince: '',
                            priceSource: 'tier1',
                            totalCNY: 0,
                            totalUSD: 0,
                            timestamp: new Date().toISOString(),
                            selectedTemplateId: null
                        };
                        
                        // 更新DataModule中的currentQuote
                        DataModule.updateCurrentQuote(newCurrentQuote);
                    } catch (error) {
                        console.error('初始化全新currentQuote失败:', error);
                    }
                },
                
                initExchangeRate() {
                    try {
                        const exchangeRate = DataModule.getExchangeRate();
                        this.getElement('exchangeRate').value = exchangeRate;
                    } catch (error) {
                        console.error('初始化汇率失败:', error);
                    }
                },
                
                initMachineSelection() {
                    try {
                        this.updateSeriesSelect();
                        this.bindMachineSelectionEvents();
                    } catch (error) {
                        console.error('初始化机器选择失败:', error);
                    }
                },
                
                updateSeriesSelect() {
                    try {
                        const seriesSelect = this.getElement('seriesSelect');
                        if (!seriesSelect) return;
                        
                        // 使用DocumentFragment批量操作DOM
                        const fragment = document.createDocumentFragment();
                        
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = '请选择系列';
                        fragment.appendChild(defaultOption);
                        
                        const seriesList = DataModule.getSeriesList();
                        seriesList.forEach(series => {
                            const option = document.createElement('option');
                            option.value = series;
                            option.textContent = series;
                            fragment.appendChild(option);
                        });
                        
                        // 清空并一次性添加
                        seriesSelect.innerHTML = '';
                        seriesSelect.appendChild(fragment);
                    } catch (error) {
                        console.error('更新系列选择失败:', error);
                    }
                },
                
                bindMachineSelectionEvents() {
                    try {
                        const seriesSelect = this.getElement('seriesSelect');
                        const modelSelect = this.getElement('modelSelect');
                        const powerSelect = this.getElement('powerSelect');
                        
                        seriesSelect.addEventListener('change', (e) => {
                            try {
                                const series = e.target.value;
                                
                                if (series) {
                                    modelSelect.disabled = false;
                                    
                                    // 使用DocumentFragment优化
                                    const fragment = document.createDocumentFragment();
                                    const defaultOption = document.createElement('option');
                                    defaultOption.value = '';
                                    defaultOption.textContent = '请选择型号';
                                    fragment.appendChild(defaultOption);
                                    
                                    const models = DataModule.getModelsBySeries(series);
                                    models.forEach(model => {
                                        const option = document.createElement('option');
                                        option.value = model;
                                        option.textContent = model;
                                        fragment.appendChild(option);
                                    });
                                    
                                    modelSelect.innerHTML = '';
                                    modelSelect.appendChild(fragment);
                                } else {
                                    modelSelect.disabled = true;
                                    modelSelect.innerHTML = '<option value="">请先选择系列</option>';
                                    powerSelect.disabled = true;
                                    powerSelect.innerHTML = '<option value="">请先选择型号</option>';
                                    this.hideMachineInfo();
                                }
                                
                                DataModule.updateCurrentQuote({ 
                                    selectedSeries: series,
                                    selectedModel: '',
                                    selectedPower: '',
                                    selectedMachine: null
                                });
                                CalculationEngine.recalculateAll();
                                KHQuoteSystem.UIModule.renderAll(); // 新增
                            } catch (error) {
                                console.error('处理系列选择变更失败:', error);
                                NotificationModule.showError('处理选择失败');
                            }
                        });
                        
                        modelSelect.addEventListener('change', (e) => {
                            try {
                                const series = seriesSelect.value;
                                const model = e.target.value;
                                
                                if (series && model) {
                                    powerSelect.disabled = false;
                                    
                                    // 使用DocumentFragment优化
                                    const fragment = document.createDocumentFragment();
                                    const defaultOption = document.createElement('option');
                                    defaultOption.value = '';
                                    defaultOption.textContent = '请选择功率';
                                    fragment.appendChild(defaultOption);
                                    
                                    const powers = DataModule.getPowersByModel(model);
                                    const currentQuote = DataModule.getCurrentQuote();
                                    const priceSource = currentQuote.priceSource;
                                    
                                    powers.forEach(powerData => {
                                        const option = document.createElement('option');
                                        option.value = powerData.power;
                                        
                                        let price = powerData.price || 0;
                                        
                                        if (priceSource === 'tier2' && powerData.priceTier2) price = powerData.priceTier2;
                                        else if (priceSource === 'tier3' && powerData.priceTier3) price = powerData.priceTier3;
                                        
                                        option.textContent = `${powerData.power} (¥${QuoteModule.formatPrice(price)})`;
                                        option.dataset.powerData = JSON.stringify(powerData);
                                        fragment.appendChild(option);
                                    });
                                    
                                    powerSelect.innerHTML = '';
                                    powerSelect.appendChild(fragment);
                                } else {
                                    powerSelect.disabled = true;
                                    powerSelect.innerHTML = '<option value="">请先选择型号</option>';
                                    this.hideMachineInfo();
                                }
                                
                                DataModule.updateCurrentQuote({ 
                                    selectedModel: model,
                                    selectedPower: '',
                                    selectedMachine: null
                                });
                                CalculationEngine.recalculateAll();
                                KHQuoteSystem.UIModule.renderAll(); // 新增
                            } catch (error) {
                                console.error('处理型号选择变更失败:', error);
                                NotificationModule.showError('处理选择失败');
                            }
                        });
                        
                        powerSelect.addEventListener('change', (e) => {
                            try {
                                const series = seriesSelect.value;
                                const model = modelSelect.value;
                                const power = e.target.value;
                                const selectedOption = e.target.selectedOptions[0];
                                
                                if (series && model && power) {
                                    const powerData = JSON.parse(selectedOption.dataset.powerData || '{}');
                                    const machine = DataModule.getMachineBySeriesModelPower(series, model, power);
                                    
                                    DataModule.updateCurrentQuote({ 
                                        selectedPower: power,
                                        selectedMachine: machine || { series, model, power, ...powerData }
                                    });
                                    
                                    this.showMachineInfo(powerData);
                                } else {
                                    DataModule.updateCurrentQuote({ 
                                        selectedPower: '',
                                        selectedMachine: null
                                    });
                                    this.hideMachineInfo();
                                }
                                
                                CalculationEngine.recalculateAll();
                                KHQuoteSystem.UIModule.renderAll(); // 新增
                            } catch (error) {
                                console.error('处理功率选择变更失败:', error);
                                NotificationModule.showError('处理选择失败');
                            }
                        });
                    } catch (error) {
                        console.error('绑定机器选择事件失败:', error);
                    }
                },
                
                showMachineInfo(powerData) {
                    try {
                        const display = this.getElement('machineInfoDisplay');
                        if (display) {
                            display.style.display = 'block';
                            
                            document.getElementById('packingSize').textContent = powerData.packingSize || '-';
                            document.getElementById('cbmValue').textContent = powerData.cbm || '-';
                            document.getElementById('volumeWeight').textContent = powerData.volumeWeight || '-';
                            document.getElementById('actualWeight').textContent = powerData.actualWeight || '-';
                        }
                    } catch (error) {
                        console.error('显示机器信息失败:', error);
                    }
                },
                
                hideMachineInfo() {
                    try {
                        const display = this.getElement('machineInfoDisplay');
                        if (display) {
                            display.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('隐藏机器信息失败:', error);
                    }
                },
                
                // 内部方法，用于更新所有产品价格标签
                updateAllProductPrices() {
                    try {
                        const currentQuote = DataModule.getCurrentQuote();
                        const priceSource = currentQuote.priceSource;
                        const products = DataModule.getProducts();
                        
                        // 批量更新水冷机价格显示
                        const waterCoolerOptions = document.querySelectorAll('#waterCoolerOptions .radio-option');
                        waterCoolerOptions.forEach(option => {
                            const waterCoolerId = option.dataset.value;
                            const waterCooler = products.waterCoolers.find(wc => wc.id === waterCoolerId);
                            if (waterCooler) {
                                const price = window.CalculationEngine.getUnitPriceById('waterCooler', waterCoolerId);
                                const label = option.querySelector('label');
                                const name = waterCooler.name;
                                if (label) {
                                    label.innerHTML = `${this.safeHtml(name)} <span class="product-price-display">(¥${QuoteModule.formatPrice(price)})</span>`;
                                }
                            }
                        });
                        
                        // 批量更新配件价格显示
                        const accessoryOptions = document.querySelectorAll('#accessoryOptions .checkbox-option');
                        accessoryOptions.forEach(option => {
                            const accessoryId = option.dataset.value;
                            const accessory = products.accessories.find(acc => acc.id === accessoryId);
                            if (accessory) {
                                const price = window.CalculationEngine.getUnitPriceById('accessory', accessoryId);
                                const label = option.querySelector('label');
                                const name = accessory.name;
                                if (label) {
                                    label.innerHTML = `${this.safeHtml(name)} <span class="product-price-display">(¥${QuoteModule.formatPrice(price)})</span>`;
                                }
                            }
                        });
                        
                        // 批量更新其他配件价格显示（通过新的派生状态管理）
                        // this.updateOtherAccessoriesDerivedState(); // 已移至 renderAll 方法
                        
                        // 更新功率下拉框价格显示
                        const modelSelect = this.getElement('modelSelect');
                        const powerSelect = this.getElement('powerSelect');
                        
                        if (modelSelect.value && powerSelect && powerSelect.options.length > 0) {
                            const series = this.getElement('seriesSelect').value;
                            const model = modelSelect.value;
                            const powers = DataModule.getPowersByModel(model);
                            
                            // 使用DocumentFragment优化
                            const fragment = document.createDocumentFragment();
                            const defaultOption = document.createElement('option');
                            defaultOption.value = '';
                            defaultOption.textContent = '请选择功率';
                            fragment.appendChild(defaultOption);
                            
                            powers.forEach(powerData => {
                                const option = document.createElement('option');
                                option.value = powerData.power;
                                const price = window.CalculationEngine.getUnitPriceById('machine', powerData);
                                option.textContent = `${powerData.power} (¥${QuoteModule.formatPrice(price)})`;
                                option.dataset.powerData = JSON.stringify(powerData);
                                fragment.appendChild(option);
                            });
                            
                            powerSelect.innerHTML = '';
                            powerSelect.appendChild(fragment);
                            
                            if (currentQuote.selectedPower) {
                                powerSelect.value = currentQuote.selectedPower;
                            }
                        }
                    } catch (error) {
                        console.error('更新所有产品价格失败:', error);
                    }
                },
                
                initProductOptions() {
                    try {
                        const products = DataModule.getProducts();
                        const currentQuote = DataModule.getCurrentQuote();
                        const priceSource = currentQuote.priceSource;
                        
                        // 优化水冷机选项生成
                        const waterCoolerContainer = document.getElementById('waterCoolerOptions');
                        if (waterCoolerContainer) {
                            const fragment = document.createDocumentFragment();
                            
                            products.waterCoolers.forEach(wc => {
                                const price = window.CalculationEngine.getUnitPriceById('waterCooler', wc.id);
                                const option = document.createElement('div');
                                option.className = 'radio-option';
                                option.dataset.value = wc.id;
                                option.innerHTML = `
                                    <input type="radio" name="waterCooler" id="wc_${wc.id}" value="${wc.id}">
                                    <label for="wc_${wc.id}" class="checkbox-label-wrapper">
                                        ${this.safeHtml(wc.name)}
                                        <span class="accessory-price">¥${QuoteModule.formatPrice(price)}</span>
                                    </label>
                                `;
                                fragment.appendChild(option);
                            });
                            
                            waterCoolerContainer.innerHTML = '';
                            waterCoolerContainer.appendChild(fragment);
                        }
                        
                        // 优化配件选项生成
                        const accessoryContainer = document.getElementById('accessoryOptions');
                        if (accessoryContainer) {
                            const fragment = document.createDocumentFragment();
                            
                            products.accessories.forEach(acc => {
                                const price = window.CalculationEngine.getUnitPriceById('accessory', acc.id);
                                const option = document.createElement('div');
                                option.className = 'checkbox-option';
                                option.dataset.value = acc.id;
                                option.innerHTML = `
                                    <input type="checkbox" id="acc_${acc.id}" value="${acc.id}">
                                    <label for="acc_${acc.id}" class="checkbox-label-wrapper">
                                        ${this.safeHtml(acc.name)}
                                        <span class="accessory-price">¥${QuoteModule.formatPrice(price)}</span>
                                    </label>
                                `;
                                fragment.appendChild(option);
                            });
                            
                            accessoryContainer.innerHTML = '';
                            accessoryContainer.appendChild(fragment);
                        }
                        
                        // 初始化其他配件派生状态
                        this.initOtherAccessoriesDerivedState();
                        
                        this.bindProductSelectionEvents();
                    } catch (error) {
                        console.error('初始化产品选项失败:', error);
                    }
                },
                
                // ========== 修复：其他配件派生状态管理 ==========
                
                // 初始化其他配件派生状态
                initOtherAccessoriesDerivedState() {
                    try {
                        const products = DataModule.getProducts();
                        // 1. 始终基于DataModule提供的完整列表
                        this.otherAccessoriesDerivedState.rawData = [...products.otherAccessories];
                        // 2. 初始化派生状态
                        this.updateOtherAccessoriesDerivedState();
                    } catch (error) {
                        console.error('初始化其他配件派生状态失败:', error);
                    }
                },
                
                // 内部方法，用于更新其他配件派生状态
                updateOtherAccessoriesDerivedState() {
                    try {
                        const currentQuote = DataModule.getCurrentQuote();
                        const priceSource = currentQuote.priceSource;
                        const selectedIds = new Set(currentQuote.selectedOtherAccessories || []);
                        
                        // 步骤1: 始终从原始数据开始
                        const rawData = [...this.otherAccessoriesDerivedState.rawData];
                        
                        // 步骤2: 应用搜索过滤（已选配件始终显示）
                        const searchText = this.otherAccessoriesDerivedState.searchText.toLowerCase().trim();
                        
                        // 记录搜索统计信息
                        let searchStats = {
                            totalSelected: selectedIds.size,
                            matchedSelected: 0,
                            matchedUnselected: 0,
                            notMatchedSelected: 0
                        };
                        
                        if (!searchText) {
                            // 没有搜索词：显示所有配件
                            this.otherAccessoriesDerivedState.filteredData = rawData;
                            this.otherAccessoriesDerivedState.sortedData = [...rawData].sort((a, b) => {
                                const aSelected = selectedIds.has(a.id);
                                const bSelected = selectedIds.has(b.id);
                                if (aSelected && !bSelected) return -1;
                                if (!aSelected && bSelected) return 1;
                                return 0;
                            });
                        } else {
                            // 有搜索词：
                            // 分类处理配件
                            const selectedAndMatched = []; // 已选且匹配
                            const selectedButNotMatched = []; // 已选但不匹配
                            const unselectedAndMatched = []; // 未选但匹配
                            const unselectedAndNotMatched = []; // 未选且不匹配（不显示）
                            
                            rawData.forEach(accessory => {
                                const isSelected = selectedIds.has(accessory.id);
                                const isMatched = accessory.name.toLowerCase().includes(searchText);
                                
                                if (isSelected && isMatched) {
                                    selectedAndMatched.push(accessory);
                                    searchStats.matchedSelected++;
                                } else if (isSelected && !isMatched) {
                                    selectedButNotMatched.push(accessory);
                                    searchStats.notMatchedSelected++;
                                } else if (!isSelected && isMatched) {
                                    unselectedAndMatched.push(accessory);
                                    searchStats.matchedUnselected++;
                                }
                                // 未选且不匹配的不显示
                            });
                            
                            // 合并：先显示已选配件（包括不匹配的），再显示匹配的未选配件
                            const filteredData = [
                                ...selectedAndMatched,
                                ...selectedButNotMatched,
                                ...unselectedAndMatched
                            ];
                            
                            // 排序：已选配件置顶，已选中的匹配项在最前面
                            const sortedData = [...filteredData].sort((a, b) => {
                                const aSelected = selectedIds.has(a.id);
                                const bSelected = selectedIds.has(b.id);
                                const aMatched = a.name.toLowerCase().includes(searchText);
                                const bMatched = b.name.toLowerCase().includes(searchText);
                                
                                // 1. 已选且匹配的排在最前面
                                if (aSelected && aMatched && !(bSelected && bMatched)) return -1;
                                if (!(aSelected && aMatched) && bSelected && bMatched) return 1;
                                
                                // 2. 其他已选配件
                                if (aSelected && !bSelected) return -1;
                                if (!aSelected && bSelected) return 1;
                                
                                // 3. 已选配件内部按匹配度排序
                                if (aSelected && bSelected) {
                                    if (aMatched && !bMatched) return -1;
                                    if (!aMatched && bMatched) return 1;
                                }
                                
                                return 0;
                            });
                            
                            this.otherAccessoriesDerivedState.filteredData = filteredData;
                            this.otherAccessoriesDerivedState.sortedData = sortedData;
                            this.otherAccessoriesDerivedState.searchStats = searchStats;
                        }
                        
                        // 重新渲染UI
                        this.renderOtherAccessoriesFromDerivedState();
                    } catch (error) {
                        console.error('更新其他配件派生状态失败:', error);
                    }
                },
                
                // 内部方法，用于从派生状态渲染其他配件
                renderOtherAccessoriesFromDerivedState() {
                    try {
                        const container = this.getElement('otherAccessoryOptions');
                        if (!container) return;
                        
                        const currentQuote = DataModule.getCurrentQuote();
                        const priceSource = currentQuote.priceSource;
                        const selectedIds = new Set(currentQuote.selectedOtherAccessories || []);
                        const searchText = this.otherAccessoriesDerivedState.searchText;
                        const sortedData = this.otherAccessoriesDerivedState.sortedData;
                        const searchStats = this.otherAccessoriesDerivedState.searchStats || {};
                        const rawData = this.otherAccessoriesDerivedState.rawData;
                        
                        // 清空容器
                        container.innerHTML = '';
                        
                        // 如果没有结果
                        if (sortedData.length === 0 && searchText) {
                            container.innerHTML = `
                                <div class="no-search-results">
                                    <i class="fas fa-search"></i>
                                    <p>未找到匹配的配件</p>
                                    <p style="font-size: 0.75rem; margin-top: 5px;">请尝试其他搜索词</p>
                                </div>
                            `;
                            return;
                        }
                        
                        // 创建容器用于多列布局
                        const multiColumnContainer = document.createElement('div');
                        multiColumnContainer.className = 'other-accessories-multi-column';
                        
                        // 统计已选和未选数量
                        const selectedCount = sortedData.filter(item => selectedIds.has(item.id)).length;
                        const unselectedCount = sortedData.length - selectedCount;
                        
                        // 添加搜索结果提示
                        if (searchText) {
                            const resultInfo = document.createElement('div');
                            resultInfo.className = 'search-result-info';
                            resultInfo.style.gridColumn = '1 / -1';
                            
                            let infoText = '';
                            if (searchStats.notMatchedSelected > 0) {
                                infoText = `已选配件中：${searchStats.matchedSelected || 0} 个匹配，${searchStats.notMatchedSelected} 个不匹配但已显示`;
                            } else {
                                infoText = `找到 ${sortedData.length} 个匹配项`;
                            }
                            
                            resultInfo.innerHTML = `
                                <i class="fas fa-search" style="font-size: 0.7rem;"></i>
                                ${this.safeHtml(infoText)}
                            `;
                            multiColumnContainer.appendChild(resultInfo);
                        }
                        
                        let hasSelectedTitle = false;
                        let hasUnselectedTitle = false;
                        
                        sortedData.forEach(accessory => {
                            const isSelected = selectedIds.has(accessory.id);
                            const isMatched = searchText ? accessory.name.toLowerCase().includes(searchText) : true;
                            const price = window.CalculationEngine.getUnitPriceById('otherAccessory', accessory.id);
                            
                            // 添加分组标题
                            if (isSelected && !hasSelectedTitle && selectedCount > 0) {
                                const selectedTitle = document.createElement('div');
                                selectedTitle.className = 'selected-group-title';
                                selectedTitle.style.gridColumn = '1 / -1';
                                
                                let titleText = `已选配件 (${selectedCount}个)`;
                                if (searchText && searchStats.notMatchedSelected > 0) {
                                    titleText += ` - ${searchStats.notMatchedSelected} 个不匹配搜索但已显示`;
                                }
                                
                                selectedTitle.innerHTML = `
                                    <i class="fas fa-check-circle"></i>
                                    ${this.safeHtml(titleText)}
                                `;
                                multiColumnContainer.appendChild(selectedTitle);
                                hasSelectedTitle = true;
                            } else if (!isSelected && !hasUnselectedTitle && unselectedCount > 0) {
                                const unselectedTitle = document.createElement('div');
                                unselectedTitle.className = 'unselected-group-title';
                                unselectedTitle.style.gridColumn = '1 / -1';
                                
                                let titleText = `可选配件 (${unselectedCount}个)`;
                                if (searchText) {
                                    titleText += ' - 匹配搜索词';
                                }
                                
                                unselectedTitle.innerHTML = `
                                    <i class="fas fa-list"></i>
                                    ${this.safeHtml(titleText)}
                                `;
                                multiColumnContainer.appendChild(unselectedTitle);
                                hasUnselectedTitle = true;
                            }
                            
                            // 为不匹配搜索的已选配件添加特殊标记
                            const option = document.createElement('div');
                            option.className = isSelected ? 'checkbox-option selected' : 'checkbox-option';
                            if (isSelected && searchText && !isMatched) {
                                option.classList.add('search-not-matched');
                                option.title = '此配件已选中，但不匹配当前搜索词';
                            }
                            option.dataset.value = accessory.id;
                            option.innerHTML = `
                                <input type="checkbox" id="oacc_${accessory.id}" value="${accessory.id}" ${isSelected ? 'checked' : ''}>
                                <label for="oacc_${accessory.id}" class="checkbox-label-wrapper">
                                    ${this.safeHtml(accessory.name)}
                                    ${isSelected && searchText && !isMatched ? '<i class="fas fa-info-circle" style="margin-left: 5px; color: var(--warning-color); font-size: 0.8rem;"></i>' : ''}
                                    <span class="accessory-price">¥${QuoteModule.formatPrice(price)}</span>
                                </label>
                            `;
                            multiColumnContainer.appendChild(option);
                        });
                        
                        container.appendChild(multiColumnContainer);
                        
                        // 重新绑定事件
                        this.bindOtherAccessoriesEvents();
                    } catch (error) {
                        console.error('从派生状态渲染其他配件失败:', error);
                    }
                },
                
                // 初始化其他配件搜索功能
                initOtherAccessoriesSearch() {
                    try {
                        const searchInput = this.getElement('otherAccessoriesSearch');
                        const clearBtn = this.getElement('clearSearchBtn');
                        
                        if (!searchInput || !clearBtn) return;
                        
                        // 搜索框输入事件
                        searchInput.addEventListener('input', (e) => {
                            try {
                                this.otherAccessoriesDerivedState.searchText = e.target.value;
                                // 更新派生状态（会触发重新渲染）
                                this.updateOtherAccessoriesDerivedState();
                                
                                // 显示/隐藏清空按钮
                                clearBtn.style.display = this.otherAccessoriesDerivedState.searchText.trim() ? 'block' : 'none';
                            } catch (error) {
                                console.error('处理搜索输入失败:', error);
                            }
                        });
                        
                        // 清空搜索按钮事件
                        clearBtn.addEventListener('click', () => {
                            try {
                                searchInput.value = '';
                                this.otherAccessoriesDerivedState.searchText = '';
                                // 更新派生状态（会触发重新渲染）
                                this.updateOtherAccessoriesDerivedState();
                                clearBtn.style.display = 'none';
                                searchInput.focus();
                            } catch (error) {
                                console.error('清空搜索失败:', error);
                            }
                        });
                        
                        // 回车键清空搜索
                        searchInput.addEventListener('keydown', (e) => {
                            if (e.key === 'Escape') {
                                searchInput.value = '';
                                this.otherAccessoriesDerivedState.searchText = '';
                                this.updateOtherAccessoriesDerivedState();
                                clearBtn.style.display = 'none';
                            }
                        });
                    } catch (error) {
                        console.error('初始化其他配件搜索失败:', error);
                    }
                },
                
                // 内部方法，用于绑定其他配件事件
                bindOtherAccessoriesEvents() {
                    try {
                        const container = this.getElement('otherAccessoryOptions');
                        if (!container) return;
                        
                        // 绑定点击事件
                        const options = container.querySelectorAll('.checkbox-option');
                        options.forEach(option => {
                            option.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.handleOtherAccessoryClick(option);
                            });
                            
                            const checkbox = option.querySelector('input[type="checkbox"]');
                            if (checkbox) {
                                checkbox.addEventListener('click', (e) => e.stopPropagation());
                                checkbox.addEventListener('change', (e) => {
                                    this.handleOtherAccessoryClick(option);
                                });
                            }
                        });
                    } catch (error) {
                        console.error('绑定其他配件事件失败:', error);
                    }
                },
                
                // 内部方法，处理其他配件点击
                handleOtherAccessoryClick(option) {
                    try {
                        const checkbox = option.querySelector('input[type="checkbox"]');
                        if (!checkbox) return;
                        
                        checkbox.checked = !checkbox.checked;
                        option.classList.toggle('selected');
                        
                        // 更新报价
                        this.updateOtherAccessoriesSelection();
                    } catch (error) {
                        console.error('处理其他配件点击失败:', error);
                    }
                },
                
                // 更新其他配件选择状态
                updateOtherAccessoriesSelection() {
                    try {
                        const container = this.getElement('otherAccessoryOptions');
                        if (!container) return;
                        
                        const selectedCheckboxes = container.querySelectorAll('input[type="checkbox"]:checked');
                        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                        
                        DataModule.updateCurrentQuote({
                            selectedOtherAccessories: selectedIds
                        });
                        
                        // 重要：更新派生状态（会重新计算和渲染）
                        // this.updateOtherAccessoriesDerivedState(); // 删除，renderAll 内部已调用
                        CalculationEngine.recalculateAll();
                        KHQuoteSystem.UIModule.renderAll(); // 新增
                    } catch (error) {
                        console.error('更新其他配件选择失败:', error);
                    }
                },
                
                // 安全的HTML处理
                safeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },
                
                bindProductSelectionEvents() {
                    try {
                        const handleOptionClick = (option, isCheckbox = false) => {
                            try {
                                if (isCheckbox) {
                                    const checkbox = option.querySelector('input[type="checkbox"]');
                                    if (checkbox) {
                                        checkbox.checked = !checkbox.checked;
                                        option.classList.toggle('selected');
                                        KHQuoteSystem.QuoteController.handleFormChange();
                                    }
                                } else {
                                    const radio = option.querySelector('input[type="radio"]');
                                    if (radio) {
                                        radio.checked = true;
                                        document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
                                        option.classList.add('selected');
                                        KHQuoteSystem.QuoteController.handleFormChange();
                                    }
                                }
                            } catch (error) {
                                console.error('处理选项点击失败:', error);
                            }
                        };
                        
                        document.querySelectorAll('#waterCoolerOptions .radio-option').forEach(option => {
                            option.addEventListener('click', (e) => {
                                e.stopPropagation();
                                handleOptionClick(option, false);
                            });
                            
                            const radioInput = option.querySelector('input[type="radio"]');
                            if (radioInput) {
                                radioInput.addEventListener('click', (e) => e.stopPropagation());
                                radioInput.addEventListener('change', (e) => handleOptionClick(option, false));
                            }
                        });
                        
                        document.querySelectorAll('#accessoryOptions .checkbox-option').forEach(option => {
                            option.addEventListener('click', (e) => {
                                e.stopPropagation();
                                handleOptionClick(option, true);
                            });
                            
                            const checkboxInput = option.querySelector('input[type="checkbox"]');
                            if (checkboxInput) {
                                checkboxInput.addEventListener('click', (e) => e.stopPropagation());
                                checkboxInput.addEventListener('change', (e) => handleOptionClick(option, true));
                            }
                        });
                    } catch (error) {
                        console.error('绑定产品选择事件失败:', error);
                    }
                },
                
                initCollapseEvents() {
                    try {
                        const otherAccessoriesToggle = document.getElementById('otherAccessoriesToggle');
                        const otherAccessoriesContent = document.getElementById('otherAccessoriesContent');
                        
                        if (otherAccessoriesToggle && otherAccessoriesContent) {
                            otherAccessoriesToggle.addEventListener('click', () => {
                                otherAccessoriesContent.classList.toggle('expanded');
                                const icon = otherAccessoriesToggle.querySelector('i');
                                if (otherAccessoriesContent.classList.contains('expanded')) {
                                    icon.className = 'fas fa-chevron-up';
                                } else {
                                    icon.className = 'fas fa-chevron-down';
                                }
                            });
                        }
                    } catch (error) {
                        console.error('初始化折叠事件失败:', error);
                    }
                },
                

                
                // 内部方法，用于更新模板预览
                updateSelectedTemplateDisplay() {
                    try {
                        const selectedTemplate = DataModule.getSelectedTemplate();
                        const selectedTemplateInfo = this.getElement('selectedTemplateInfo');
                        const noTemplateSelected = this.getElement('noTemplateSelected');
                        
                        if (selectedTemplate) {
                            // 生成填充后的模板内容
                            const currentQuote = DataModule.getCurrentQuote();
                            const products = DataModule.getProducts();
                            const exchangeRate = DataModule.getExchangeRate();
                            const priceSource = currentQuote.priceSource;
                            
                            // 使用统一的价格计算入口
                            const calculated = CalculationEngine.calculateFullQuote(currentQuote, products, exchangeRate, priceSource);
                            
                            const filledContent = QuoteModule.generateTemplateContent(
                                selectedTemplate, 
                                currentQuote, 
                                products, 
                                calculated
                            );
                            
                            document.getElementById('selectedTemplateName').textContent = this.safeHtml(selectedTemplate.name);
                            document.getElementById('selectedTemplateContent').textContent = filledContent;
                            
                            if (selectedTemplateInfo) selectedTemplateInfo.style.display = 'block';
                            if (noTemplateSelected) noTemplateSelected.style.display = 'none';
                        } else {
                            if (selectedTemplateInfo) selectedTemplateInfo.style.display = 'none';
                            if (noTemplateSelected) noTemplateSelected.style.display = 'block';
                        }
                    } catch (error) {
                        console.error('更新模板显示失败:', error);
                    }
                },
                

                
                // 内部方法，用于更新历史记录列表
                updateHistoryDisplay() {
                    try {
                        const history = HistoryModule.getAll();
                        const container = this.getElement('historyList');
                        const maxHistoryItems = DataModule.getMaxHistoryItems();
                        
                        if (!container) return;
                        
                        if (history.length === 0) {
                            container.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-clock"></i>
                                    <p>暂无历史报价记录</p>
                                </div>
                            `;
                            return;
                        }
                        
                        // 使用DocumentFragment优化
                        const fragment = document.createDocumentFragment();
                        
                        history.forEach(quote => {
                            const date = new Date(quote.timestamp).toLocaleString('zh-CN');
                            const totalCNY = QuoteModule.formatPrice(quote.totalCNY || 0);
                            const totalUSD = QuoteModule.formatPrice(quote.totalUSD || 0);
                            
                            const item = document.createElement('div');
                            item.className = 'history-item';
                            item.dataset.quoteId = quote.id;
                            
                            // 如果这是当前选中的历史记录，添加选中类
                            if (this.selectedHistoryItemId === quote.id) {
                                item.classList.add('selected');
                            }
                            
                            item.innerHTML = `
                                <div class="history-date">${this.safeHtml(date)} - ${this.safeHtml(quote.quoteNumber || '')}</div>
                                <div>机器: ${this.safeHtml(quote.selectedSeries || '未选择')} ${this.safeHtml(quote.selectedModel || '')} ${this.safeHtml(quote.selectedPower || '')}</div>
                                <div class="history-total">总价: ¥${totalCNY} / $${totalUSD}</div>
                            `;
                            
                            // 添加点击事件
                            item.addEventListener('click', () => {
                                this.selectHistoryItem(quote.id);
                            });
                            
                            fragment.appendChild(item);
                        });
                        
                        container.innerHTML = '';
                        container.appendChild(fragment);
                    } catch (error) {
                        console.error('更新历史记录显示失败:', error);
                    }
                },
                
                // 新增：选择历史记录项
                selectHistoryItem(quoteId) {
                    window.QuoteController.loadHistoryQuote(quoteId);
                },
                

                

                
                // 纯 DOM 重置，不涉及数据状态
                _resetFormDOM() {
                    const seriesSelect = this.getElement('seriesSelect');
                    seriesSelect.value = '';
                    seriesSelect.dispatchEvent(new Event('change'));

                    document.querySelectorAll('.radio-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('input').checked = false;
                    });
                    document.querySelectorAll('.checkbox-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('input').checked = false;
                    });

                    this.getElement('internationalShipping').value = 0;
                    this.getElement('domesticShipping').value = 0;
                    this.getElement('otherFees').value = 0;
                    this.getElement('quantity').value = 1;
                    this.getElement('country').value = 'US';
                    this.getElement('zipCode').value = '';

                    const provinceSelect = document.getElementById('provinceSelect');
                    if (provinceSelect) provinceSelect.value = '';
                    document.querySelectorAll('[data-province]').forEach(btn => {
                        btn.classList.remove('btn-primary', 'active');
                        btn.classList.add('btn-secondary');
                    });
                    
                    // 清空隐藏省份输入框
                    document.getElementById('provinceValue').value = '';

                    document.querySelectorAll('.price-source-option').forEach(opt => opt.classList.remove('active'));
                    const tier1Option = document.querySelector('.price-source-option[data-source="tier1"]');
                    if (tier1Option) tier1Option.classList.add('active');

                    const searchInput = this.getElement('otherAccessoriesSearch');
                    if (searchInput) searchInput.value = '';
                    const clearBtn = this.getElement('clearSearchBtn');
                    if (clearBtn) clearBtn.style.display = 'none';

                    this.hideMachineInfo();
                },
                
                resetForm() {
                    try {
                        this._resetFormDOM();
                        
                        // 数据重置
                        DataModule.updateCurrentQuote({
                            selectedOtherAccessories: [],
                            selectedProvince: '',
                            selectedTemplateId: null
                        });
                        
                        this.otherAccessoriesDerivedState.searchText = '';
                        this.updateOtherAccessoriesDerivedState();
                        this.updateSelectedTemplateDisplay();
                    } catch (error) {
                        console.error('重置表单失败:', error);
                    }
                },
                
                updateSettingsStats() {
                    try {
                        const stats = DataModule.getDataStats();
                        const lastBackupTime = DataModule.getLastBackupTime();
                        
                        document.getElementById('machineDataCount').textContent = `${stats.machines} 条`;
                        document.getElementById('productDataCount').textContent = `${stats.waterCoolers + stats.accessories + stats.otherAccessories} 条`;
                        document.getElementById('templateDataCount').textContent = `${stats.templates} 条`;
                        document.getElementById('historyDataCount').textContent = `${stats.history} 条`;
                        
                        if (lastBackupTime) {
                            const backupDate = new Date(lastBackupTime);
                            document.getElementById('lastBackupTime').textContent = backupDate.toLocaleString('zh-CN');
                        }
                    } catch (error) {
                        console.error('更新设置统计失败:', error);
                    }
                },
                
                updateProductDataTable() {
                    try {
                        const products = DataModule.getProducts();
                        const container = this.getElement('productDataTable');
                        
                        if (!container) return;
                        
                        let html = '<h4>现有产品数据</h4>';
                        
                        if (products.waterCoolers.length > 0) {
                            html += '<h5>水冷机</h5>';
                            html += '<table class="compact-table">';
                            html += '<thead><tr><th>名称</th><th>型号</th><th>阶梯一</th><th>阶梯二</th><th>阶梯三</th><th>操作</th></tr></thead>';
                            html += '<tbody>';
                            products.waterCoolers.forEach(wc => {
                                html += `<tr>
                                    <td>${this.safeHtml(wc.name)}</td>
                                    <td>${this.safeHtml(wc.model)}</td>
                                    <td>¥${QuoteModule.formatPrice(wc.price)}</td>
                                    <td>¥${QuoteModule.formatPrice(wc.priceTier2 || wc.price)}</td>
                                    <td>¥${QuoteModule.formatPrice(wc.priceTier3 || wc.price)}</td>
                                    <td><button class="btn btn-secondary btn-sm" onclick="KHQuoteSystem.UIModule.editProduct('${wc.id}')">编辑</button></td>
                                </tr>`;
                            });
                            html += '</tbody></table>';
                        }
                        
                        if (products.accessories.length > 0) {
                            html += '<h5 style="margin-top: 15px;">配件</h5>';
                            html += '<table class="compact-table">';
                            html += '<thead><tr><th>名称</th><th>阶梯一</th><th>阶梯二</th><th>阶梯三</th><th>操作</th></tr></thead>';
                            html += '<tbody>';
                            products.accessories.forEach(acc => {
                                html += `<tr>
                                    <td>${this.safeHtml(acc.name)}</td>
                                    <td>¥${QuoteModule.formatPrice(acc.price)}</td>
                                    <td>¥${QuoteModule.formatPrice(acc.priceTier2 || acc.price)}</td>
                                    <td>¥${QuoteModule.formatPrice(acc.priceTier3 || acc.price)}</td>
                                    <td><button class="btn btn-secondary btn-sm" onclick="KHQuoteSystem.UIModule.editProduct('${acc.id}')">编辑</button></td>
                                </tr>`;
                            });
                            html += '</tbody></table>';
                        }
                        
                        if (products.otherAccessories.length > 0) {
                            html += '<h5 style="margin-top: 15px;">其他配件</h5>';
                            html += '<table class="compact-table">';
                            html += '<thead><tr><th>名称</th><th>阶梯一</th><th>阶梯二</th><th>阶梯三</th><th>操作</th></tr></thead>';
                            html += '<tbody>';
                            products.otherAccessories.forEach(oacc => {
                                html += `<tr>
                                    <td>${this.safeHtml(oacc.name)}</td>
                                    <td>¥${QuoteModule.formatPrice(oacc.price)}</td>
                                    <td>¥${QuoteModule.formatPrice(oacc.priceTier2 || oacc.price)}</td>
                                    <td>¥${QuoteModule.formatPrice(oacc.priceTier3 || oacc.price)}</td>
                                    <td><button class="btn btn-secondary btn-sm" onclick="KHQuoteSystem.UIModule.editProduct('${oacc.id}')">编辑</button></td>
                                </tr>`;
                            });
                            html += '</tbody></table>';
                        }
                        
                        container.innerHTML = html;
                    } catch (error) {
                        console.error('更新产品数据表格失败:', error);
                    }
                },
                
                editProduct(productId) {
                    try {
                        const products = DataModule.getProducts();
                        let product = null;
                        let productType = '';
                        
                        if (products.waterCoolers.some(p => p.id === productId)) {
                            product = products.waterCoolers.find(p => p.id === productId);
                            productType = 'waterCooler';
                        } else if (products.accessories.some(p => p.id === productId)) {
                            product = products.accessories.find(p => p.id === productId);
                            productType = 'accessory';
                        } else if (products.otherAccessories.some(p => p.id === productId)) {
                            product = products.otherAccessories.find(p => p.id === productId);
                            productType = 'otherAccessory';
                        }
                        
                        if (product) {
                            document.getElementById('productType').value = productType;
                            document.getElementById('productName').value = product.name || '';
                            document.getElementById('productModel').value = product.model || '';
                            document.getElementById('productPrice').value = product.price || 0;
                            document.getElementById('productPriceTier2').value = product.priceTier2 || 0;
                            document.getElementById('productPriceTier3').value = product.priceTier3 || 0;
                            
                            document.getElementById('saveProductData').dataset.productId = productId;
                            document.getElementById('deleteProductData').dataset.productId = productId;
                        }
                    } catch (error) {
                        console.error('编辑产品失败:', error);
                        NotificationModule.showError('编辑产品失败');
                    }
                },
                
                clearProductForm() {
                    try {
                        document.getElementById('productType').value = 'waterCooler';
                        document.getElementById('productName').value = '';
                        document.getElementById('productModel').value = '';
                        document.getElementById('productPrice').value = '';
                        document.getElementById('productPriceTier2').value = '';
                        document.getElementById('productPriceTier3').value = '';
                        
                        document.getElementById('saveProductData').dataset.productId = '';
                        document.getElementById('deleteProductData').dataset.productId = '';
                    } catch (error) {
                        console.error('清空产品表单失败:', error);
                    }
                },
                
                updateTemplateList() {
                    try {
                        const templates = DataModule.getTemplates();
                        const container = this.getElement('templateList');
                        
                        if (!container) return;
                        
                        if (templates.length === 0) {
                            container.innerHTML = '<div class="empty-state"><i class="fas fa-file-alt"></i><p>暂无模板</p></div>';
                            return;
                        }
                        
                        let html = '<h4>现有模板</h4>';
                        
                        templates.forEach(template => {
                            // 使用安全的截断方法
                            const preview = QuoteModule.truncateString(template.content, 80);
                            
                            html += `
                                <div class="template-list-item">
                                    <div>
                                        <strong>${this.safeHtml(template.name)}</strong>
                                        <div style="font-size: 0.8rem; color: var(--gray-700); margin-top: 5px; max-height: 50px; overflow: hidden;">
                                            ${this.safeHtml(preview)}
                                        </div>
                                    </div>
                                    <div class="template-actions">
                                        <button class="btn btn-secondary btn-sm" onclick="KHQuoteSystem.UIModule.editTemplate('${template.id}')">编辑</button>
                                        <button class="btn btn-danger btn-sm" onclick="KHQuoteSystem.UIModule.deleteTemplate('${template.id}')">删除</button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        container.innerHTML = html;
                    } catch (error) {
                        console.error('更新模板列表失败:', error);
                    }
                },
                
                // 更新模板选择列表（用于模板选择模态框）
                updateTemplateSelectList() {
                    try {
                        const templates = DataModule.getTemplates();
                        const container = this.getElement('templateSelectList');
                        
                        if (!container) return;
                        
                        if (templates.length === 0) {
                            container.innerHTML = '<div class="empty-state"><i class="fas fa-file-alt"></i><p>暂无模板，请在系统设置中创建模板</p></div>';
                            return;
                        }
                        
                        // 使用DocumentFragment优化
                        const fragment = document.createDocumentFragment();
                        
                        templates.forEach(template => {
                            const lastUsed = template.lastUsed ? new Date(template.lastUsed).toLocaleString('zh-CN') : '从未使用';
                            const preview = QuoteModule.truncateString(template.content, 100);
                            
                            const item = document.createElement('div');
                            item.className = 'template-list-item';
                            item.innerHTML = `
                                <div>
                                    <strong>${this.safeHtml(template.name)}</strong>
                                    <div class="template-preview">
                                        ${this.safeHtml(preview)}
                                    </div>
                                    <div class="template-meta">
                                        <span>最后使用: ${this.safeHtml(lastUsed)}</span>
                                        <span>字符数: ${template.content.length}</span>
                                    </div>
                                </div>
                                <div class="template-actions">
                                    <button class="btn btn-primary btn-sm template-select-btn" data-template-id="${template.id}">选择</button>
                                </div>
                            `;
                            fragment.appendChild(item);
                        });
                        
                        container.innerHTML = '';
                        container.appendChild(fragment);
                        
                        // 绑定选择按钮事件
                        container.querySelectorAll('.template-select-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                try {
                                    const templateId = e.target.dataset.templateId;
                                    this.selectTemplate(templateId);
                                } catch (error) {
                                    console.error('选择模板失败:', error);
                                }
                            });
                        });
                    } catch (error) {
                        console.error('更新模板选择列表失败:', error);
                    }
                },
                
                selectTemplate(templateId) {
                    try {
                        const success = DataModule.selectTemplate(templateId);
                        if (success) {
                            DataModule.saveToLocalStorage();
                            this.updateSelectedTemplateDisplay();
                            this.hideModal('templateSelectModal');
                            NotificationModule.showSuccess('模板选择成功');
                        } else {
                            NotificationModule.showError('选择模板失败');
                        }
                    } catch (error) {
                        console.error('选择模板失败:', error);
                        NotificationModule.showError('选择模板失败');
                    }
                },
                
                editTemplate(templateId) {
                    try {
                        const templates = DataModule.getTemplates();
                        const template = templates.find(t => t.id === templateId);
                        
                        if (template) {
                            document.getElementById('templateName').value = template.name;
                            document.getElementById('templateContent').value = template.content;
                            
                            document.getElementById('saveTemplate').dataset.templateId = templateId;
                            document.getElementById('deleteTemplate').dataset.templateId = templateId;
                        }
                    } catch (error) {
                        console.error('编辑模板失败:', error);
                        NotificationModule.showError('编辑模板失败');
                    }
                },
                
                deleteTemplate(templateId) {
                    try {
                        if (confirm('确定要删除此模板吗？')) {
                            const success = DataModule.deleteTemplate(templateId);
                            if (success) {
                                DataModule.saveToLocalStorage();
                                this.updateTemplateList();
                                this.updateTemplateSelectList();
                                this.clearTemplateForm();
                                NotificationModule.showSuccess('模板已删除');
                            } else {
                                NotificationModule.showError('删除模板失败');
                            }
                        }
                    } catch (error) {
                        console.error('删除模板失败:', error);
                        NotificationModule.showError('删除模板失败');
                    }
                },
                
                clearTemplateForm() {
                    try {
                        document.getElementById('templateName').value = '';
                        document.getElementById('templateContent').value = '';
                        
                        document.getElementById('saveTemplate').dataset.templateId = '';
                        document.getElementById('deleteTemplate').dataset.templateId = '';
                    } catch (error) {
                        console.error('清空模板表单失败:', error);
                    }
                },
                
                // 新增：初始化历史记录面板
                initHistoryPanel() {
                    try {
                        const openHistoryPanel = this.getElement('openHistoryPanel');
                        const closeHistoryPanel = this.getElement('closeHistoryPanel');
                        const historyPanelOverlay = this.getElement('historyPanelOverlay');
                        
                        if (openHistoryPanel) {
                            openHistoryPanel.addEventListener('click', () => {
                                this.showHistoryPanel();
                            });
                        }
                        
                        if (closeHistoryPanel) {
                            closeHistoryPanel.addEventListener('click', () => {
                                this.hideHistoryPanel();
                            });
                        }
                        
                        if (historyPanelOverlay) {
                            historyPanelOverlay.addEventListener('click', () => {
                                this.hideHistoryPanel();
                            });
                        }
                    } catch (error) {
                        console.error('初始化历史记录面板失败:', error);
                    }
                },
                
                // 新增：显示历史记录面板
                showHistoryPanel() {
                    try {
                        const historyPanel = this.getElement('historyPanel');
                        const historyPanelOverlay = this.getElement('historyPanelOverlay');
                        
                        if (historyPanel) {
                            historyPanel.classList.add('active');
                        }
                        
                        if (historyPanelOverlay) {
                            historyPanelOverlay.classList.add('active');
                        }
                    } catch (error) {
                        console.error('显示历史记录面板失败:', error);
                    }
                },
                
                // 新增：隐藏历史记录面板
                hideHistoryPanel() {
                    try {
                        const historyPanel = this.getElement('historyPanel');
                        const historyPanelOverlay = this.getElement('historyPanelOverlay');
                        
                        if (historyPanel) {
                            historyPanel.classList.remove('active');
                        }
                        
                        if (historyPanelOverlay) {
                            historyPanelOverlay.classList.remove('active');
                        }
                    } catch (error) {
                        console.error('隐藏历史记录面板失败:', error);
                    }
                },
                
                showModal(modalId) {
                    try {
                        document.getElementById(modalId).style.display = 'flex';
                        
                        if (modalId === 'settingsModal') {
                            this.updateSettingsStats();
                        } else if (modalId === 'templateSelectModal') {
                            this.updateTemplateSelectList();
                        }
                    } catch (error) {
                        console.error('显示模态框失败:', error);
                    }
                },
                
                hideModal(modalId) {
                    try {
                        document.getElementById(modalId).style.display = 'none';
                    } catch (error) {
                        console.error('隐藏模态框失败:', error);
                    }
                },
                
                showLoading() {
                    try {
                        document.getElementById('loadingOverlay').style.display = 'flex';
                    } catch (error) {
                        console.error('显示加载中失败:', error);
                    }
                },
                
                hideLoading() {
                    try {
                        document.getElementById('loadingOverlay').style.display = 'none';
                    } catch (error) {
                        console.error('隐藏加载中失败:', error);
                    }
                },
                
                // 内部方法，用于从计算状态更新报价显示
                updateQuoteDisplayFromState(state) {
                    try {
                        const cnyPrice = this.getElement('cnyPrice');
                        const usdPrice = this.getElement('usdPrice');
                        
                        if (cnyPrice) cnyPrice.textContent = `¥${CalculationEngine.formatPrice(state.finalTotalCNY)}`;
                        if (usdPrice) usdPrice.textContent = `$${CalculationEngine.formatPrice(state.finalTotalUSD)}`;
                        
                        // 更新费用明细显示
                        this.updatePriceDetailsFromState(state);
                        
                        // 更新DataModule中的当前报价（保持向后兼容）
                        KHQuoteSystem.DataModule.updateCurrentQuote({
                            totalCNY: state.finalTotalCNY,
                            totalUSD: state.finalTotalUSD
                        });
                        
                    } catch (error) {
                        console.error('从状态更新UI失败:', error);
                    }
                },
                
                // 内部方法，用于更新费用明细
                updatePriceDetailsFromState(state) {
                    try {
                        const priceDetailMachine = this.getElement('priceDetailMachine');
                        const priceDetailWaterCooler = this.getElement('priceDetailWaterCooler');
                        const priceDetailAccessories = this.getElement('priceDetailAccessories');
                        const priceDetailOtherAccessories = this.getElement('priceDetailOtherAccessories');
                        const priceDetailInternationalShipping = this.getElement('priceDetailInternationalShipping');
                        const priceDetailDomesticShipping = this.getElement('priceDetailDomesticShipping');
                        const priceDetailOtherFees = this.getElement('priceDetailOtherFees');
                        const priceDetailTotal = this.getElement('priceDetailTotal');
                        
                        if (priceDetailMachine) priceDetailMachine.textContent = `¥${CalculationEngine.formatPrice(state.machinePrice)}`;
                        if (priceDetailWaterCooler) priceDetailWaterCooler.textContent = `¥${CalculationEngine.formatPrice(state.waterChillerPrice)}`;
                        if (priceDetailAccessories) priceDetailAccessories.textContent = `¥${CalculationEngine.formatPrice(state.accessoriesPrice)}`;
                        if (priceDetailOtherAccessories) priceDetailOtherAccessories.textContent = `¥${CalculationEngine.formatPrice(state.otherPartsPrice)}`;
                        if (priceDetailInternationalShipping) priceDetailInternationalShipping.textContent = `¥${CalculationEngine.formatPrice(state.internationalShipping)}`;
                        if (priceDetailDomesticShipping) priceDetailDomesticShipping.textContent = `¥${CalculationEngine.formatPrice(state.domesticShipping)}`;
                        if (priceDetailOtherFees) priceDetailOtherFees.textContent = `¥${CalculationEngine.formatPrice(state.otherFee)}`;
                        if (priceDetailTotal) priceDetailTotal.textContent = `¥${CalculationEngine.formatPrice(state.finalTotalCNY)}`;
                        
                    } catch (error) {
                        console.error('更新费用明细失败:', error);
                    }
                },
                
                // 统一渲染方法，为后续单点刷新做准备
                renderAll() {
                    // 从 CalculationEngine 获取最新状态，更新价格显示
                    const state = window.CalculationEngine.getState();
                    this.updateQuoteDisplayFromState(state);
                    
                    this.updateOtherAccessoriesDerivedState(); // 重新计算并渲染其他配件
                    this.updateAllProductPrices();             // 更新水冷机、配件、功率下拉的价格标签
                    this.updateHistoryDisplay();               // 刷新历史记录列表
                    this.updateSelectedTemplateDisplay();      // 新增：确保模板内容随报价变化刷新
                }
            };
            
            // ==================== EventModule ====================
            const EventModule = {
                init() {
                    this.setupEventListeners();
                },
                
                setupEventListeners() {
                    try {
                        // 汇率变更
                        document.getElementById('exchangeRate').addEventListener('change', (e) => {
                            try {
                                const newRate = parseFloat(e.target.value);
                                if (!isNaN(newRate) && newRate > 0) {
                                    DataModule.updateExchangeRate(newRate);
                                    DataModule.saveToLocalStorage();
                                    CalculationEngine.recalculateAll();
                                    KHQuoteSystem.UIModule.renderAll(); // 新增
                                    NotificationModule.showSuccess('汇率已更新');
                                } else {
                                    NotificationModule.showWarning('请输入有效的汇率值');
                                }
                            } catch (error) {
                                console.error('更新汇率失败:', error);
                                NotificationModule.showError('更新汇率失败: ' + error.message);
                            }
                        });
                        
                        // 价格源选择
                        document.querySelectorAll('.price-source-option').forEach(option => {
                            option.addEventListener('click', (e) => {
                                try {
                                    const source = e.target.dataset.source;
                                    document.querySelectorAll('.price-source-option').forEach(opt => opt.classList.remove('active'));
                                    e.target.classList.add('active');
                                    DataModule.updateCurrentQuote({ priceSource: source });
                                    CalculationEngine.recalculateAll();
                                    KHQuoteSystem.UIModule.renderAll(); // 新增
                                } catch (error) {
                                    console.error('选择价格源失败:', error);
                                }
                            });
                        });
                        
                        // 费用输入
                        ['internationalShipping', 'domesticShipping', 'otherFees', 'quantity'].forEach(id => {
                            const element = document.getElementById(id);
                            if (element) {
                                element.addEventListener('change', (e) => {
                                    try {
                                        const value = e.target.value;
                                        const field = e.target.id;
                                        DataModule.updateCurrentQuote({ [field]: value });
                                        CalculationEngine.recalculateAll();
                                        KHQuoteSystem.UIModule.renderAll(); // 新增
                                    } catch (error) {
                                        console.error('更新费用失败:', error);
                                    }
                                });
                            }
                        });
                        
                        // 国家和邮编
                        const countryElement = document.getElementById('country');
                        if (countryElement) {
                            countryElement.addEventListener('change', (e) => {
                                try {
                                    DataModule.updateCurrentQuote({ country: e.target.value });
                                } catch (error) {
                                    console.error('更新国家失败:', error);
                                }
                            });
                        }
                        
                        const zipCodeElement = document.getElementById('zipCode');
                        if (zipCodeElement) {
                            zipCodeElement.addEventListener('change', (e) => {
                                try {
                                    DataModule.updateCurrentQuote({ zipCode: e.target.value });
                                } catch (error) {
                                    console.error('更新邮编失败:', error);
                                }
                            });
                        }
                        
                        // 省份选择按钮
                        document.querySelectorAll('[data-province]').forEach(button => {
                            button.addEventListener('click', (e) => {
                                try {
                                    const province = e.target.dataset.province;
                                    // 1. 更新界面样式（保持视觉反馈）
                                    document.getElementById('provinceSelect').value = '';
                                    document.querySelectorAll('[data-province]').forEach(btn => btn.classList.remove('active'));
                                    e.target.classList.add('active');
                                    // 2. 更新隐藏 input（唯一数据源）
                                    document.getElementById('provinceValue').value = province;
                                    // 3. 让 Controller 处理后续（收集表单、更新 DataModule、重算、渲染）
                                    KHQuoteSystem.QuoteController.handleFormChange();
                                } catch (error) {
                                    console.error('选择省份失败:', error);
                                }
                            });
                        });
                        
                        // 省份选择下拉框
                        const provinceSelectElement = document.getElementById('provinceSelect');
                        if (provinceSelectElement) {
                            provinceSelectElement.addEventListener('change', (e) => {
                                try {
                                    const province = e.target.value;
                                    if (province) {
                                        // 1. 更新界面样式
                                        document.querySelectorAll('[data-province]').forEach(btn => {
                                            btn.classList.remove('btn-primary', 'active');
                                            btn.classList.add('btn-secondary');
                                        });
                                        // 2. 更新隐藏 input
                                        document.getElementById('provinceValue').value = province;
                                        // 3. 让 Controller 处理后续
                                        KHQuoteSystem.QuoteController.handleFormChange();
                                    }
                                } catch (error) {
                                    console.error('选择省份失败:', error);
                                }
                            });
                        }
                        

                        
                        // 选择模板按钮
                        const selectTemplateBtn = document.getElementById('selectTemplateBtn');
                        if (selectTemplateBtn) {
                            selectTemplateBtn.addEventListener('click', () => {
                                UIModule.showModal('templateSelectModal');
                            });
                        }
                        
                        // 复制报价功能（基于模板）- 修复：复制时自动保存到历史记录
                        const copyQuoteBtn = document.getElementById('copyQuote');
                        if (copyQuoteBtn) {
                            copyQuoteBtn.addEventListener('click', async () => {
                                try {
                                    await window.QuoteController.copyQuote();
                                } catch (error) {
                                    console.error('复制报价失败:', error);
                                    NotificationModule.showError('复制报价失败');
                                }
                            });
                        }
                        
                        const loadLastQuoteBtn = document.getElementById('loadLastQuote');
                        if (loadLastQuoteBtn) {
                            loadLastQuoteBtn.addEventListener('click', () => {
                                try {
                                    const lastQuote = HistoryModule.getLatest();
                                    if (lastQuote) {
                                        UIModule.selectHistoryItem(lastQuote.id);
                                    } else {
                                        NotificationModule.showWarning('暂无历史报价记录');
                                    }
                                } catch (error) {
                                    console.error('加载上次报价失败:', error);
                                    NotificationModule.showError('加载上次报价失败');
                                }
                            });
                        }
                        
                        const resetCalculationBtn = document.getElementById('resetCalculation');
                        if (resetCalculationBtn) {
                            resetCalculationBtn.addEventListener('click', () => {
                                try {
                                    window.QuoteController.resetQuote();
                                } catch (error) {
                                    console.error('重置计算失败:', error);
                                    NotificationModule.showError('重置失败');
                                }
                            });
                        }
                        
                        // 系统设置按钮事件
                        const openSettingsBtn = document.getElementById('openSettings');
                        if (openSettingsBtn) {
                            openSettingsBtn.addEventListener('click', () => {
                                UIModule.showModal('settingsModal');
                            });
                        }
                        
                        const closeSettingsBtn = document.getElementById('closeSettings');
                        if (closeSettingsBtn) {
                            closeSettingsBtn.addEventListener('click', () => {
                                UIModule.hideModal('settingsModal');
                            });
                        }
                        
                        // 模板选择模态框关闭按钮
                        const closeTemplateSelectBtn = document.getElementById('closeTemplateSelect');
                        if (closeTemplateSelectBtn) {
                            closeTemplateSelectBtn.addEventListener('click', () => {
                                UIModule.hideModal('templateSelectModal');
                            });
                        }
                        
                        // 标签页切换
                        document.querySelectorAll('.tab').forEach(tab => {
                            tab.addEventListener('click', (e) => {
                                try {
                                    const tabId = e.target.dataset.tab;
                                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                                    e.target.classList.add('active');
                                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                                    document.getElementById(`${tabId}Tab`).classList.add('active');
                                } catch (error) {
                                    console.error('切换标签页失败:', error);
                                }
                            });
                        });
                        
                        // 编辑产品数据按钮
                        const editProductDataBtn = document.getElementById('editProductData');
                        if (editProductDataBtn) {
                            editProductDataBtn.addEventListener('click', () => {
                                try {
                                    const editor = document.getElementById('productDataEditor');
                                    if (editor.style.display === 'none') {
                                        editor.style.display = 'block';
                                        UIModule.updateProductDataTable();
                                    } else {
                                        editor.style.display = 'none';
                                    }
                                } catch (error) {
                                    console.error('显示产品编辑器失败:', error);
                                }
                            });
                        }
                        
                        // 保存产品数据
                        const saveProductDataBtn = document.getElementById('saveProductData');
                        if (saveProductDataBtn) {
                            saveProductDataBtn.addEventListener('click', () => {
                                try {
                                    const productType = document.getElementById('productType').value;
                                    const productName = document.getElementById('productName').value.trim();
                                    const productModel = document.getElementById('productModel').value.trim();
                                    const productPrice = document.getElementById('productPrice').value;
                                    const productPriceTier2 = document.getElementById('productPriceTier2').value;
                                    const productPriceTier3 = document.getElementById('productPriceTier3').value;
                                    const productId = document.getElementById('saveProductData').dataset.productId;
                                    
                                    if (!productName) {
                                        NotificationModule.showWarning('产品名称不能为空');
                                        return;
                                    }
                                    
                                    if (!productPrice || parseFloat(productPrice) <= 0) {
                                        NotificationModule.showWarning('产品价格必须大于0');
                                        return;
                                    }
                                    
                                    const productData = {
                                        name: productName,
                                        model: productModel,
                                        price: parseFloat(productPrice),
                                        priceTier2: parseFloat(productPriceTier2) || 0,
                                        priceTier3: parseFloat(productPriceTier3) || 0
                                    };
                                    
                                    let success = false;
                                    if (productId) {
                                        success = DataModule.updateProduct(productId, productData);
                                    } else {
                                        DataModule.addProduct(productType, productData);
                                        success = true;
                                    }
                                    
                                    if (success) {
                                        DataModule.saveToLocalStorage();
                                        UIModule.updateProductDataTable();
                                        UIModule.initProductOptions();
                                        // 重新初始化派生状态
                                        UIModule.initOtherAccessoriesDerivedState();
                                        UIModule.updateSettingsStats();
                                        UIModule.clearProductForm();
                                        NotificationModule.showSuccess(productId ? '产品已更新' : '产品已添加');
                                    } else {
                                        NotificationModule.showError('操作失败');
                                    }
                                } catch (error) {
                                    console.error('保存产品数据失败:', error);
                                    NotificationModule.showError('保存产品失败');
                                }
                            });
                        }
                        
                        // 删除产品数据
                        const deleteProductDataBtn = document.getElementById('deleteProductData');
                        if (deleteProductDataBtn) {
                            deleteProductDataBtn.addEventListener('click', () => {
                                try {
                                    const productId = document.getElementById('deleteProductData').dataset.productId;
                                    if (!productId) {
                                        NotificationModule.showWarning('请先选择要删除的产品');
                                        return;
                                    }
                                    
                                    if (confirm('确定要删除此产品吗？')) {
                                        const success = DataModule.deleteProduct(productId);
                                        if (success) {
                                            DataModule.saveToLocalStorage();
                                            UIModule.updateProductDataTable();
                                            UIModule.initProductOptions();
                                            // 重新初始化派生状态
                                            UIModule.initOtherAccessoriesDerivedState();
                                            UIModule.updateSettingsStats();
                                            UIModule.clearProductForm();
                                            NotificationModule.showSuccess('产品已删除');
                                        } else {
                                            NotificationModule.showError('删除产品失败');
                                        }
                                    }
                                } catch (error) {
                                    console.error('删除产品数据失败:', error);
                                    NotificationModule.showError('删除产品失败');
                                }
                            });
                        }
                        
                        // 清空产品表单
                        const clearProductFormBtn = document.getElementById('clearProductForm');
                        if (clearProductFormBtn) {
                            clearProductFormBtn.addEventListener('click', () => {
                                UIModule.clearProductForm();
                            });
                        }
                        
                        // 管理模板按钮
                        const manageTemplatesBtn = document.getElementById('manageTemplates');
                        if (manageTemplatesBtn) {
                            manageTemplatesBtn.addEventListener('click', () => {
                                try {
                                    const editor = document.getElementById('templateEditor');
                                    if (editor.style.display === 'none') {
                                        editor.style.display = 'block';
                                        UIModule.updateTemplateList();
                                    } else {
                                        editor.style.display = 'none';
                                    }
                                } catch (error) {
                                    console.error('显示模板编辑器失败:', error);
                                }
                            });
                        }
                        
                        // 保存模板
                        const saveTemplateBtn = document.getElementById('saveTemplate');
                        if (saveTemplateBtn) {
                            saveTemplateBtn.addEventListener('click', () => {
                                try {
                                    const templateName = document.getElementById('templateName').value.trim();
                                    const templateContent = document.getElementById('templateContent').value.trim();
                                    const templateId = document.getElementById('saveTemplate').dataset.templateId;
                                    
                                    if (!templateName) {
                                        NotificationModule.showWarning('模板名称不能为空');
                                        return;
                                    }
                                    
                                    if (!templateContent) {
                                        NotificationModule.showWarning('模板内容不能为空');
                                        return;
                                    }
                                    
                                    const templateData = { name: templateName, content: templateContent };
                                    let success = false;
                                    
                                    if (templateId) {
                                        success = DataModule.updateTemplate(templateId, templateData);
                                    } else {
                                        DataModule.addTemplate(templateData);
                                        success = true;
                                    }
                                    
                                    if (success) {
                                        DataModule.saveToLocalStorage();
                                        UIModule.updateTemplateList();
                                        UIModule.updateTemplateSelectList();
                                        UIModule.updateSettingsStats();
                                        UIModule.clearTemplateForm();
                                        NotificationModule.showSuccess(templateId ? '模板已更新' : '模板已添加');
                                    } else {
                                        NotificationModule.showError('操作失败');
                                    }
                                } catch (error) {
                                    console.error('保存模板失败:', error);
                                    NotificationModule.showError('保存模板失败');
                                }
                            });
                        }
                        
                        // 删除模板
                        const deleteTemplateBtn = document.getElementById('deleteTemplate');
                        if (deleteTemplateBtn) {
                            deleteTemplateBtn.addEventListener('click', () => {
                                const templateId = document.getElementById('deleteTemplate').dataset.templateId;
                                if (!templateId) {
                                    NotificationModule.showWarning('请先选择要删除的模板');
                                    return;
                                }
                                UIModule.deleteTemplate(templateId);
                            });
                        }
                        
                        // 清空模板表单
                        const clearTemplateFormBtn = document.getElementById('clearTemplateForm');
                        if (clearTemplateFormBtn) {
                            clearTemplateFormBtn.addEventListener('click', () => {
                                UIModule.clearTemplateForm();
                            });
                        }
                        
                        // 备份数据
                        const backupDataBtn = document.getElementById('backupData');
                        if (backupDataBtn) {
                            backupDataBtn.addEventListener('click', () => {
                                try {
                                    const dataStr = DataModule.backupData();
                                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                                    
                                    const link = document.createElement('a');
                                    link.href = URL.createObjectURL(dataBlob);
                                    link.download = `kh_laser_backup_${new Date().toISOString().split('T')[0]}.json`;
                                    link.click();
                                    
                                    UIModule.updateSettingsStats();
                                    NotificationModule.showSuccess('数据备份已下载');
                                } catch (error) {
                                    console.error('备份数据失败:', error);
                                    NotificationModule.showError('备份失败: ' + error.message);
                                }
                            });
                        }
                        
                        // 恢复数据
                        const restoreDataBtn = document.getElementById('restoreData');
                        if (restoreDataBtn) {
                            restoreDataBtn.addEventListener('click', () => {
                                try {
                                    document.getElementById('backupFileInput').click();
                                } catch (error) {
                                    console.error('打开文件选择器失败:', error);
                                }
                            });
                        }
                        
                        const backupFileInput = document.getElementById('backupFileInput');
                        if (backupFileInput) {
                            backupFileInput.addEventListener('change', (e) => {
                                try {
                                    if (e.target.files.length > 0) {
                                        const file = e.target.files[0];
                                        const reader = new FileReader();
                                        
                                        reader.onload = (event) => {
                                            try {
                                                const backupData = event.target.result;
                                                if (confirm('确定要恢复备份数据吗？这将覆盖当前所有数据。')) {
                                                    UIModule.showLoading();
                                                    const success = DataModule.restoreData(backupData);
                                                    UIModule.hideLoading();
                                                    
                                                    if (success) {
                                                        // 重新初始化UI
                                                        UIModule.initUI();
                                                        NotificationModule.showSuccess('数据恢复成功');
                                                    } else {
                                                        NotificationModule.showError('数据恢复失败，请检查备份文件格式');
                                                    }
                                                }
                                            } catch (error) {
                                                console.error('恢复数据失败:', error);
                                                UIModule.hideLoading();
                                                NotificationModule.showError('数据恢复失败: ' + error.message);
                                            }
                                        };
                                        
                                        reader.readAsText(file);
                                        e.target.value = '';
                                    }
                                } catch (error) {
                                    console.error('恢复数据失败:', error);
                                    NotificationModule.showError('恢复数据失败');
                                }
                            });
                        }
                        
                        // 新增：清除历史记录按钮
                        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
                        if (clearHistoryBtn) {
                            clearHistoryBtn.addEventListener('click', () => {
                                try {
                                    if (confirm('确定要清除所有历史报价记录吗？此操作不可撤销。')) {
                                        const success = HistoryModule.clearAll();
                                        if (success) {
                                            UIModule.updateHistoryDisplay();
                                            UIModule.updateSettingsStats();
                                            UIModule.selectedHistoryItemId = null;
                                            NotificationModule.showSuccess('历史记录已清除');
                                        } else {
                                            NotificationModule.showError('清除历史记录失败');
                                        }
                                    }
                                } catch (error) {
                                    console.error('清除历史记录失败:', error);
                                    NotificationModule.showError('清除历史记录失败');
                                }
                            });
                        }

                        // 恢复默认产品数据按钮
                        const resetToDefaultBtn = document.getElementById('resetToDefault');
                        if (resetToDefaultBtn) {
                            resetToDefaultBtn.addEventListener('click', () => {
                                try {
                                    if (confirm('确定要恢复默认产品数据吗？\n\n这将重置所有机器、水冷机和配件数据为系统内置版本。\n\n您的历史记录、模板和设置将保留。')) {
                                        UIModule.showLoading();
                                        
                                        // 保存当前的非产品数据
                                        const currentData = DataModule.getAllData();
                                        const savedTemplates = [...(currentData?.templates || [])];
                                        const savedHistory = [...(currentData?.quoteHistory || [])];
                                        const savedExchangeRate = currentData?.exchangeRate || 6.5;
                                        const savedLastBackupTime = currentData?.lastBackupTime;
                                        
                                        // 清除localStorage中的产品相关数据
                                        localStorage.removeItem('khLaserQuoteData');
                                        
                                        // 重新加载默认数据
                                        DataModule.loadDefaultData();
                                        
                                        // 恢复保存的非产品数据
                                        DataModule.data.templates = savedTemplates;
                                        DataModule.data.quoteHistory = savedHistory;
                                        DataModule.data.exchangeRate = savedExchangeRate;
                                        DataModule.data.lastBackupTime = savedLastBackupTime;
                                        
                                        // 保存到localStorage
                                        DataModule.saveToLocalStorage();
                                        
                                        // 重新初始化UI
                                        setTimeout(() => {
                                            UIModule.initUI();
                                            UIModule.hideLoading();
                                            NotificationModule.showSuccess('默认产品数据已恢复！', '您的模板、历史记录和设置已保留。');
                                        }, 500);
                                    }
                                } catch (error) {
                                    console.error('恢复默认数据失败:', error);
                                    UIModule.hideLoading();
                                    NotificationModule.showError('恢复默认数据失败: ' + error.message);
                                }
                            });
                        }
                        
                        // 点击模态框外部关闭
                        window.addEventListener('click', (e) => {
                            try {
                                const modals = document.querySelectorAll('.modal');
                                modals.forEach(modal => {
                                    if (e.target === modal) modal.style.display = 'none';
                                });
                            } catch (error) {
                                console.error('关闭模态框失败:', error);
                            }
                        });
                        
                        // 全局错误处理
                        window.addEventListener('error', (e) => {
                            console.error('未捕获的错误:', e.error);
                            NotificationModule.showError(`系统错误: ${e.message || '未知错误'}`);
                        });
                        
                        // Promise未捕获异常处理
                        window.addEventListener('unhandledrejection', (e) => {
                            console.error('未处理的Promise拒绝:', e.reason);
                            NotificationModule.showError(`异步操作失败: ${e.reason.message || '未知错误'}`);
                        });
                        
                    } catch (error) {
                        console.error('设置事件监听器失败:', error);
                        NotificationModule.showError('初始化失败，请刷新页面');
                    }
                }
            };
            
            // 初始化应用
            const init = function() {
                try {
                    UIModule.initUI();
                    EventModule.init();
                    
                    window.addEventListener('beforeunload', () => {
                        try {
                            DataModule.saveToLocalStorage();
                        } catch (error) {
                            console.error('保存数据失败:', error);
                        }
                    });
                    
                    // 初始化成功通知
                    setTimeout(() => {
                        NotificationModule.showSuccess('系统初始化完成', '欢迎使用KH Laser报价系统');
                    }, 500);
                    
                } catch (error) {
                    console.error('初始化应用失败:', error);
                    NotificationModule.showError('系统初始化失败，请刷新页面');
                }
            };
            
            return {
                init,
                UIModule,
                NotificationModule,
                DataModule,
                QuoteModule,
                HistoryModule,
                FormModule
            };
        })();

        // ==================== 新增：统一计算引擎模块 ====================
        const CalculationEngine = (function() {
            // 状态对象
            const AppState = {
                // 基础状态
                machinePrice: 0,
                accessoriesPrice: 0,
                waterChillerPrice: 0,
                otherPartsPrice: 0,
                domesticShipping: 0,
                internationalShipping: 0,
                otherFee: 0,
                quantity: 1,
                province: '',
                
                // 衍生状态（只读）
                subtotal: 0,
                finalTotalCNY: 0,
                finalTotalUSD: 0,
                
                // 更新方法
                update(updates) {
                    Object.assign(this, updates);
                    this.recalculate();
                },
                
                // 统一重新计算
                recalculate() {
                    try {
                        // 第一层：计算各项费用
                        this.subtotal = this.calculateSubtotal();
                        
                        // 第二层：计算最终总价
                        const finalTotals = this.calculateFinalTotal();
                        this.finalTotalCNY = finalTotals.cny;
                        this.finalTotalUSD = finalTotals.usd;
                        
                        // 第三层：触发UI更新
                        // this.triggerUIUpdate(); // 已移除，由 Controller 统一调用 renderAll
                        
                        return this.getState();
                    } catch (error) {
                        console.error('统一计算失败:', error);
                        return this.getState();
                    }
                },
                
                // 第一层：计算各项费用小计
                calculateSubtotal() {
                    return this.machinePrice +
                           this.waterChillerPrice +
                           this.accessoriesPrice +
                           this.otherPartsPrice +
                           this.domesticShipping +
                           this.internationalShipping +
                           this.otherFee;
                },
                
                // 第二层：计算最终总价（考虑数量）
                calculateFinalTotal() {
                    const subtotal = this.calculateSubtotal();
                    const totalCNY = subtotal * this.quantity;
                    
                    // 获取汇率
                    const exchangeRate = KHQuoteSystem.DataModule.getExchangeRate();
                    // 美元采用进一制
                    const totalUSD = Math.ceil(totalCNY / exchangeRate);
                    
                    return {
                        cny: totalCNY,
                        usd: totalUSD,
                        rawCNY: totalCNY,
                        rawUSD: totalUSD
                    };
                },
                
                // 获取完整状态
                getState() {
                    return {
                        machinePrice: this.machinePrice,
                        accessoriesPrice: this.accessoriesPrice,
                        waterChillerPrice: this.waterChillerPrice,
                        otherPartsPrice: this.otherPartsPrice,
                        domesticShipping: this.domesticShipping,
                        internationalShipping: this.internationalShipping,
                        otherFee: this.otherFee,
                        quantity: this.quantity,
                        province: this.province,
                        subtotal: this.subtotal,
                        finalTotalCNY: this.finalTotalCNY,
                        finalTotalUSD: this.finalTotalUSD
                    };
                },
                
                // 从DOM同步状态（备用方法）
                syncFromDOM() {
                    try {
                        const updates = {
                            quantity: parseInt(document.getElementById('quantity')?.value) || 1,
                            internationalShipping: parseFloat(document.getElementById('internationalShipping')?.value) || 0,
                            domesticShipping: parseFloat(document.getElementById('domesticShipping')?.value) || 0,
                            otherFee: parseFloat(document.getElementById('otherFees')?.value) || 0
                        };
                        
                        // 同步省份
                        const provinceBtn = document.querySelector('.province-btn.active');
                        const provinceSelect = document.getElementById('provinceSelect');
                        if (provinceBtn) {
                            updates.province = provinceBtn.dataset.province;
                        } else if (provinceSelect && provinceSelect.value) {
                            updates.province = provinceSelect.value;
                        }
                        
                        this.update(updates);
                    } catch (error) {
                        console.error('从DOM同步状态失败:', error);
                    }
                },
                
                // 从DataModule同步机器和产品价格
                syncFromDataModule() {
                    try {
                        const currentQuote = KHQuoteSystem.DataModule.getCurrentQuote();
                        const products = KHQuoteSystem.DataModule.getProducts();
                        const priceSource = currentQuote.priceSource || 'tier1';
                        
                        // 机器价格
                        if (currentQuote.selectedMachine) {
                            this.machinePrice = CalculationEngine.getPriceByTier(
                                currentQuote.selectedMachine, 
                                priceSource
                            );
                        }
                        
                        // 水冷机价格
                        if (currentQuote.selectedWaterCooler) {
                            const waterCooler = products.waterCoolers.find(wc => wc.id === currentQuote.selectedWaterCooler);
                            if (waterCooler) {
                                this.waterChillerPrice = CalculationEngine.getPriceByTier(waterCooler, priceSource);
                            }
                        }
                        
                        // 配件价格
                        this.accessoriesPrice = 0;
                        if (currentQuote.selectedAccessories && currentQuote.selectedAccessories.length > 0) {
                            currentQuote.selectedAccessories.forEach(accId => {
                                const accessory = products.accessories.find(acc => acc.id === accId);
                                if (accessory) {
                                    this.accessoriesPrice += CalculationEngine.getPriceByTier(accessory, priceSource);
                                }
                            });
                        }
                        
                        // 其他配件价格
                        this.otherPartsPrice = 0;
                        if (currentQuote.selectedOtherAccessories && currentQuote.selectedOtherAccessories.length > 0) {
                            currentQuote.selectedOtherAccessories.forEach(oaccId => {
                                const otherAccessory = products.otherAccessories.find(oacc => oacc.id === oaccId);
                                if (otherAccessory) {
                                    this.otherPartsPrice += CalculationEngine.getPriceByTier(otherAccessory, priceSource);
                                }
                            });
                        }
                        
                        this.recalculate();
                    } catch (error) {
                        console.error('从DataModule同步失败:', error);
                    }
                }
            };
            
            // 统一重新计算函数（外部调用入口）
            function recalculateAll() {
                // 1. 从DataModule同步基础数据
                AppState.syncFromDataModule();
                
                // 2. 从DOM同步用户输入
                AppState.syncFromDOM();
                
                // 3. 特殊处理：计算国内运费（如果省份和机器信息存在）
                if (AppState.province) {
                    const currentQuote = KHQuoteSystem.DataModule.getCurrentQuote();
                    if (currentQuote.selectedMachine && currentQuote.selectedMachine.cbm) {
                        const domesticShipping = CalculationEngine.calculateDomesticShipping(
                            currentQuote.selectedMachine.cbm,
                            AppState.province
                        );
                        AppState.update({ domesticShipping });
                        
                        // 更新DOM中的国内运费显示
                        const domesticShippingInput = document.getElementById('domesticShipping');
                        if (domesticShippingInput) {
                            domesticShippingInput.value = domesticShipping;
                        }
                        // 同步到DataModule，确保数据一致
                        KHQuoteSystem.DataModule.updateCurrentQuote({ domesticShipping });
                    }
                }
                
                // 4. 触发完整重新计算
                return AppState.recalculate();
            }
            
            return {
                AppState,
                recalculateAll,
                
                // 获取当前状态
                getState() {
                    return AppState.getState();
                },
                
                // 重置状态
                reset() {
                    AppState.update({
                        machinePrice: 0,
                        accessoriesPrice: 0,
                        waterChillerPrice: 0,
                        otherPartsPrice: 0,
                        domesticShipping: 0,
                        internationalShipping: 0,
                        otherFee: 0,
                        quantity: 1,
                        province: '',
                        subtotal: 0,
                        finalTotalCNY: 0,
                        finalTotalUSD: 0
                    });
                    
                    return AppState.getState();
                },
                
                // 新增方法（安全版）
                getUnitPriceById(type, id) {
                    const currentQuote = KHQuoteSystem.DataModule.getCurrentQuote();
                    const priceSource = currentQuote.priceSource || 'tier1';
                    const products = KHQuoteSystem.DataModule.getProducts();

                    let product = null;

                    if (type === 'machine') {
                        product = id;
                    }

                    if (type === 'waterCooler') {
                        product = products.waterCoolers.find(w => w.id === id);
                    }

                    if (type === 'accessory') {
                        product = products.accessories.find(a => a.id === id);
                    }

                    if (type === 'otherAccessory') {
                        product = products.otherAccessories.find(o => o.id === id);
                    }

                    if (!product) return 0;

                    return this.getPriceByTier(product, priceSource);
                },
                
                // 价格格式化工具
                formatPrice(price) {
                    try {
                        return new Intl.NumberFormat('zh-CN', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }).format(price);
                    } catch (error) {
                        console.error('格式化价格失败:', error);
                        return '0';
                    }
                },
                
                // 按等级获取价格
                getPriceByTier(product, priceSource) {
                    try {
                        if (!product) return 0;
                        switch (priceSource) {
                            case 'tier1': return product.price || 0;
                            case 'tier2': return product.priceTier2 || product.price || 0;
                            case 'tier3': return product.priceTier3 || product.price || 0;
                            default: return product.price || 0;
                        }
                    } catch (error) {
                        console.error('获取价格失败:', error);
                        return 0;
                    }
                },
                
                // 计算国内运费
                calculateDomesticShipping(cbm, province) {
                    try {
                        // 青岛的特殊规则
                        if (province === "青岛") {
                            if (cbm <= 5) {
                                return 500;
                            } else {
                                return Math.ceil(500 + (cbm - 5) * 110);
                            }
                        }
                        
                        // 其他省份的规则
                        const provinceRule = DOMESTIC_SHIPPING_RULES[province] || DOMESTIC_SHIPPING_RULES['其他'];
                        const firstWeightPrice = provinceRule.firstWeightPrice;
                        
                        // 找到对应的CBM区间单价
                        let unitPrice = 0;
                        let foundRange = false;
                        
                        for (const range of provinceRule.cbmRanges) {
                            // 处理 Infinity 的情况
                            if (range.max === Infinity) {
                                if (cbm >= range.min) {
                                    unitPrice = range.price;
                                    foundRange = true;
                                    break;
                                }
                            } else if (range.max) {
                                if (cbm >= range.min && cbm <= range.max) {
                                    unitPrice = range.price;
                                    foundRange = true;
                                    break;
                                }
                            } else {
                                if (cbm >= range.min) {
                                    unitPrice = range.price;
                                    foundRange = true;
                                    break;
                                }
                            }
                        }
                        
                        // 兜底逻辑：如果没有找到匹配的区间，使用最后一个区间的价格
                        if (!foundRange && provinceRule.cbmRanges.length > 0) {
                            const lastRange = provinceRule.cbmRanges[provinceRule.cbmRanges.length - 1];
                            unitPrice = lastRange.price;
                        }
                        
                        // 计算运费
                        const shippingFee = (firstWeightPrice + cbm * unitPrice) * 1.07;
                        // 进一制，返回整数
                        return Math.ceil(shippingFee);
                    } catch (error) {
                        console.error('计算国内运费失败:', error);
                        // 兜底逻辑：返回一个默认值
                        return Math.ceil(30 + cbm * 200 * 1.07);
                    }
                },
                
                // 价格输入校验
                validatePriceInputs(quoteData, exchangeRate) {
                    if (exchangeRate <= 0) {
                        throw new Error('汇率必须大于0');
                    }
                    if (exchangeRate > 100) {
                        throw new Error('汇率值异常，请检查');
                    }
                    const quantity = parseInt(quoteData.quantity) || 1;
                    if (quantity <= 0) {
                        throw new Error('数量必须大于0');
                    }
                    const shipping = parseFloat(quoteData.internationalShipping) || 0;
                    if (shipping < 0) {
                        throw new Error('运费不能为负数');
                    }
                },
                
                // 计算完整报价
                calculateFullQuote(quoteData, products, exchangeRate, priceSource) {
                    try {
                        // 输入校验
                        this.validatePriceInputs(quoteData, exchangeRate);

                        let totalCNY = 0;
                        let machinePrice = 0;
                        let waterCoolerPrice = 0;
                        let accessoriesPrice = 0;
                        let otherAccessoriesPrice = 0;
                        let shippingTotal = 0;
                        let otherFeesPrice = 0;

                        // 机器价格
                        if (quoteData.selectedMachine) {
                            machinePrice = this.getPriceByTier(quoteData.selectedMachine, priceSource);
                            totalCNY += machinePrice;
                        }

                        // 水冷机
                        if (quoteData.selectedWaterCooler) {
                            const waterCooler = products.waterCoolers.find(wc => wc.id === quoteData.selectedWaterCooler);
                            if (waterCooler) {
                                waterCoolerPrice = this.getPriceByTier(waterCooler, priceSource);
                                totalCNY += waterCoolerPrice;
                            }
                        }

                        // 配件
                        if (quoteData.selectedAccessories) {
                            quoteData.selectedAccessories.forEach(accId => {
                                const accessory = products.accessories.find(acc => acc.id === accId);
                                if (accessory) {
                                    const price = this.getPriceByTier(accessory, priceSource);
                                    accessoriesPrice += price;
                                    totalCNY += price;
                                }
                            });
                        }

                        // 其他配件
                        if (quoteData.selectedOtherAccessories) {
                            quoteData.selectedOtherAccessories.forEach(oaccId => {
                                const otherAccessory = products.otherAccessories.find(oacc => oacc.id === oaccId);
                                if (otherAccessory) {
                                    const price = this.getPriceByTier(otherAccessory, priceSource);
                                    otherAccessoriesPrice += price;
                                    totalCNY += price;
                                }
                            });
                        }

                        const internationalShipping = parseFloat(quoteData.internationalShipping) || 0;
                        const domesticShipping = parseFloat(quoteData.domesticShipping) || 0;
                        const otherFees = parseFloat(quoteData.otherFees) || 0;

                        shippingTotal = internationalShipping + domesticShipping;
                        otherFeesPrice = otherFees;

                        totalCNY += internationalShipping + domesticShipping + otherFees;
                        totalCNY *= (parseInt(quoteData.quantity) || 1);

                        const totalUSD = Math.ceil(totalCNY / exchangeRate);

                        return {
                            totalCNY: this.formatPrice(totalCNY),
                            totalUSD: this.formatPrice(totalUSD),
                            rawCNY: totalCNY,
                            rawUSD: totalUSD,
                            machinePrice: this.formatPrice(machinePrice),
                            waterCoolerPrice: this.formatPrice(waterCoolerPrice),
                            accessoriesPrice: this.formatPrice(accessoriesPrice),
                            otherAccessoriesPrice: this.formatPrice(otherAccessoriesPrice),
                            otherFeesPrice: this.formatPrice(otherFeesPrice),
                            shippingTotal: this.formatPrice(shippingTotal),
                            details: {
                                machinePrice,
                                waterCoolerPrice,
                                accessoriesPrice,
                                otherAccessoriesPrice,
                                otherFeesPrice,
                                shippingTotal
                            }
                        };
                    } catch (error) {
                        console.error('计算报价失败:', error);
                        // 使用 Utils 的默认结果（已修复）
                        return Utils.getDefaultPriceResult();
                    }
                },
                
                // 获取默认价格结果
                getDefaultPriceResult() {
                    return Utils.getDefaultPriceResult(); // 直接复用已修复的 Utils 方法
                }
            };
        })();

        // ==================== QuoteController ====================
        // 报价业务用例编排层，负责协调 DataModule、HistoryModule、CalculationEngine 等
        const QuoteController = {
            // ------------------------------------------------------
            // 私有工具方法（纯数据转换、延迟）
            // ------------------------------------------------------



            // 从历史记录恢复报价数据（纯数据转换，不操作 DOM）
            _restoreFromHistory(historyQuote) {
                return {
                    selectedSeries: historyQuote.selectedSeries || '',
                    selectedModel: historyQuote.selectedModel || '',
                    selectedPower: historyQuote.selectedPower || '',
                    selectedMachine: historyQuote.selectedMachine ?
                        KHQuoteSystem.DataModule.deepClone(historyQuote.selectedMachine) : null,
                    selectedWaterCooler: historyQuote.selectedWaterCooler || null,
                    selectedAccessories: [...(historyQuote.selectedAccessories || [])],
                    selectedOtherAccessories: [...(historyQuote.selectedOtherAccessories || [])],
                    internationalShipping: parseFloat(historyQuote.internationalShipping) || 0,
                    domesticShipping: parseFloat(historyQuote.domesticShipping) || 0,
                    otherFees: parseFloat(historyQuote.otherFees) || 0,
                    quantity: parseInt(historyQuote.quantity) || 1,
                    country: historyQuote.country || 'US',
                    zipCode: historyQuote.zipCode || '',
                    selectedProvince: historyQuote.selectedProvince || '',
                    priceSource: historyQuote.priceSource || 'tier1',
                    selectedTemplateId: historyQuote.selectedTemplateId || null
                };
            },



            // ------------------------------------------------------
            // 公共方法：加载历史报价并应用到表单
            // ------------------------------------------------------
            async loadHistoryQuote(quoteId) {
                const quote = KHQuoteSystem.HistoryModule.getById(quoteId);
                if (!quote) {
                    KHQuoteSystem.NotificationModule.showWarning('未找到该历史报价记录');
                    return false;
                }

                // 1. 重置表单（纯 DOM 重置）
                KHQuoteSystem.UIModule._resetFormDOM(); // 仍使用 UIModule 的 reset，或改用 FormModule.clearFormSelections

                // 2. 填充表单（不修改 DataModule）
                KHQuoteSystem.FormModule.populateForm(quote);

                // 3. 将历史数据转换为当前报价数据
                const restoredData = this._restoreFromHistory(quote);

                // 4. 应用到 DataModule（由 Controller 统一修改数据）
                KHQuoteSystem.DataModule.updateCurrentQuote(restoredData);

                // 5. 重新计算并刷新 UI
                KHQuoteSystem.CalculationEngine.recalculateAll();
                KHQuoteSystem.UIModule.renderAll();

                // 7. 设置模板（如果历史记录中有）
                if (quote.selectedTemplateId) {
                    KHQuoteSystem.DataModule.selectTemplate(quote.selectedTemplateId);
                    // KHQuoteSystem.UIModule.updateSelectedTemplateDisplay(); // 删除，renderAll 内部已调用
                }

                // 8. 更新历史记录选中状态
                KHQuoteSystem.UIModule.selectedHistoryItemId = quoteId;
                // KHQuoteSystem.UIModule.updateHistoryDisplay(); // 删除，renderAll 内部已调用

                KHQuoteSystem.NotificationModule.showSuccess('历史报价已加载到表单');
                return true;
            },

            // ------------------------------------------------------
            // 公共方法：重置报价
            // ------------------------------------------------------
            resetQuote() {
                // 1. 重置 DataModule 中的报价数据（清空选择）
                KHQuoteSystem.DataModule.updateCurrentQuote({
                    selectedSeries: '',
                    selectedModel: '',
                    selectedPower: '',
                    selectedMachine: null,
                    selectedWaterCooler: null,
                    selectedAccessories: [],
                    selectedOtherAccessories: [],
                    internationalShipping: 0,
                    domesticShipping: 0,
                    otherFees: 0,
                    quantity: 1,
                    country: 'US',
                    zipCode: '',
                    selectedProvince: '',
                    priceSource: 'tier1',
                    totalCNY: 0,
                    totalUSD: 0,
                    selectedTemplateId: null
                });

                // 2. 重置计算引擎状态
                KHQuoteSystem.CalculationEngine.reset();

                // 3. 重置表单 DOM
                KHQuoteSystem.UIModule.resetForm();

                // 4. 触发重新计算
                KHQuoteSystem.CalculationEngine.recalculateAll();
                KHQuoteSystem.UIModule.renderAll(); // 新增

                KHQuoteSystem.NotificationModule.showSuccess('已重置所有选项');
            },

            // ------------------------------------------------------
            // 公共方法：处理表单变更
            // ------------------------------------------------------
            handleFormChange() {
                // 从表单收集所有数据
                const formData = KHQuoteSystem.FormModule.collectFormData();
                // 更新 DataModule
                KHQuoteSystem.DataModule.updateCurrentQuote(formData);
                // 重新计算并刷新 UI
                KHQuoteSystem.CalculationEngine.recalculateAll();
                KHQuoteSystem.UIModule.renderAll();
            },

            // ------------------------------------------------------
            // 公共方法：复制报价
            // ------------------------------------------------------
            async copyQuote() {
                const selectedTemplate = KHQuoteSystem.DataModule.getSelectedTemplate();
                if (!selectedTemplate) {
                    KHQuoteSystem.NotificationModule.showWarning('请先选择报价模板');
                    return;
                }

                const currentQuote = KHQuoteSystem.DataModule.getCurrentQuote();
                const products = KHQuoteSystem.DataModule.getProducts();
                const exchangeRate = KHQuoteSystem.DataModule.getExchangeRate();
                const priceSource = currentQuote.priceSource;

                const calculated = KHQuoteSystem.CalculationEngine.calculateFullQuote(
                    currentQuote,
                    products,
                    exchangeRate,
                    priceSource
                );

                // 保存历史记录
                try {
                    const savedQuote = KHQuoteSystem.HistoryModule.saveCurrentQuote();
                    KHQuoteSystem.UIModule.updateSettingsStats();
                    KHQuoteSystem.UIModule.renderAll(); // 新增：刷新历史列表及其他 UI
                    if (DEBUG) console.log('报价已保存到历史记录:', savedQuote);
                } catch (saveError) {
                    console.error('保存报价到历史记录失败:', saveError);
                    KHQuoteSystem.NotificationModule.showWarning('报价保存失败，但复制操作继续');
                }

                // 生成模板内容
                const filledContent = KHQuoteSystem.QuoteModule.generateTemplateContent(
                    selectedTemplate,
                    currentQuote,
                    products,
                    calculated
                );

                // 复制到剪贴板
                try {
                    await navigator.clipboard.writeText(filledContent);
                    KHQuoteSystem.NotificationModule.showSuccess('报价单已复制到剪贴板并保存到历史记录');
                } catch {
                    const textArea = document.createElement('textarea');
                    textArea.value = filledContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    KHQuoteSystem.NotificationModule.showSuccess('报价单已复制到剪贴板并保存到历史记录');
                }
            }
        };

        // ==================== 将计算引擎和控制器挂载到 KHQuoteSystem 对象上 ====================
        // 直接赋值给局部变量 KHQuoteSystem
        KHQuoteSystem.CalculationEngine = CalculationEngine;
        KHQuoteSystem.QuoteController = QuoteController;

        // 同时暴露到全局（可选，供其他独立调用）
        window.CalculationEngine = CalculationEngine;
        window.QuoteController = QuoteController;
        window.KHQuoteSystem = KHQuoteSystem;  // 确保全局对象拥有最新属性

        if (DEBUG) console.log('统一计算引擎已加载，使用 CalculationEngine.recalculateAll() 进行统一计算');

        // 全局错误处理
        window.addEventListener('error', (event) => {
            console.error('全局错误:', event.error);
        });
        
        // DOM加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', KHQuoteSystem.init);
        } else {
            KHQuoteSystem.init();
        }
    </script>
</body>
</html>